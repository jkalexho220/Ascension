const int BOSS_SPELL_COOLDOWN = -1;

void bossCooldown(int minVal = 0, int maxVal = 0) {
	trQuestVarSet("bossSpell", BOSS_SPELL_COOLDOWN);
	trQuestVarSetFromRand("bossCooldownTime", minVal, maxVal, true);
	trQuestVarSet("bossCooldownTime", trTimeMS() + 1000 * trQuestVarGet("bossCooldownTime"));
	trQuestVarSet("bossOriginalCooldownTime", trQuestVarGet("bossCooldownTime"));
}

void processBossCooldown(int ultimate = 31) {
	float diff = trTimeMS() - trQuestVarGet("bossCooldownLastCheck");
	trQuestVarSet("bossCooldownLastCheck", trTimeMS());
	if (trQuestVarGet("bossUltimate") > 0) {
		trQuestVarSet("bossUsedUltimate", 1);
	}
	if (trTimeMS() > trQuestVarGet("bossCooldownTime")) {
		trQuestVarSet("bossSpell", 0);
		if (trQuestVarGet("bossUltimate") > 0) {
			trQuestVarSet("bossUltimate", trQuestVarGet("bossUltimate") - 1);
		}
	} else if (trUnitPercentDamaged() > 70 && trQuestVarGet("bossUsedUltimate") == 0) {// boss hasn't used ultimate yet
		trQuestVarSet("bossSpell", ultimate);
	} else if (trUnitPercentDamaged() > trQuestVarGet("bossDamaged")) {
		trQuestVarSet("bossDamaged", trQuestVarGet("bossDamaged") + 3);
		trQuestVarSet("bossCooldownTime", trQuestVarGet("bossCooldownTime") - 1000);
	} else if (trTimeMS() > trQuestVarGet("bossOriginalCooldownTime")) {
		diff = 0.0001 * diff * (trQuestVarGet("bossCooldownTime") - trQuestVarGet("bossOriginalCooldownTime"));
		trQuestVarSet("bossCooldownTime", trQuestVarGet("bossCooldownTime") - diff);
	}
}

int bossInts = 0;
int bossFloats = 0;

rule initialize_boss_db
active
highFrequency
{
	xsDisableSelf();
	bossInts = zNewArray(mInt, 5, "bossInts");
	bossFloats = zNewArray(mFloat, 5, "bossFloats");
}

int yeebShieldSFX = 0;

rule yeeb_boss_message
inactive
highFrequency
{
	bool found = false;
	if (trTime() > trQuestVarGet("yeebNext")) {
		trQuestVarSet("yeebStep", 1 + trQuestVarGet("yeebStep"));
		switch(1*trQuestVarGet("yeebStep"))
		{
			case 1:
			{
				trSetLighting("anatolia", 1.0);
				if (trQuestVarGet("p"+trCurrentPlayer()+"yeebHit") == 1) {
					trSoundPlayFN("","1",-1,"Yeebaagooon: Oh, " + trStringQuestVarGet("p"+trCurrentPlayer()+"name")+" you utter fool.",
						"icons\special e son of osiris icon 64");
				} else {
					trSoundPlayFN("","1",-1,
						"Yeebaagooon: Oh, " + trStringQuestVarGet("p"+1*trQuestVarGet("yeebBossFight")+"name")+" you utter fool.",
						"icons\special e son of osiris icon 64");
				}
				trQuestVarSet("yeebNext", trTime() + 6);
			}
			case 2:
			{
				trSoundPlayFN("","1",-1,"Yeebaagooon: Did you really think you could escape me by resigning before the bossfight?",
					"icons\special e son of osiris icon 64");
				trQuestVarSet("yeebNext", trTime() + 6);
			}
			case 3:
			{
				trSoundPlayFN("","1",-1,"Yeebaagooon: Foolish. I'll be taking back what's mine, no matter what.",
					"icons\special e son of osiris icon 64");
				trQuestVarSet("yeebNext", trTime() + 6);
			}
			case 4:
			{
				trArmyDispatch("1,0","Revealer",1,41,0,41,0,true);
				zSetProtoUnitStat("Revealer", 1, 2, 30);
				trArmySelect("1,0");
				trUnitConvert(0);
				
				trQuestVarSet("yeebaagooon", trGetNextUnitScenarioNameNumber());
				bossUnit = trQuestVarGet("yeebaagooon");
				trArmyDispatch("1,0","Dwarf",1,55,0,55,225,true);
				trUnitSelectClear();
				trUnitSelectByQV("yeebaagooon", true);
				trUnitConvert(ENEMY_PLAYER);
				trUnitChangeProtoUnit("Pharaoh of Osiris XP");
				
				spyEffect(1*trQuestVarGet("yeebaagooon"),
					kbGetProtoUnitID("Cinematic Block"), xsVectorSet(ARRAYS,bossInts,yeebShieldSFX));
				
				activateEnemy(bossUnit);
				xSetBool(dEnemies, xLaunched, true);
				bossPointer = xGetNewestPointer(dEnemies);
				
				trVectorQuestVarSet("bossRoomUpper", xsVectorSet(60,0,60));
				if (trQuestVarGet("mapType") == MAP_OPEN) {
					trVectorQuestVarSet("bossRoomLower", xsVectorSet(10, 0, 20));
				} else {
					trVectorQuestVarSet("bossRoomLower", xsVectorSet(20, 0, 10));
				}
				
				trQuestVarSet("yeebNextInvulnerabilityPhase", 30);
				
				xsEnableRule("yeebaagooon_battle");
				xsEnableRule("boss_stun_recovery");
				
				trOverlayText("Yeebaagooon",3.0,-1,-1,-1);
				
				trQuestVarSet("lightningBolts", trGetNextUnitScenarioNameNumber());
				
				bossCooldown(10, 12);
				
				xsEnableRule("gameplay_start");
				trUIFadeToColor(0,0,0,1000,0,false);
				trLetterBox(false);
				trQuestVarSet("yeebNext", trTime() + 3);
				xsEnableRule("boss_music");
				boss = 1;
				trVectorQuestVarSet("yeebPos", trVectorQuestVarGet("startPosition"));
			}
			case 5:
			{
				trMessageSetText("Yeebaagooon's spells will drain your favor if they hit you!", -1);
				xsDisableSelf();
				trQuestVarSet("yeebRelics", xInitDatabase("yeebRelics"));
				xInitAddInt(1*trQuestVarGet("yeebRelics"),"name");
				for(p=1; < ENEMY_PLAYER) {
					if (trQuestVarGet("p"+p+"yeebHit") == 1) {
						found = false;
						int relics = getRelicsDB(p);
						for(x=xGetDatabaseCount(relics); >0) {
							xDatabaseNext(relics);
							if (xGetInt(relics, xRelicType) == RELIC_YEEBAAGOOON) {
								found = true;
								xAddDatabaseBlock(1*trQuestVarGet("yeebRelics"), true);
								xSetInt(1*trQuestVarGet("yeebRelics"), xUnitName, xGetInt(relics, xUnitName));
								break;
							}
						}
						if (found == false) {
							if (trCurrentPlayer() == p) {
								trQuestVarSet("ownedRelics"+RELIC_YEEBAAGOOON, trQuestVarGet("ownedRelics"+RELIC_YEEBAAGOOON) - 1);
								trQuestVarSet("yeebRelicRetrieved", 1);
							}
						}
					}
				}
			}
		}
	}
}

rule boss_entrance_always
inactive
minInterval 2
{
	trUnitSelectClear();
	trUnitSelectByQV("bossEntranceStatue");
	if (trUnitIsSelected()) {
		startNPCDialog(NPC_BOSS_ENTRANCE);
		reselectMyself();
	}
	vector pos = kbGetBlockPosition(""+1*trQuestVarGet("bossKey"), true);
	if (unitDistanceToVector(1*trQuestVarGet("bossEntranceStatue"), pos) < 25) {
		trUnitSelectClear();
		trUnitSelectByQV("bossKey");
		trUnitChangeProtoUnit("Osiris Box Glow");
		trUnitSelectClear();
		trUnitSelectByQV("bossEntranceSymbol");
		trUnitChangeProtoUnit("Rocket");
		trSoundPlayFN("cinematics\15_in\gong.wav","1",-1,"","");
		trMessageSetText("The boss room entrance has opened!", -1);
		pos = kbGetBlockPosition(""+1*trQuestVarGet("bossEntranceStatue"));
		trArmyDispatch("1,0","Dwarf",1,xsVectorGetX(pos)-8,0,xsVectorGetZ(pos)-8,0,true);
		trArmySelect("1,0");
		trUnitChangeProtoUnit("Vortex Landing");
		trVectorQuestVarSet("bossRoomEntrance", pos - vector(8,0,8));
		xsDisableSelf();
	}
}

rule enter_boss_room
inactive
minInterval 2
{
	for(p=1; < ENEMY_PLAYER) {
		trUnitSelectClear();
		vector pos = trVectorQuestVarGet("bossRoomEntrance");
		if (unitDistanceToVector(xGetInt(dPlayerData, xPlayerUnit), pos) < trQuestVarGet("bossEntranceRadius")) {
			if (trQuestVarGet("p"+p+"enteredBossRoom") == 0) {
				trQuestVarSet("p"+p+"enteredBossRoom", 1);
				trQuestVarSet("playersInBossRoom", 1 + trQuestVarGet("playersInBossRoom"));
				trChatSend(0, "<color={Playercolor("+p+")}>{Playername("+p+")}</color> has entered the boss room!");
				trChatSend(0, "All players must be present to start the boss!");
			}
		} else if (trQuestVarGet("p"+p+"enteredBossRoom") == 1) {
			trQuestVarSet("p"+p+"enteredBossRoom", 0);
			trQuestVarSet("playersInBossRoom", trQuestVarGet("playersInBossRoom") - 1);
		}
	}
	
	if (trQuestVarGet("playersInBossRoom") == trQuestVarGet("activePlayerCount") - trQuestVarGet("deadPlayerCount") &&
		trQuestVarGet("playersInBossRoom") > 0) {
		xsDisableSelf();
		xsEnableRule("boss_cin_00");
		
		trUIFadeToColor(0,0,0,1000,0,true);
		trLetterBox(true);
	}
}


rule boss_music
minInterval 3
inactive
{
	if (boss > 0 && trTime() > trQuestVarGet("musicTime")) {
		if (boss == 11) {
			trMusicPlay("music\interface\if you can use a doorknob.mp3", "1",0.2);
			trQuestVarSet("musicTime", trTime() + 60);
		} else {
			trQuestVarSet("musicTime", trTime() + 50);
			trQuestVarSetFromRand("music", 1, 6, true);
			switch(1*trQuestVarGet("music"))
			{
				case 1:
				{
					trMusicPlay("music\fight\i wish i could throw shapes.mp3","1",3.0);
				}
				case 2:
				{
					trMusicPlay("music\fight\li'l drips.mp3","1",3.0);
				}
				case 3:
				{
					trMusicPlay("music\fight\meatier shower.mp3","1",3.0);
				}
				case 4:
				{
					trMusicPlay("music\fight\oi, that pops!!!.mp3","1",3.0);
				}
				case 5:
				{
					trMusicPlay("music\fight\rot loaf.mp3","1",3.0);
				}
				case 6:
				{
					trMusicPlay("music\fight\the fire brigade.mp3","1",3.0);
				}
			}
		}
	}
}

rule boss_cin_00
inactive
highFrequency
{
	if (trTime() > cActivationTime + 1) {
		xsDisableSelf();
		int id = 0;
		for(x=xGetDatabaseCount(dPlayerUnits); >0) {
			xDatabaseNext(dPlayerUnits);
			id = xGetInt(dPlayerUnits, xUnitID);
			trUnitSelectClear();
			trUnitSelectByID(id);
			if (trUnitAlive() == false) {
				removePlayerUnit();
			} else if (kbGetUnitBaseTypeID(id) == kbGetProtoUnitID("Villager Atlantean Hero")) {
				trMutateSelected(kbGetProtoUnitID("Cinematic Block"));
				removePlayerUnit();
			}
		}
		trQuestVarSet("deadPlayerCount", 0);
		trQuestVarSet("bossRelicCount", randomLow(2));
		trQuestVarSet("normalRelicCount", 3 - trQuestVarGet("bossRelicCount"));
		trQuestVarSet("gameOverStep", 0);
		/*
		painting walls to block off the entrance
		*/
		vector pos = xsVectorSet(trQuestVarGet("bossRoomSize"),0,trQuestVarGet("bossRoomSize"));
		pos = (trVectorQuestVarGet("bossRoomCenter") * 0.5) - pos;
		trPaintTerrain(xsVectorGetX(pos), xsVectorGetZ(pos) - 3,
			xsVectorGetX(pos) + 35, xsVectorGetZ(pos),
			TERRAIN_WALL, TERRAIN_SUB_WALL);
		trChangeTerrainHeight(xsVectorGetX(pos), xsVectorGetZ(pos) - 3,
			xsVectorGetX(pos) + 35, xsVectorGetZ(pos),wallHeight,false);
		trPaintTerrain(xsVectorGetX(pos)-4, xsVectorGetZ(pos),
			xsVectorGetX(pos), xsVectorGetZ(pos) + 35,
			TERRAIN_WALL, TERRAIN_SUB_WALL);
		trChangeTerrainHeight(xsVectorGetX(pos) - 3, xsVectorGetZ(pos),
			xsVectorGetX(pos), xsVectorGetZ(pos) + 35,wallHeight,false);
		
		trVectorQuestVarSet("bossRoomEntrance", pos);
		trPaintTerrain(0,0,5,5,0,70,true);
		trPaintTerrain(0,0,5,5,TERRAIN_WALL,TERRAIN_SUB_WALL,false);
		
		pos = trVectorQuestVarGet("bossRoomCenter");
		bossUnit = trGetNextUnitScenarioNameNumber();
		trArmyDispatch("0,0","Dwarf",1,
			xsVectorGetX(pos),0,xsVectorGetZ(pos),225,true);
		trArmySelect("0,0");
		trUnitChangeProtoUnit(trStringQuestVarGet("bossProto"));
		
		bossID = kbGetBlockID(""+1*bossUnit);
		
		trQuestVarSet("cinTime", trTime());
		trQuestVarSet("cinStep", 0);
		
		xsEnableRule("boss"+1*trQuestVarGet("stage")+"_init");
		
		boss = trQuestVarGet("stage");
		
		trQuestVarSet("bossRoomPlayersX", trQuestVarGet("bossRoomCenterX") - 12);
		trQuestVarSet("bossRoomPlayersZ", trQuestVarGet("bossRoomCenterZ") - 12);
		
		pos = pos - vector(12,0,12);
		int relics = 0;
		
		xClearDatabase(dPlayerCharacters);
		for(p=1; < ENEMY_PLAYER) {
			if (xGetBool(dPlayerData, xPlayerResigned, p) == false) {
				relics = getRelicsDB(p);
				for(x=xGetDatabaseCount(relics); >0) {
					xDatabaseNext(relics);
					xUnitSelect(relics, xUnitName);
					trUnitChangeProtoUnit("Relic");
				}
				trUnitSelectClear();
				trUnitSelect(""+xGetInt(dPlayerData, xPlayerUnit, p), true);
				trUnitDestroy();
				spawnPlayer(p, pos);
				equipRelicsAgain(p);
				trPlayerKillAllGodPowers(p);
				xSetInt(dPlayerData, xPlayerDead, 0);
				xSetBool(dPlayerData, xPlayerSilenced, true); // the un-silence will grant the right god powers
			}
		}
		
		for(x=xGetDatabaseCount(dEnemies); >0) {
			xDatabaseNext(dEnemies);
			xUnitSelectByID(dEnemies, xUnitID);
			if (trUnitAlive()) {
				trUnitDestroy();
			}
		}
		xClearDatabase(dEnemies);
		xClearDatabase(dEnemiesIncoming);
		
		activateEnemy(bossUnit, 0, 0);
		bossPointer = xGetNewestPointer(dEnemies);
		
		pos = trVectorQuestVarGet("bossRoomCenter");
		zSetProtoUnitStat("Revealer", 1, 2, 32);
		trArmyDispatch("1,0","Revealer",1,xsVectorGetX(pos),0,xsVectorGetZ(pos),225,true);
		trArmySelect("1,0");
		trUnitConvert(0);
		uiLookAtUnitByName(""+bossUnit);
		
		xClearDatabase(dFreeRelics);
		
		if (trQuestVarGet("stage") > 3) {
			xsEnableRule("boss_stun_recovery");
		}
	}
}

rule boss_stun_recovery
inactive
highFrequency
{
	if (trTime() > trQuestVarGet("bossStunRecoveryLast")) {
		trQuestVarSet("bossStunRecoveryLast", trTime());
		int pointer = xGetPointer(dEnemies);
		if (xSetPointer(dEnemies, bossPointer)) {
			if (xGetInt(dEnemies, xStunStatus) > 0) {
				xSetInt(dEnemies, xStunTimeout, xGetInt(dEnemies, xStunTimeout) - 500 * trQuestVarGet("stage"));
			}
			xSetPointer(dEnemies, pointer);
		}
	}
}

int dLionMeteors = 0;
int xLionMeteorYeehaw = 0;

int dLionShockwaves = 0;

int dLionShockwaveTargets = 0;

rule boss1_init
inactive
highFrequency
{
	if (trTime() > trQuestVarGet("cinTime")) {
		switch(1*trQuestVarGet("cinStep"))
		{
			case 0:
			{
				trOverlayText("The King of Beasts", 3.0, -1, -1, -1);
				trQuestVarSet("cinTime", trTime() + 2);
				
				dLionMeteors = xInitDatabase("lionMeteors");
				xInitAddInt(dLionMeteors, "name");
				xLionMeteorYeehaw = xInitAddInt(dLionMeteors, "yeehaw", 1);
				
				dLionShockwaves = initGenericProj("lionShockwaves",kbGetProtoUnitID("Heka Shockwave SFX"),2,15.0,4.0);
				
				dLionShockwaveTargets = xInitDatabase("lionShockwaveTargets");
				xInitAddInt(dLionShockwaveTargets, "name");
				xInitAddInt(dLionShockwaveTargets, "index");
			}
			case 1:
			{
				trLetterBox(false);
				trUIFadeToColor(0,0,0,1000,0,false);
				xsDisableSelf();
				trModifyProtounit("Tornado", ENEMY_PLAYER, 55, 1);
				trModifyProtounit("Tornado", ENEMY_PLAYER, 8, -99);
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trUnitConvert(ENEMY_PLAYER);
				trSetSelectedScale(bossScale, bossScale, bossScale);
				spyEffect(1*bossUnit, kbGetProtoUnitID("Cinematic Block"), xsVectorSet(ARRAYS,bossInts,0));
				xsEnableRule("boss1_battle");
				trQuestVarSet("bossSpell", 11);
				trModifyProtounit("Nemean Lion", ENEMY_PLAYER, 2, 60);
				trQuestVarSet("bossGem", STARSTONE);
				trQuestVarSetFromRand("bossGemCount", 2, 3, true);
				xsEnableRule("boss_music");
				trMessageSetText("Use the rocks to take cover from the lion's roar!", -1);
			}
		}
		trQuestVarSet("cinStep", 1 + trQuestVarGet("cinStep"));
	}
}


rule boss1_battle
inactive
highFrequency
{
	trUnitSelectClear();
	trUnitSelect(""+bossUnit, true);
	int p = 0;
	int x = 0;
	int action = 0;
	int id = 0;
	float angle = 0;
	bool hit = false;
	vector pos = vector(0,0,0);
	vector dir = vector(0,0,0);
	if (trUnitAlive() == true) {
		if (xGetDatabaseCount(dLionMeteors) > 0) {
			xDatabaseNext(dLionMeteors);
			if (xGetInt(dLionMeteors, xLionMeteorYeehaw) == 1) {
				xSetInt(dLionMeteors, xLionMeteorYeehaw, 0);
				xUnitSelect(dLionMeteors, xUnitName);
				trMutateSelected(kbGetProtoUnitID("Heka Shockwave SFX"));
				trUnitOverrideAnimation(2,0,true,false,-1);
			} else if (xGetInt(dLionMeteors, xLionMeteorYeehaw) == 2) {
				xUnitSelect(dLionMeteors, xUnitName);
				trUnitChangeProtoUnit("Rock Granite Big");
				xFreeDatabaseBlock(dLionMeteors);
			} else {
				pos = kbGetBlockPosition(""+xGetInt(dLionMeteors, xUnitName), true);
				if (xsVectorGetY(pos) <= worldHeight + 0.5) {
					xUnitSelect(dLionMeteors, xUnitName);
					trUnitChangeProtoUnit("Tartarian Gate Flame");
					xUnitSelect(dLionMeteors, xUnitName);
					trSetSelectedScale(0,0,0);
					trDamageUnitPercent(-100);
					xSetInt(dLionMeteors, xLionMeteorYeehaw, 2);
					for(x=xGetDatabaseCount(dPlayerUnits); >0) {
						xDatabaseNext(dPlayerUnits);
						xUnitSelectByID(dPlayerUnits, xUnitID);
						if (trUnitAlive() == false) {
							removePlayerUnit();
						} else if (unitDistanceToVector(xGetInt(dPlayerUnits, xUnitName), pos) < 9) {
							damagePlayerUnit(200);
						}
					}
					
					pos = vectorToGrid(pos);
					trPaintTerrain(xsVectorGetX(pos),xsVectorGetZ(pos),
						xsVectorGetX(pos),xsVectorGetZ(pos),
						TERRAIN_WALL, TERRAIN_SUB_WALL, false);
				}
			}
		}
		for(x=xsMin(4, xGetDatabaseCount(dLionShockwaves)); >0) {
			action = processGenericProj(dLionShockwaves);
			pos = kbGetBlockPosition(""+xGetInt(dLionShockwaves, xUnitName), true);
			hit = false;
			for(y=xGetDatabaseCount(dLionShockwaveTargets); >0) {
				xDatabaseNext(dLionShockwaveTargets);
				xUnitSelect(dLionShockwaveTargets, xUnitName);
				if (trUnitAlive() == false) {
					xFreeDatabaseBlock(dLionShockwaveTargets);
				} else if (unitDistanceToVector(xGetInt(dLionShockwaveTargets, xUnitName), pos) < 9) {
					hit = true;
					if (xSetPointer(dPlayerUnits, xGetInt(dLionShockwaveTargets, xDatabaseIndex))) {
						damagePlayerUnit(200);
					}
					if (trQuestVarGet("bossSpell") < 30 || trQuestVarGet("bossSpell") == BOSS_SPELL_COOLDOWN) {
						xFreeDatabaseBlock(dLionShockwaveTargets);
					}
				}
			}
			if (terrainIsType(vectorToGrid(pos), TERRAIN_WALL, TERRAIN_SUB_WALL) || hit) {
				xUnitSelect(dLionShockwaves, xUnitName);
				trUnitChangeProtoUnit("Dust Small");
				xFreeDatabaseBlock(dLionShockwaves);
			}
		}
		
		trUnitSelectClear();
		trUnitSelect(""+bossUnit, true);
		if (trQuestVarGet("bossSpell") == BOSS_SPELL_COOLDOWN) {
			processBossCooldown();
		} else if (trQuestVarGet("bossSpell") > 30) {
			if (trQuestVarGet("bossSpell") == 31) {
				trSoundPlayFN("cinematics\15_in\gong.wav","1",-1,"","");
				trSoundPlayFN("godpower.wav","1",-1,"","");
				trSetLighting("night", 1.0);
				trOverlayText("Roaring Gale", 3.0, -1, -1, -1);
				id = kbGetBlockID(""+aiPlanGetUserVariableInt(ARRAYS,bossInts,0));
				if (id == -1) {
					trQuestVarSet("noFake", 1);
					spyEffect(1*bossUnit,kbGetProtoUnitID("Cinematic Block"),xsVectorSet(ARRAYS,bossInts,0));
				} else {
					trQuestVarSet("noFake", 0);
					trSetSelectedScale(0,0,0);
					trMutateSelected(kbGetProtoUnitID("Nemean Lion"));
					trModifyProtounit("Nemean Lion", ENEMY_PLAYER, 24, 1);
					trModifyProtounit("Nemean Lion", ENEMY_PLAYER, 25, 1);
					trModifyProtounit("Nemean Lion", ENEMY_PLAYER, 26, 1);
					trModifyProtounit("Nemean Lion", ENEMY_PLAYER, 1, -6.0);
					trUnitSelectClear();
					trUnitSelect(""+aiPlanGetUserVariableInt(ARRAYS,bossInts,0));
					trUnitChangeProtoUnit("Tornado");
					trUnitConvert(ENEMY_PLAYER);
				}
				if (xSetPointer(dEnemies, bossPointer)) {
					removeEnemy();
				}
				trQuestVarSet("bossSpell", 32);
				trQuestVarSet("bossSpellTimeout", trTimeMS() + 12000);
				trQuestVarSet("bossSpellNext", trTimeMS() + 2000);
				xClearDatabase(dLionShockwaveTargets);
				for(x=xGetDatabaseCount(dPlayerUnits); >0) {
					xDatabaseNext(dPlayerUnits);
					xUnitSelectByID(dPlayerUnits, xUnitID);
					if (trUnitAlive() == false) {
						removePlayerUnit();
					} else {
						xAddDatabaseBlock(dLionShockwaveTargets, true);
						xSetInt(dLionShockwaveTargets, xUnitName, xGetInt(dPlayerUnits, xUnitName));
						xSetInt(dLionShockwaveTargets, xDatabaseIndex, xGetPointer(dPlayerUnits));
					}
				}
			} else if (trQuestVarGet("bossSpell") == 32) {
				if (trTimeMS() > trQuestVarGet("bossSpellNext")) {
					trQuestVarSet("bossSpellNext", trQuestVarGet("bossSpellNext") + 200);
					bossPos = kbGetBlockPosition(""+bossUnit, true);
					bossAngle = fModulo(6.283185, bossAngle + 2.41);
					dir = xsVectorSet(xsCos(bossAngle),0,xsSin(bossAngle));
					addGenericProj(dLionShockwaves,bossPos,dir);
					if (trTimeMS() > trQuestVarGet("bossSpellTimeout")) {
						bossCooldown(7, 20);
						trQuestVarSet("bossUltimate", 3);
						if (trQuestVarGet("noFake") == 0) {
							trUnitSelectClear();
							trUnitSelect(""+aiPlanGetUserVariableInt(ARRAYS,bossInts,0), true);
							trMutateSelected(kbGetProtoUnitID("Cinematic Block"));
							trModifyProtounit("Nemean Lion", ENEMY_PLAYER, 24, -1);
							trModifyProtounit("Nemean Lion", ENEMY_PLAYER, 25, -1);
							trModifyProtounit("Nemean Lion", ENEMY_PLAYER, 26, -1);
							trModifyProtounit("Nemean Lion", ENEMY_PLAYER, 1, 6.0);
						}
						trUnitSelectClear();
						trUnitSelect(""+bossUnit, true);
						trUnitChangeProtoUnit("Nemean Lion");
						trUnitSelectClear();
						trUnitSelect(""+bossUnit, true);
						trSetSelectedScale(bossScale,bossScale,bossScale);
						activateEnemy(bossUnit, 0, 0);
						trSetLighting("default", 1);
					}
				}
			}
		} else if (trQuestVarGet("bossSpell") > 20) {
			trQuestVarSetFromRand("rand", 1, 5, true);
			switch(1*trQuestVarGet("rand"))
			{
				case 1:
				{
					trChatSendSpoofed(ENEMY_PLAYER, "King of Beasts: Royal Guards!");
				}
				case 2:
				{
					trChatSendSpoofed(ENEMY_PLAYER, "King of Beasts: Attack!");
				}
			}
			trSoundPlayFN("wild.wav","1",-1,"","");
			trQuestVarSet("anglemod", 6.283185 / (1.0 + 2*ENEMY_PLAYER));
			trQuestVarSet("heading", fModulo(360, 57.295779 * angle - 180.0));
			trQuestVarSet("headingmod", 360.0 / (1.0 + 2*ENEMY_PLAYER));
			for(x=1+2*ENEMY_PLAYER; >0) {
				angle = fModulo(6.283185, angle + trQuestVarGet("anglemod"));
				trQuestVarSet("heading", fModulo(360.0, trQuestVarGet("heading") + trQuestVarGet("headingMod")));
				trVectorSetFromAngle("dir", angle);
				dir = xsVectorSet(xsSin(angle),0,xsCos(angle));
				pos = (dir * 24.0) + trVectorQuestVarGet("bossRoomCenter");
				action = trGetNextUnitScenarioNameNumber();
				trArmyDispatch(""+ENEMY_PLAYER+",0","Sphinx",1,
					xsVectorGetX(pos),0,xsVectorGetZ(pos),trQuestVarGet("heading"),true);
				activateEnemy(action, 0, 0);
			}
			bossCooldown(7, 20);
		} else if (trQuestVarGet("bossSpell") > 10) {
			if (trQuestVarGet("bossSpell") == 11) {
				trQuestVarSet("bossMeteorCount", 1 + trQuestVarGet("bossMeteorCount"));
				trQuestVarSetFromRand("rand", 1, 5, true);
				switch(1*trQuestVarGet("rand"))
				{
					case 1:
					{
						trChatSendSpoofed(ENEMY_PLAYER, "King of Beasts: Be crushed!");
					}
					case 2:
					{
						trChatSendSpoofed(ENEMY_PLAYER, "King of Beasts: Quake!");
					}
				}
				trSoundPlayFN("earthquakeexist.wav","1",-1,"","");
				trCameraShake(6.0, 0.25);
				trQuestVarSet("rainCount", 9);
				trQuestVarSet("rainNext", trTimeMS());
				trQuestVarSet("bossSpell", 12);
			} else if (trQuestVarGet("bossSpell") == 12) {
				if (trTimeMS() > trQuestVarGet("rainNext")) {
					trQuestVarSetFromRand("modX", -30, 30, true);
					trQuestVarSetFromRand("modZ", -30, 30, true);
					if (xsPow(trQuestVarGet("modX"), 2) + xsPow(trQuestVarGet("modZ"), 2) < 900) {
						action = trGetNextUnitScenarioNameNumber();
						pos = trVectorQuestVarGet("bossRoomCenter");
						trQuestVarSet("modX", trQuestVarGet("modX") + xsVectorGetX(pos));
						trQuestVarSet("modZ", trQuestVarGet("modZ") + xsVectorGetZ(pos));
						trQuestVarSetFromRand("heading", 1, 360, true);
						trArmyDispatch("1,0","Kronny Flying",1,trQuestVarGet("modX"),0,trQuestVarGet("modZ"),trQuestVarGet("heading"),true);
						trArmySelect("1,0");
						trUnitConvert(ENEMY_PLAYER);
						zSetProtoUnitStat("Kronny Flying", ENEMY_PLAYER, 1, 0.01);
						trDamageUnitPercent(100);
						trSetSelectedScale(0,5.0,0);
						xAddDatabaseBlock(dLionMeteors, true);
						xSetInt(dLionMeteors, xUnitName, action);
						trQuestVarSet("rainNext", 500 + trQuestVarGet("rainNext"));
						trQuestVarSet("rainCount", trQuestVarGet("rainCount") - 1);
						if (trQuestVarGet("rainCount") <= 0) {
							trQuestVarSet("bossSpell", 13);
						}
					}
				}
			} else if (trQuestVarGet("bossSpell") == 13) {
				if (xGetDatabaseCount(dLionMeteors) == 0) {
					bossCooldown(7, 20);
				}
			}
		} else if (trQuestVarGet("bossSpell") > 0) {
			if (trQuestVarGet("bossSpell") == 1) {
				bossAnim = true;
				trQuestVarSetFromRand("rand", 1, 4, true);
				switch(1*trQuestVarGet("rand"))
				{
					case 1:
					{
						trChatSendSpoofed(ENEMY_PLAYER, "King of Beasts: Kneel!");
					}
					case 2:
					{
						trChatSendSpoofed(ENEMY_PLAYER, "King of Beasts: Bow before me!");
					}
				}
				
				trMutateSelected(kbGetProtoUnitID("Nemean Lion"));
				trUnitOverrideAnimation(39,0,false,false,-1);
				trUnitSetStance("Passive");
				bossNext = trTimeMS() + 1500;
				trQuestVarSet("bossSpell", 2);
				bossPos = kbGetBlockPosition(""+bossUnit, true);
			} else if (trQuestVarGet("bossSpell") == 2) {
				if (trTimeMS() > bossNext) {
					bossNext = bossNext + 1500;
					trQuestVarSet("bossSpell", 3);
					dir = vector(1,0,0);
					for(x=24; >0) {
						addGenericProj(dLionShockwaves,bossPos,dir);
						dir = rotationMatrix(dir, 0.965926, 0.258819);
					}
					xClearDatabase(dLionShockwaveTargets);
					for(x=xGetDatabaseCount(dPlayerUnits); >0) {
						xDatabaseNext(dPlayerUnits);
						xUnitSelectByID(dPlayerUnits, xUnitID);
						if (trUnitAlive() == false) {
							removePlayerUnit();
						} else {
							xAddDatabaseBlock(dLionShockwaveTargets, true);
							xSetInt(dLionShockwaveTargets, xUnitName, xGetInt(dPlayerUnits, xUnitName));
							xSetInt(dLionShockwaveTargets, xDatabaseIndex, xGetPointer(dPlayerUnits));
						}
					}
				}
			} else if (trQuestVarGet("bossSpell") == 3) {
				if (trTimeMS() > bossNext) {
					bossAnim = false;
					trUnitChangeProtoUnit("Nemean Lion");
					trUnitSelectClear();
					trUnitSelect(""+bossUnit, true);
					trMutateSelected(kbGetProtoUnitID("Nemean Lion"));
					trSetSelectedScale(bossScale,bossScale,bossScale);
					bossCooldown(7, 20);
				}
			}
		} else if (xGetInt(dEnemies, xStunStatus, bossPointer) == 0) {
			trQuestVarSetFromRand("bossSpell", 0, xsMin(3, trUnitPercentDamaged() * 0.05), true);
			trQuestVarSet("bossSpell", trQuestVarGet("bossSpell") * 10 + 1);
			if (trQuestVarGet("bossSpell") == 11 && trQuestVarGet("bossMeteorCount") == 3) {
				trQuestVarSet("bossSpell", 1);
			}
			if (trQuestVarGet("bossSpell") == 31 && trQuestVarGet("bossUltimate") > 0) {
				trQuestVarSetFromRand("bossSpell", 0, 2, true);
				trQuestVarSet("bossSpell", 1 + 10 * trQuestVarGet("bossSpell"));
			}
		}
	} else {
		trUnitOverrideAnimation(-1,0,false,true,-1);
		xsDisableSelf();
		trMusicStop();
		boss = 0;
		trSetLighting("default", 1.0);
		trSoundPlayFN("win.wav","1",-1,"","");
		for(x=xGetDatabaseCount(dEnemies); >0) {
			xDatabaseNext(dEnemies);
			xUnitSelectByID(dEnemies, xUnitID);
			trDamageUnitPercent(100);
		}
		uiLookAtUnitByName(""+bossUnit);
		xsEnableRule("boss_ded");
		xsDisableRule("gameplay_always");
	}
}



int dTreeStabs = 0;
int xTreeStabDir = 0;
int xTreeStabStep = 0;
int xTreeStabNext = 0;
int xTreeStabSFX = 0;

rule boss2_init
inactive
highFrequency
{
	if (trTime() > trQuestVarGet("cinTime")) {
		switch(1*trQuestVarGet("cinStep"))
		{
			case 0:
			{
				trOverlayText("The Wraithwood", 3.0, -1, -1, -1);
				trQuestVarSet("cinTime", trTime() + 2);
				vector dir = vector(15,0,0);
				vector pos = vector(0,0,0);
				for(x=7; >0) {
					pos = trVectorQuestVarGet("bossRoomCenter") + dir;
					trArmyDispatch("1,0","Dwarf",1,xsVectorGetX(pos),0,xsVectorGetZ(pos),0,true);
					trArmySelect("1,0");
					trUnitConvert(0);
					trUnitChangeProtoUnit("Imperial Examination");
					dir = rotationMatrix(dir, 0.62349, 0.781831);
				}
				
				
				dTreeStabs = xInitDatabase("treeStabs");
				xInitAddInt(dTreeStabs, "name");
				xTreeStabDir = xInitAddVector(dTreeStabs, "dir");
				xTreeStabStep = xInitAddInt(dTreeStabs, "step");
				xTreeStabNext = xInitAddInt(dTreeStabs, "next");
				xTreeStabSFX = xInitAddInt(dTreeStabs, "sfx");
			}
			case 1:
			{
				trLetterBox(false);
				trUIFadeToColor(0,0,0,1000,0,false);
				xsDisableSelf();
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trUnitConvert(ENEMY_PLAYER);
				trUnitChangeProtoUnit("Spy Eye");
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trMutateSelected(kbGetProtoUnitID("Tamarisk Tree"));
				trSetSelectedScale(bossScale, bossScale, bossScale);
				xSetPointer(dEnemies, bossPointer);
				xFreeDatabaseBlock(dEnemies);
				trQuestVarSet("bossHealth", 100);
				trCounterAddTime("bosshealth",-1,-9999,"<color={Playercolor(2)}>Wraithwood: 100</color>", -1);
				
				trModifyProtounit("Shade XP", ENEMY_PLAYER, 0, 6391);
				trModifyProtounit("Shade XP", ENEMY_PLAYER, 27, 656);
				trModifyProtounit("Shade XP", ENEMY_PLAYER, 28, 566);
				trModifyProtounit("Shade XP", ENEMY_PLAYER, 29, 656);
				
				xsEnableRule("boss2_battle");
				trQuestVarSet("bossSpell", 41);
				trQuestVarSet("bossGem", SOULSTONE);
				trQuestVarSetFromRand("bossGemCount", 2, 3, true);
				xsEnableRule("boss_music");
				trMessageSetText("Defeat the spawned enemies to damage the Wraithwood!", -1);
				trStringQuestVarSet("advice",
					"The Wraithwood only summons new enemies once the old ones are gone. Make sure to kill the spawns!");
			}
		}
		trQuestVarSet("cinStep", 1 + trQuestVarGet("cinStep"));
	}
}

rule boss3_init
inactive
highFrequency
{
	if (trTime() > trQuestVarGet("cinTime")) {
		switch(1*trQuestVarGet("cinStep"))
		{
			case 0:
			{
				trOverlayText("King of Ice", 3.0, -1, -1, -1);
				trQuestVarSet("cinTime", trTime() + 2);
				//trRenderSnow(0.2);
			}
			case 1:
			{
				trLetterBox(false);
				trUIFadeToColor(0,0,0,1000,0,false);
				xsDisableSelf();
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trUnitConvert(ENEMY_PLAYER);
				trSetSelectedScale(bossScale, bossScale, bossScale);
				spyEffect(1*bossUnit, kbGetProtoUnitID("Cinematic Block"),xsVectorSet(ARRAYS,bossInts,0));
				spyEffect(1*bossUnit, kbGetProtoUnitID("Cinematic Block"),xsVectorSet(ARRAYS,bossInts,1));
				xsEnableRule("boss3_battle");
				trQuestVarSet("bossGem", MANASTONE);
				trQuestVarSetFromRand("bossGemCount", 2, 3, true);
				xsEnableRule("boss_music");
				
				bossCooldown(10, 15);
				
				trModifyProtounit("King Folstag", ENEMY_PLAYER, 27, 20);
				
				trStringQuestVarSet("advice",
					"If anything is stunned near an icicle, it will grow. Big icicles will turn into Frost Giants!");
			}
		}
		trQuestVarSet("cinStep", 1 + trQuestVarGet("cinStep"));
	}
}

rule boss6_init
inactive
highFrequency
{
	if (trTime() > trQuestVarGet("cinTime")) {
		vector pos = vector(0,0,0);
		switch(1*trQuestVarGet("cinStep"))
		{
			case 0:
			{
				if (trQuestVarGet("yeebBossFight") == 1) {
					xAddDatabaseBlock(1*trQuestVarGet("yeebRelics"), true);
					xSetInt(1*trQuestVarGet("yeebRelics"), xUnitName, 1*trQuestVarGet("yeebRelic"));
					trQuestVarSet("cinTime", trTime() + 6);
					trUnitSelectClear();
					trUnitSelectByQV("yeebRelic", true);
					for(p=1; < ENEMY_PLAYER) {
						if (trUnitIsOwnedBy(p)) {
							trSoundPlayFN("","1",-1,
								"Yeebaagooon:" + trStringQuestVarGet("p"+p+"name") + ". Did you really think I wouldn't notice you stealing my relic?",
								"icons\special e son of osiris icon 64");
							break;
						}
					}
					trQuestVarSet("cinStep", 1);
				} else {
					trOverlayText("The Exterminator", 3.0, -1, -1, -1);
					trQuestVarSet("cinTime", trTime() + 2);
					trUnitSelectClear();
					trUnitSelect(""+bossUnit, true);
					trUnitConvert(ENEMY_PLAYER);
					trSetSelectedScale(bossScale,bossScale,bossScale);
					spyEffect(1*bossUnit, kbGetProtoUnitID("Helepolis"), xsVectorSet(ARRAYS,bossInts,0));
					spyEffect(1*bossUnit, kbGetProtoUnitID("Barracks Atlantean"), xsVectorSet(ARRAYS,bossInts,1));
					xSetBool(dEnemies, xLaunched, true, bossPointer);
					
					trQuestVarSet("bossTurretObject", trGetNextUnitScenarioNameNumber());
					trArmyDispatch("1,0","Dwarf",1,1,0,1,0,true);
					trQuestVarSet("bossTurret", trGetNextUnitScenarioNameNumber());
					trArmyDispatch("1,0","Dwarf",1,1,0,1,0,true);
					
					trQuestVarSet("bossBarrelObject", trGetNextUnitScenarioNameNumber());
					trArmyDispatch("1,0","Dwarf",1,1,0,1,0,true);
					trQuestVarSet("bossBarrel", trGetNextUnitScenarioNameNumber());
					trArmyDispatch("1,0","Dwarf",1,1,0,1,0,true);
					
					trUnitSelectClear();
					trUnitSelectByQV("bossBarrel", true);
					trUnitConvert(ENEMY_PLAYER);
					trMutateSelected(kbGetProtoUnitID("Hero Greek Achilles"));
					trUnitSelectClear();
					trUnitSelectByQV("bossTurret", true);
					trUnitConvert(ENEMY_PLAYER);
					trMutateSelected(kbGetProtoUnitID("Hero Greek Achilles"));
					
					trUnitSelectClear();
					trUnitSelectByQV("bossTurretObject", true);
					trUnitConvert(ENEMY_PLAYER);
					trMutateSelected(kbGetProtoUnitID("Relic"));
					trImmediateUnitGarrison(""+1*trQuestVarGet("bossTurret"));
					trMutateSelected(kbGetProtoUnitID("Fire Siphon"));
					
					trUnitSelectClear();
					trUnitSelectByQV("bossBarrelObject", true);
					trUnitConvert(ENEMY_PLAYER);
					trMutateSelected(kbGetProtoUnitID("Relic"));
					trImmediateUnitGarrison(""+1*trQuestVarGet("bossBarrel"));
					trMutateSelected(kbGetProtoUnitID("Torch"));
					trUnitSetAnimationPath("1,0,0,0,0,0,0");
					trSetSelectedScale(1.5, 1.0, 1.5);
					
					
					trUnitSelectClear();
					trUnitSelectByQV("bossBarrel", true);
					trMutateSelected(kbGetProtoUnitID("Wadjet Spit"));
					trUnitSelectClear();
					trUnitSelectByQV("bossTurret", true);
					trMutateSelected(kbGetProtoUnitID("Wadjet Spit"));
					
					trQuestVarSet("volcano1", trGetNextUnitScenarioNameNumber());
					trQuestVarSet("volcano2", 1 + trQuestVarGet("volcano1"));
					pos = trVectorQuestVarGet("bossRoomCenter");
					trArmyDispatch("1,0","Dwarf",2,xsVectorGetX(pos),0,xsVectorGetZ(pos),0,true);
					trArmySelect("1,0");
					trUnitConvert(ENEMY_PLAYER);
					trUnitChangeProtoUnit("Cinematic Block");
				}
			}
			case 1:
			{
				bossCooldown(10, 15);
				trSetLighting("anatolia",0.1);
				xAddDatabaseBlock(dBallistas, true);
				xSetInt(dBallistas, xUnitName, bossUnit);
				xSetInt(dBallistas, xSpecialIndex, bossPointer);
				xSetInt(dBallistas, xPlayerOwner, ENEMY_PLAYER);
				trLetterBox(false);
				trUIFadeToColor(0,0,0,1000,0,false);
				xsDisableSelf();
				trUnitSelectClear();
				trUnitSelect(""+aiPlanGetUserVariableInt(ARRAYS,bossInts,0));
				trSetSelectedScale(1.2,0.25,2.0);
				trUnitSelectClear();
				trUnitSelect(""+aiPlanGetUserVariableInt(ARRAYS,bossInts,1));
				trSetSelectedScale(0.7,0.5,0.5);
				xsEnableRule("boss6_battle");
				trQuestVarSet("bossGem", MANASTONE);
				trQuestVarSetFromRand("bossGemCount", 3, 4, true);
				xsEnableRule("boss_music");
				
				trModifyProtounit("Helepolis", ENEMY_PLAYER, 27, 20);
			}
			case 2:
			{
				trQuestVarSet("cinTime", trTime() + 6);
				trSoundPlayFN("","1",-1,"Yeebaagooon: I'll be taking back what's mine now... along with your LIFE!",
					"icons\special e son of osiris icon 64");
				bossScale = 1;
				trQuestVarSet("yeebaagooon", bossUnit);
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trUnitChangeProtoUnit("Pharaoh of Osiris XP");
				xSetPointer(dEnemies, bossPointer);
				xSetBool(dEnemies, xLaunched, true);
				xSetFloat(dEnemies, xPhysicalResist, 0.47);
				xSetFloat(dEnemies, xMagicResist, 0.47);
				
				spyEffect(1*trQuestVarGet("yeebaagooon"),
					kbGetProtoUnitID("Cinematic Block"), xsVectorSet(ARRAYS,bossInts,yeebShieldSFX));
				
				pos = xsVectorSet(trQuestVarGet("bossRoomSize"),0,trQuestVarGet("bossRoomSize"));
				trVectorQuestVarSet("bossRoomUpper", trVectorQuestVarGet("bossRoomCenter") + pos);
				trVectorQuestVarSet("bossRoomLower", trVectorQuestVarGet("bossRoomCenter") - pos);
				
				trQuestVarSet("yeebNextInvulnerabilityPhase", 30);
				
				trVectorQuestVarSet("yeebPos", trVectorQuestVarGet("bossRoomCenter"));
				
				trOverlayText("Yeebaagooon",3.0,-1,-1,-1);
				
				trQuestVarSet("lightningBolts", trGetNextUnitScenarioNameNumber());
			}
			case 3:
			{
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trUnitConvert(ENEMY_PLAYER);
				xsEnableRule("yeebaagooon_battle");
				xsEnableRule("boss_stun_recovery");
				bossCooldown(10, 12);
				
				trUIFadeToColor(0,0,0,1000,0,false);
				trLetterBox(false);
				xsEnableRule("boss_music");
				trQuestVarSet("cinTime", trTime() + 3);
			}
			case 4:
			{
				trMessageSetText("Yeebaagooon's spells will drain your favor if they hit you.", -1);
				xsDisableSelf();
			}
		}
		trQuestVarSet("cinStep", 1 + trQuestVarGet("cinStep"));
	}
}


rule boss4_init
inactive
highFrequency
{
	if (trTime() > trQuestVarGet("cinTime")) {
		switch(1*trQuestVarGet("cinStep"))
		{
			case 0:
			{
				trOverlayText("Escaped Amalgam", 3.0, -1, -1, -1);
				trQuestVarSet("cinTime", trTime() + 2);
			}
			case 1:
			{
				trLetterBox(false);
				trUIFadeToColor(0,0,0,1000,0,false);
				xsDisableSelf();
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trUnitConvert(ENEMY_PLAYER);
				trSetSelectedScale(bossScale, bossScale, bossScale);
				xsEnableRule("boss4_battle");
				trQuestVarSet("bossGem", STARSTONE);
				trQuestVarSetFromRand("bossGemCount", 3, 4, true);
				xsEnableRule("boss_music");
				
				bossCooldown(10, 15);
				
				trModifyProtounit("Chimera", ENEMY_PLAYER, 27, 20);
				
				zSetProtoUnitStat("Meteorite", ENEMY_PLAYER, 1, 6);
				
				trStringQuestVarSet("advice", "Try bringing poison and silence resistance!");
			}
		}
		trQuestVarSet("cinStep", 1 + trQuestVarGet("cinStep"));
	}
}

rule boss5_init
inactive
highFrequency
{
	if (trTime() > trQuestVarGet("cinTime")) {
		switch(1*trQuestVarGet("cinStep"))
		{
			case 0:
			{
				trOverlayText("The Lonely Ghost", 3.0, -1, -1, -1);
				trQuestVarSet("cinTime", trTime() + 2);
			}
			case 1:
			{
				trQuestVarSet("bossChoke", 10);
				trLetterBox(false);
				trUIFadeToColor(0,0,0,1000,0,false);
				xsDisableSelf();
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trUnitConvert(ENEMY_PLAYER);
				trSetSelectedScale(bossScale, bossScale, bossScale);
				xsEnableRule("boss5_battle");
				trQuestVarSet("bossGem", SOULSTONE);
				trQuestVarSetFromRand("bossGemCount", 3, 4, true);
				xsEnableRule("boss_music");
				
				trQuestVarSet("bossWarn1", trGetNextUnitScenarioNameNumber());
				trQuestVarSet("bossWarn2", 1 + trQuestVarGet("bossWarn1"));
				trArmyDispatch("1,0","Dwarf",2,1,0,1,0,true);
				trArmySelect("1,0");
				trUnitConvert(ENEMY_PLAYER);
				trUnitChangeProtoUnit("Cinematic Block");
				
				trQuestVarSet("bossScreamStart", trGetNextUnitScenarioNameNumber());
				trArmyDispatch("1,0","Dwarf",7,1,0,1,0,true);
				trArmySelect("1,0");
				trUnitConvert(ENEMY_PLAYER);
				trUnitChangeProtoUnit("Cinematic Block");
				trQuestVarSet("bossScreamEnd", trGetNextUnitScenarioNameNumber());
				
				trQuestVarSet("bossEscape", trGetNextUnitScenarioNameNumber());
				trArmyDispatch("1,0","Dwarf",1,1,0,1,0,true);
				trArmySelect("1,0");
				trUnitConvert(ENEMY_PLAYER);
				trMutateSelected(kbGetProtoUnitID("Transport Ship Greek"));
				
				bossCooldown(10, 15);
				
				trModifyProtounit("Shade of Hades", ENEMY_PLAYER, 27, 20);
				trModifyProtounit("Shade of Hades", ENEMY_PLAYER, 55, 4);
				
				trStringQuestVarSet("advice", "Try bringing poison resistance!");
			}
		}
		trQuestVarSet("cinStep", 1 + trQuestVarGet("cinStep"));
	}
}

int bossJumpPath = 0;

rule boss7_init
inactive
highFrequency
{
	if (trTime() > trQuestVarGet("cinTime")) {
		switch(1*trQuestVarGet("cinStep"))
		{
			case 0:
			{
				xsDisableRule("the_deep_damage");
				trOverlayText("Mother of the Depths", 3.0, -1, -1, -1);
				trQuestVarSet("cinTime", trTime() + 2);
				xsDisableRule("deep_village_always");
				for(p=1; < ENEMY_PLAYER) {
					trUnitSelectClear();
					trUnitSelectByQV("p"+p+"medic");
					trUnitDestroy();
				}
			}
			case 1:
			{
				trLetterBox(false);
				trUIFadeToColor(0,0,0,1000,0,false);
				xsDisableSelf();
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trUnitConvert(ENEMY_PLAYER);
				trSetSelectedScale(bossScale, bossScale, bossScale);
				xsEnableRule("boss7_battle");
				trQuestVarSet("bossGem", SOULSTONE);
				trQuestVarSetFromRand("bossGemCount", 4, 5, true);
				xsEnableRule("boss_music");
				
				vector pos = trVectorQuestVarGet("bossRoomCenter");
				bossJumpPath = zNewArray(mInt, 50, "jumpPath");
				for(i=0; < 50) {
					aiPlanSetUserVariableInt(ARRAYS,bossJumpPath,i,trGetUnitScenarioNameNumber());
					trArmyDispatch(""+ENEMY_PLAYER+",0","Dwarf",1,
						xsVectorGetX(pos),0,xsVectorGetZ(pos),0,true);
					trArmySelect(""+ENEMY_PLAYER+",0");
					trMutateSelected(kbGetProtoUnitID("Rocket"));
				}
				
				trQuestVarSet("bossEscape", trGetNextUnitScenarioNameNumber());
				trArmyDispatch(""+ENEMY_PLAYER+",0","Dwarf",1,1,0,1,0,true);
				trArmySelect(""+ENEMY_PLAYER+",0");
				trUnitChangeProtoUnit("Transport Ship Greek");
				trArmySelect(""+ENEMY_PLAYER+",0");
				trSetSelectedScale(0,0,0);
				bossCooldown(10, 15);
				
				trModifyProtounit("Scylla", ENEMY_PLAYER, 27, 50);
				xSetBool(dEnemies, xLaunched, true, bossPointer);
				
				spyEffect(1*bossUnit,kbGetProtoUnitID("Cinematic Block"), xsVectorSet(ARRAYS,bossInts,0));
				
				trStringQuestVarSet("advice",
					"She will heal if she eats someone. You can poison her to prevent the healing.");
			}
		}
		trQuestVarSet("cinStep", 1 + trQuestVarGet("cinStep"));
	}
}

rule boss8_init
inactive
highFrequency
{
	if (trTime() > trQuestVarGet("cinTime")) {
		switch(1*trQuestVarGet("cinStep"))
		{
			case 0:
			{
				trOverlayText("Lord of the Heavens", 3.0, -1, -1, -1);
				trQuestVarSet("cinTime", trTime() + 2);
				xsDisableRule("the_cloud_damage");
				xsEnableRule("the_clouds_build_01");
			}
			case 1:
			{
				trModifyProtounit("Meteor", 0, 8, -12);
				trPaintTerrain(0,0,5,5,0,70,true);
				trPaintTerrain(0,0,5,5,TERRAIN_WALL,TERRAIN_SUB_WALL,false);
				TERRAIN_WALL = 4;
				TERRAIN_SUB_WALL = 15;
				bossDir = vector(0,0,-1);
				int db = trQuestVarGet("cloudTornados");
				for(i=0; < 10) {
					trUnitSelectClear();
					trUnitSelect(""+aiPlanGetUserVariableInt(ARRAYS,db,i),true);
					trUnitDestroy();
				}
				trLetterBox(false);
				trUIFadeToColor(0,0,0,1000,0,false);
				xsDisableSelf();
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trUnitConvert(ENEMY_PLAYER);
				trUnitSetStance("Passive");
				trSetSelectedScale(bossScale, bossScale, bossScale);
				xsEnableRule("boss8_battle");
				trQuestVarSet("bossGem", STARSTONE);
				trQuestVarSetFromRand("bossGemCount", 4, 5, true);
				xsEnableRule("boss_music");
				
				vector pos = trVectorQuestVarGet("bossRoomCenter");
				trQuestVarSet("bossStatue", trGetNextUnitScenarioNameNumber());
				trArmyDispatch("0,0","Dwarf",1,xsVectorGetX(pos)+1,0,xsVectorGetZ(pos)+1,225,true);
				trArmySelect("0,0");
				trUnitChangeProtoUnit("Statue of Lightning");
				trArmySelect("0,0");
				trUnitOverrideAnimation(2,0,true,false,-1);
				
				xSetPointer(dEnemies, bossPointer);
				xFreeDatabaseBlock(dEnemies);
				
				trVectorQuestVarSet("bossSmitePos", trVectorQuestVarGet("bossRoomCenter") + xsVectorSet(1, 6 + worldHeight, 1));
				
				
				trQuestVarSet("bossBreath1", trGetNextUnitScenarioNameNumber());
				trArmyDispatch("0,0","Dwarf",1,xsVectorGetX(pos),0,xsVectorGetZ(pos),0,true);
				trArmySelect("0,0");
				trSetSelectedScale(0,0,0);
				trMutateSelected(kbGetProtoUnitID("Meteorite"));
				trQuestVarSet("bossBreath2", trGetNextUnitScenarioNameNumber());
				trArmyDispatch("0,0","Dwarf",1,xsVectorGetX(pos),0,xsVectorGetZ(pos),0,true);
				trArmySelect("0,0");
				trSetSelectedScale(0,0,0);
				trMutateSelected(kbGetProtoUnitID("Meteorite"));
				
				trQuestVarSet("bossSmiteLaser", trGetNextUnitScenarioNameNumber());
				trArmyDispatch("0,0","Dwarf",1,xsVectorGetX(pos),0,xsVectorGetZ(pos),0,true);
				trArmySelect("0,0");
				trMutateSelected(kbGetProtoUnitID("Petosuchus Projectile"));
				trSetSelectedScale(0,0,0);
				pos = trVectorQuestVarGet("bossSmitePos");
				trUnitTeleport(xsVectorGetX(pos),xsVectorGetY(pos),xsVectorGetZ(pos));
				
				trMessageSetText("Bring Spark relics to the statue in the middle to damage the boss.", -1);
				
				trQuestVarSet("secondPhase", 1);
				
				trStringQuestVarSet("advice",
					"You need to bring Spark Relics to the statue in the middle in order to deal damage to him.");
			}
		}
		trQuestVarSet("cinStep", 1 + trQuestVarGet("cinStep"));
	}
}

void treeStab(vector pos = vector(0,0,0)) {
	vector dir = getUnitVector(trVectorQuestVarGet("bossRoomCenter"), pos);
	vector start = pos - (dir * 4.0);
	trUnitSelectClear();
	int next = trGetNextUnitScenarioNameNumber();
	trArmyDispatch("1,0","Dwarf",2,xsVectorGetX(start),0,xsVectorGetZ(start),0,true);
	trArmySelect("1,0");
	trUnitChangeProtoUnit("Cinematic Block");
	trUnitSelectClear();
	trUnitSelect(""+(1+next), true);
	trMutateSelected(kbGetProtoUnitID("Tartarian Gate Flame"));
	trUnitSetAnimationPath("0,1,1,0,0,0,0");
	trSetUnitOrientation(dir,vector(0,1,0),true);
	trSetSelectedScale(0.8,1.0,0.5);
	trQuestVarSet("treeStabSound",1);
	xAddDatabaseBlock(dTreeStabs, true);
	xSetInt(dTreeStabs, xUnitName, next);
	xSetVector(dTreeStabs, xTreeStabDir, dir);
	xSetInt(dTreeStabs, xTreeStabNext, trTimeMS() + 2000);
	xSetInt(dTreeStabs, xTreeStabSFX, next + 1);
}

rule boss2_battle
inactive
highFrequency
{
	trUnitSelectClear();
	trUnitSelect(""+bossUnit, true);
	int p = 0;
	int x = 0;
	int action = 0;
	int id = 0;
	float angle = 0;
	float dist = 0;
	bool hit = false;
	if (trQuestVarGet("bossHealth") > 0) {
		if (xGetDatabaseCount("bossRainingTrees") > 0) {
			action = processGenericProj("bossRainingTrees");
			if (action == PROJ_GROUND) {
				trUnitSelectClear();
				trUnitSelectByQV("bossRainingTrees");
				trUnitChangeProtoUnit("Walking Woods Marsh");
				trUnitSelectClear();
				trUnitSelectByQV("bossRainingTrees");
				trDamageUnitPercent(-100);
				activateEnemy("bossRainingTrees",-1,0);
				xFreeDatabaseBlock("bossRainingTrees");
			}
		}
		
		if (xGetDatabaseCount("bossHeals") > 0) {
			processGenericProj("bossHeals");
			trVectorSetUnitPos("pos", "bossHeals");
			if (zDistanceBetweenVectorsSquared("pos", "bossRoomCenter") < 12) {
				trUnitSelectClear();
				trUnitSelectByQV("bossHeals");
				trUnitChangeProtoUnit("Regeneration SFX");
				xFreeDatabaseBlock("bossHeals");
				trSoundPlayFN("recreation.wav","1",-1,"","");
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trQuestVarSet("bossHealth", xsMin(100, trQuestVarGet("bossHealth") + 5));
				trCounterAbort("bosshealth");
				trCounterAddTime("bosshealth",-1,-9999,
					"<color={Playercolor(2)}>Wraithwood: "+1*trQuestVarGet("bossHealth")+"</color>", -1);
				trUnitHighlight(0.2,false);
			} else {
				for(x=xGetDatabaseCount(dPlayerUnits); >0) {
					id = x
}

rule boss3_battle
inactive
highFrequency
{
	trUnitSelectClear();
	trUnitSelect(""+bossUnit, true);
	int p = 0;
	int x = 0;
	int action = 0;
	int id = 0;
	float amt = 0;
	float angle = 0;
	bool hit = false;
	if (trUnitAlive() == true) {
		for(x=xsMin(5, xGetDatabaseCount("bossBreath")); >0) {
			processGenericProj("bossBreath");
			trVectorSetUnitPos("pos","bossBreath");
			vectorToGrid("pos","loc");
			if (terrainIsType("loc", TERRAIN_WALL, TERRAIN_SUB_WALL)) {
				trUnitChangeProtoUnit("Curse SFX");
				xFreeDatabaseBlock("bossBreath");
			} else {
				action = 0;
				for(y=xGetDatabaseCount(dPlayerUnits); >0) {
					id = xDatabaseNext(dPlayerUnits, true);
					if (id == -1 || trUnitAlive() == false) {
						removePlayerUnit();
					} else if (zDistanceToVectorSquared(dPlayerUnits, "pos") < 3) {
						stunUnit(dPlayerUnits, 3.0);
						damagePlayerUnit(75);
						action = 1;
					}
				}
				if (action == 1) {
					trUnitSelectClear();
					trUnitSelectByQV("bossBreath", true);
					trUnitChangeProtoUnit("Curse SFX");
					xFreeDatabaseBlock("bossBreath");
				}
			}
		}
		
		trUnitSelectClear();
		trUnitSelect(""+bossUnit, true);
		if (trUnitPercentDamaged() > xGetDatabaseCount("frostGiantsIncoming")) {
			if (trTimeMS() > trQuestVarGet("bossSummonTime")) {
				trQuestVarSet("bossSummonTime", trTimeMS() + 1000 * xGetDatabaseCount("frostGiantsIncoming"));
				trQuestVarSetFromRand("xMod", 0 - 2*trQuestVarGet("bossRoomSize"), 2*trQuestVarGet("bossRoomSize"), true);
				trQuestVarSet("leftover", xsSqrt(xsPow(2*trQuestVarGet("bossRoomSize"),2) - xsPow(trQuestVarGet("xMod"), 2)));
				trQuestVarSetFromRand("zMod", 0 - trQuestVarGet("leftover"), trQuestVarGet("leftover"), true);
				trQuestVarSet("posX", trQuestVarGet("bossRoomCenterX") + trQuestVarGet("xMod"));
				trQuestVarSet("posZ", trQuestVarGet("bossRoomCenterZ") + trQuestVarGet("zMod"));
				trQuestVarSet("next", trGetNextUnitScenarioNameNumber());
				trQuestVarSetFromRand("heading", 1, 360, true);
				trArmyDispatch("1,0","Dwarf",1,trQuestVarGet("posX"),0,trQuestVarGet("posZ"),trQuestVarGet("heading"),true);
				trUnitSelectClear();
				trUnitSelectByQV("next");
				trUnitConvert(0);
				trMutateSelected(kbGetProtoUnitID("Ice Block"));
				yAddToDatabase("frostGiantsIncoming", "next");
				yAddUpdateVar("frostGiantsIncoming", "posX", trQuestVarGet("posX"));
				yAddUpdateVar("frostGiantsIncoming", "posZ", trQuestVarGet("posZ"));
				yAddUpdateVar("frostGiantsIncoming", "targetSize", 2);
				yAddUpdateVar("frostGiantsIncoming", "targetTime", trTimeMS() + 1000);
			}
		}
		for (x = xsMin(5,xGetDatabaseCount("frostGiantsIncoming")); > 0) {
			xDatabaseNext("frostGiantsIncoming", true);
			amt = yGetVar("frostGiantsIncoming", "targetTime") - trTimeMS();
			if (amt > 0) {
				amt = yGetVar("frostGiantsIncoming", "targetSize") - amt * 0.001;
				trSetSelectedScale(amt * 0.5, amt, amt * 0.5);
			} else if (yGetVar("frostGiantsIncoming", "targetSize") >= 5) {
				trUnitChangeProtoUnit("Frost Giant");
				trUnitSelectClear();
				trUnitSelectByQV("frostGiantsIncoming");
				trUnitConvert(ENEMY_PLAYER);
				activateEnemy("frostGiantsIncoming",0,0);
				yAddToDatabase("frostGiants", "frostGiantsIncoming");
				trSoundPlayFN("mythcreate.wav","1",-1,"","");
				xFreeDatabaseBlock("frostGiantsIncoming");
			} else {
				amt = yGetVar("frostGiantsIncoming", "targetSize");
				trSetSelectedScale(amt * 0.5, amt, amt * 0.5);
			}
		}
		
		trUnitSelectClear();
		trUnitSelect(""+bossUnit, true);
		
		if (trQuestVarGet("bossSpell") == BOSS_SPELL_COOLDOWN) {
			processBossCooldown();
		} else if (trQuestVarGet("bossSpell") > 30) {
			if (trQuestVarGet("bossSpell") == 31) {
				trSoundPlayFN("cinematics\15_in\gong.wav","1",-1,"","");
				trSoundPlayFN("godpower.wav","1",-1,"","");
				trOverlayText("Ice Age",3.0,-1,-1,-1);
				trSetLighting("night", 1.0);
				trQuestVarSet("bossSpell", 32);
				bossNext = trTimeMS() + 1500;
				bossTimeout = trTimeMS() + 15000;
				if (kbGetBlockID(""+1*trQuestVarGet("iceAgeSFX")) >= 0) {
					trUnitSelectClear();
					trUnitSelectByQV("iceAgeSFX");
					trUnitChangeProtoUnit("Ice Sheet");
				} else {
					spyEffect(1*bossUnit,kbGetProtoUnitID("Ice Sheet"),"iceAgeSFX");
				}
			} else if (trQuestVarGet("bossSpell") == 32) {
				if (trTimeMS() > bossNext) {
					trSoundPlayFN("pegasusflap.wav","1",-1,"","");
					bossNext = bossNext + 1500;
					trVectorSetUnitPos("pos", "bossUnit");
					for(x=xGetDatabaseCount(dPlayerCharacters); >0) {
						id = xDatabaseNext(dPlayerCharacters);
						if (id == -1 || trUnitAlive() == false) {
							removePlayerCharacter();
						} else {
							trVectorSetUnitPos("target", dPlayerCharacters);
							trVectorQuestVarSet("dir", zGetUnitVector("pos", "target"));
							addGenericProj("MedusaBalls","pos","dir",kbGetProtoUnitID("Lampades"),37,4,4.7);
							yAddUpdateVar("MedusaBalls", "target", trQuestVarGet(dPlayerCharacters));
							yAddUpdateVar("MedusaBalls", "bounces", 10);
							yAddUpdateVar("MedusaBalls","player",ENEMY_PLAYER);
						}
					}
					if (trTimeMS() > bossTimeout) {
						bossCooldown(12, 18);
						trQuestVarSet("bossUltimate", 3);
						trSetLighting("default",1.0);
						trUnitSelectClear();
						trUnitSelectByQV("iceAgeSFX");
						trUnitChangeProtoUnit("Cinematic Block");
					}
				}
			}
		} else if (trQuestVarGet("bossSpell") > 20) {
			if (trQuestVarGet("bossSpell") == 21) {
				trQuestVarSetFromRand("rand", 1, 3, true);
				if (trQuestVarGet("rand") == 1) {
					trChatSendSpoofed(ENEMY_PLAYER, "King of Ice: Now I'm angry!");
				} else if (trQuestVarGet("rand") == 2) {
					trChatSendSpoofed(ENEMY_PLAYER, "King of Ice: Meet my fist!");
				}
				trSoundPlayFN("titangrunt2.wav","1",-1,"","");
				trQuestVarSet("bossScale", 2);
				trSetSelectedScale(2, 2, 2);
				trQuestVarSet("bossSpell", 22);
				bossTimeout = trTimeMS() + 12000;
				trModifyProtounit("King Folstag", ENEMY_PLAYER, 27, 100);
			} else if (trQuestVarGet("bossSpell") == 22) {
				id = kbGetBlockID(""+1*bossUnit);
				if (trQuestVarGet("bossAttacking") == 0) {
					if (kbUnitGetAnimationActionType(id) == 6) {
						trQuestVarSet("bossAttacking", 1);
						bossNext = trTimeMS() + 1000;
					}
				} else if (kbUnitGetAnimationActionType(id) == 6) {
					if (trTimeMS() > bossNext) {
						xsSetContextPlayer(ENEMY_PLAYER);
						trVectorSetUnitPos("start", "bossUnit");
						bossNext = bossNext + 2000;
						trQuestVarSet("target", kbUnitGetTargetUnitID(id));
						for(x=xGetDatabaseCount(dPlayerUnits); >0) {
							if (1*trQuestVarGet("target") == xDatabaseNext(dPlayerUnits, true)) {
								if (trUnitAlive()) {
									trVectorSetUnitPos("end", dPlayerUnits);
									vectorSetAsTargetVector("dest","start","end",100.0);
									launchUnit(dPlayerUnits,"dest");
									growFrostGiantsIncoming("end");
								}
								break;
							}
						}
					}
				} else {
					trQuestVarSet("bossAttacking", 0);
				}
				if (trTimeMS() > bossTimeout) {
					trModifyProtounit("King Folstag", ENEMY_PLAYER, 27, -100);
					trSoundPlayFN("godpowerfailed.wav","1",-1,"","");
					trQuestVarSet("bossScale", 1.25);
					trUnitSelectClear();
					trUnitSelect(""+bossUnit, true);
					trSetSelectedScale(1.25,1.25,1.25);
					bossCooldown(6, 12);
				}
			}
		} else if (trQuestVarGet("bossSpell") > 10) {
			/* breath attack */
			if (trQuestVarGet("bossSpell") == 11) {
				trQuestVarSetFromRand("rand", 1, 3, true);
				if (trQuestVarGet("rand") == 1) {
					trChatSendSpoofed(ENEMY_PLAYER, "King of Ice: Feel the cold!");
				} else if (trQuestVarGet("rand") == 2) {
					trChatSendSpoofed(ENEMY_PLAYER, "King of Ice: Chill!");
				}
				trModifyProtounit("King Folstag", ENEMY_PLAYER, 55, 2);
				trSoundPlayFN("attackwarning.wav","1",-1,"","");
				for(x=xGetDatabaseCount(dPlayerCharacters); >0) {
					xDatabaseNext(dPlayerCharacters, true);
					if (id == -1 || trUnitAlive() == false) {
						removePlayerCharacter();
					} else {
						trVectorSetUnitPos("end", dPlayerCharacters);
						break;
					}
				}
				trVectorSetUnitPos("start", "bossUnit");
				vectorSnapToGrid("start");
				bossAngle = angleBetweenVectors("start", "end");
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trMutateSelected(kbGetProtoUnitID("King Folstag"));
				bossDir = zGetUnitVector("start", "end");
				trSetUnitOrientation(bossDir, vector(0,1,0), true);
				trUnitOverrideAnimation(3,1,false,false,-1);
				trQuestVarSet("bossSpell", 12);
				bossNext = trTimeMS() + 2000;
				trQuestVarSet("arm1", trGetNextUnitScenarioNameNumber());
				trQuestVarSet("arm2", trGetNextUnitScenarioNameNumber()+1);
				trArmyDispatch("1,0","Dwarf",2,trQuestVarGet("startx"),0,trQuestVarGet("startz"),0,true);
				trArmySelect("1,0");
				trMutateSelected(kbGetProtoUnitID("Petosuchus Projectile"));
				trSetUnitOrientation(xsVectorSet(0.0-trQuestVarGet("bossDirx"),0,0.0-trQuestVarGet("bossDirz")),vector(0,1,0),true);
				trSetSelectedScale(2,0,30);
				trUnitHighlight(2.0, false);
				bossAnim = true;
			} else if ((trQuestVarGet("bossSpell") == 12)) {
				amt = bossNext - trTimeMS();
				if (amt < 0) {
					trQuestVarSet("bossSpell", 13);
					bossNext = trTimeMS()+1;
					trUnitOverrideAnimation(-1,1,false,true,-1);
					trUnitSelectClear();
					trUnitSelectByQV("arm1");
					trUnitSelectByQV("arm2");
					trUnitDestroy();
				} else {
					/* 0.3 is max. amt is 0 - 2000. 0.3 at 0 and 0 at 2000 */
					angle = 0.00015 * (2000 - amt);
					amt = amt * 0.001;
					trUnitSelectClear();
					trUnitSelectByQV("arm1", true);
					trSetSelectedScale(amt, 0, 30);
					trVectorSetFromAngle("dir", fModulo(6.283185, bossAngle - angle - 3.141592));
					trSetUnitOrientation(trVectorQuestVarGet("dir"),vector(0,1,0),true);
					trUnitSelectClear();
					trUnitSelectByQV("arm2", true);
					trSetSelectedScale(amt, 0, 30);
					trVectorSetFromAngle("dir", fModulo(6.283185, bossAngle + angle - 3.141592));
					trSetUnitOrientation(trVectorQuestVarGet("dir"),vector(0,1,0),true);
				}
			} else if (trQuestVarGet("bossSpell") == 13) {
				if (trTimeMS() > bossNext) {
					trUnitOverrideAnimation(40,0,false,false,-1);
					bossPos = kbGetBlockPosition(""+bossUnit, true);
					trQuestVarSet("bossSpell", 14);
					bossTimeout = trTimeMS() + 2100;
					bossNext = trTimeMS() + 500;
				}
			} else if (trQuestVarGet("bossSpell") == 14) {
				if (trTimeMS() > bossNext) {
					bossNext = bossNext + 100;
					trQuestVarSetFromRand("newAngle", -0.3, 0.3, false);
					trQuestVarSet("newAngle", fModulo(6.283185, bossAngle + trQuestVarGet("newAngle")));
					trVectorSetFromAngle("dir", trQuestVarGet("newAngle"));
					addGenericProj("bossBreath","bossPos","dir",kbGetProtoUnitID("Curse SFX"),2,10.0,4.5);
					if (trTimeMS() > bossTimeout) {
						trModifyProtounit("King Folstag", ENEMY_PLAYER, 55, 1);
						trUnitSelectClear();
						trUnitSelect(""+bossUnit, true);
						trUnitOverrideAnimation(-1,1,false,true,-1);
						bossAnim = false;
						bossCooldown(5, 14);
					}
				}
			}
			if (trQuestVarGet("bossSpell") > 11) {
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trSetUnitOrientation(bossDir, vector(0,1,0), true);
			}
		} else if (trQuestVarGet("bossSpell") > 0) {
			trQuestVarSet("iceKingChange", trQuestVarGet("iceKingChange") - 1);
			if (trQuestVarGet("iceKingChange") <= 0) {
				trQuestVarSet("iceKingChange", 2);
				trQuestVarSet("iceKingArmor", 1 - trQuestVarGet("iceKingArmor"));
				if (trQuestVarGet("iceKingArmor") == 0) {
					trSoundPlayFN("icemono.wav","1",-1,"","");
					trSoundPlayFN("bronzebirth.wav","1",-1,"","");
					trModifyProtounit("King Folstag", ENEMY_PLAYER, 24, 1);
					trModifyProtounit("King Folstag", ENEMY_PLAYER, 25, 1);
					trModifyProtounit("King Folstag", ENEMY_PLAYER, 26, 1);
					ySetVarAtIndex(dEnemies, "physicalResist", 1, bossPointer);
					ySetVarAtIndex(dEnemies, "magicResist", 0, bossPointer);
					trQuestVarSetFromRand("rand", 1, 3, true);
					if (trQuestVarGet("rand") == 1) {
						trChatSendSpoofed(ENEMY_PLAYER, "King of Ice: Your blades won't reach me!");
					} else if (trQuestVarGet("rand") == 2) {
						trChatSendSpoofed(ENEMY_PLAYER, "King of Ice: Ice Armor!");
					}
					if (trQuestVarGet("bossExplain") < 2) {
						trMessageSetText("The King of Ice is now resistant to attacks but vulnerable to spells.",-1);
						trQuestVarSet("bossExplain", 1 + trQuestVarGet("bossExplain"));
					}
					trUnitSelectClear();
					trUnitSelectByQV("auroraSFX");
					trMutateSelected(kbGetProtoUnitID("Ice Block"));
					trUnitSetAnimationPath("0,0,0,0,0,0,0");
					trSetSelectedScale(5,7,5);
				} else {
					trSoundPlayFN("sphinxteleportin.wav","1",-1,"","");
					trSoundPlayFN("godpower.wav","1",-1,"","");
					trModifyProtounit("King Folstag", ENEMY_PLAYER, 24, -1);
					trModifyProtounit("King Folstag", ENEMY_PLAYER, 25, -1);
					trModifyProtounit("King Folstag", ENEMY_PLAYER, 26, -1);
					ySetVarAtIndex(dEnemies, "physicalResist", 0, bossPointer);
					ySetVarAtIndex(dEnemies, "magicResist", 1, bossPointer);
					trQuestVarSetFromRand("rand", 1, 3, true);
					if (trQuestVarGet("rand") == 1) {
						trChatSendSpoofed(ENEMY_PLAYER, "King of Ice: Your magic is meaningless!");
					} else if (trQuestVarGet("rand") == 2) {
						trChatSendSpoofed(ENEMY_PLAYER, "King of Ice: Aurora Armor!");
					}
					if (trQuestVarGet("bossExplain") < 2) {
						trMessageSetText("The King of Ice is now resistant to spells but vulnerable to attacks.",-1);
						trQuestVarSet("bossExplain", 1 + trQuestVarGet("bossExplain"));
					}
					if (kbGetBlockID(""+1*trQuestVarGet("auroraSFX")) >= 0) {
						trUnitSelectClear();
						trUnitSelectByQV("auroraSFX");
						trMutateSelected(kbGetProtoUnitID("Vortex Finish Linked"));
					} else {
						spyEffect(1*bossUnit, kbGetProtoUnitID("Cinematic Block"), "auroraSFX");
					}
				}
				bossCooldown(5, 10);
			} else {
				trQuestVarSet("bossSpell", 11);
			}
		} else if (xGetInt(dEnemies, xStunStatus, bossPointer) == 0) {
			trQuestVarSetFromRand("bossSpell", 0, xsMin(3, trUnitPercentDamaged() * 0.05), true);
			trQuestVarSet("bossSpell", trQuestVarGet("bossSpell") * 10 + 1);
			if (trQuestVarGet("bossSpell") == 31 && trQuestVarGet("bossUltimate") > 0) {
				trQuestVarSetFromRand("bossSpell", 0, 2, true);
				trQuestVarSet("bossSpell", 1 + 10 * trQuestVarGet("bossSpell"));
			}
		}
		
		if (trQuestVarGet("frostGiantIncomingSound") == 1) {
			trQuestVarSet("frostGiantIncomingSound", 0);
			trSoundPlayFN("icemono.wav","1",-1,"","");
		}
	} else {
		trUnitOverrideAnimation(-1,0,false,true,-1);
		xsDisableSelf();
		trMusicStop();
		boss = 0;
		trSetLighting("default", 1.0);
		trSoundPlayFN("win.wav","1",-1,"","");
		for(x=xGetDatabaseCount(dEnemies); >0) {
			xDatabaseNext(dEnemies, true);
			trDamageUnitPercent(100);
		}
		uiLookAtUnitByName(""+bossUnit);
		xsEnableRule("boss_ded");
		xsDisableRule("gameplay_always");
	}
}


rule boss6_battle
inactive
highFrequency
{
	trUnitSelectClear();
	trUnitSelect(""+bossUnit, true);
	int p = 0;
	int x = 0;
	int action = 0;
	int id = 0;
	float amt = 0;
	float angle = 0;
	bool hit = false;
	if (trUnitAlive() == true) {
		if (xGetDatabaseCount("bossLasers") > 0) {
			xDatabaseNext("bossLasers");
			if (trTimeMS() > yGetVar("bossLasers", "next")) {
				switch(1*yGetVar("bossLasers", "step"))
				{
					case 1:
					{
						ySetVar("bossLasers", "step", 2);
						for(x=0; < 4) {
							trUnitSelectClear();
							trUnitSelect(""+(x+trQuestVarGet("bossLasers")), true);
							trSetSelectedScale(6,6,60);
							trUnitHighlight(3, false);
						}
						yVarToVector("bossLasers", "pos");
						for(x=xGetDatabaseCount(dPlayerUnits); >0) {
							if (xDatabaseNext(dPlayerUnits, true) == -1 || trUnitAlive() == false) {
								removePlayerUnit();
							} else {
								trVectorSetUnitPos("end", dPlayerUnits);
								if (xsAbs(trQuestVarGet("endx") - trQuestVarGet("posx")) < 1.0 ||
									xsAbs(trQuestVarGet("endz") - trQuestVarGet("posz")) < 1.0) {
									damagePlayerUnit(300);
								}
							}
						}
						trSoundPlayFN("sky passage.wav","1",-1,"","");
						trSoundPlayFN("phoenixattack.wav","1",-1,"","");
					}
					case 2:
					{
						amt = 500 - trTimeMS() + yGetVar("bossLasers", "next");
						if (amt > 0) {
							amt = amt * 0.012;
							for(x=0; < 4) {
								trUnitSelectClear();
								trUnitSelect(""+(x+trQuestVarGet("bossLasers")), true);
								trSetSelectedScale(amt,amt,60);
							}
						} else {
							for(x=0; < 4) {
								trUnitSelectClear();
								trUnitSelect(""+(x+trQuestVarGet("bossLasers")), true);
								trUnitDestroy();
							}
							xFreeDatabaseBlock("bossLasers");
						}
					}
				}
			}
		}
		if (xGetDatabaseCount("deployRobots") > 0) {
			if (processGenericProj("deployRobots") == PROJ_GROUND) {
				trDamageUnitPercent(-100);
				trUnitChangeProtoUnit(trStringQuestVarGet("enemyProto"+1*trQuestVarGet("bossSummonProto")));
				trUnitSelectClear();
				trUnitSelectByQV("deployRobots", true);
				trDamageUnitPercent(-100);
				trVectorSetUnitPos("pos", "deployRobots");
				vectorToGrid("pos", "loc");
				if (terrainIsType("loc", TERRAIN_WALL, TERRAIN_SUB_WALL)) {
					trUnitChangeProtoUnit("Dust Large");
				} else {
					activateEnemy("deployRobots",-1,0);
				}
				xFreeDatabaseBlock("deployRobots");
			}
		}
		trUnitSelectClear();
		trUnitSelect(""+bossUnit, true);
		if (trQuestVarGet("bossSpell") == BOSS_SPELL_COOLDOWN) {
			processBossCooldown();
		} else if (trQuestVarGet("bossSpell") > 30) {
			if (trQuestVarGet("bossSpell") == 31) {
				trStringQuestVarSet("advice", "Having trouble dodging the Extinction Cannon? Try equipping speed relics!");
				trSetLighting("night", 1.0);
				trSoundPlayFN("cinematics\15_in\gong.wav","1",-1,"","");
				trSoundPlayFN("godpower.wav","1",-1,"","");
				trOverlayText("Extinction Cannon",3.0,-1,-1,-1);
				trQuestVarSet("bossStunIndex", yAddToDatabase("stunnedUnits", "bossUnit"));
				yAddUpdateVar("stunnedUnits", "proto", kbGetProtoUnitID("Helepolis"));
				trQuestVarSet("bossSpell", 32);
				bossCount = 10;
				bossPos = kbGetBlockPosition(""+bossUnit, true);
				trVectorSetFromAngle("bossDir", bossAngle);
				
				trUnitSelectClear();
				trUnitSelectByQV("bossTurret", true);
				trUnitSetStance("Aggressive");
				trUnitTeleport(trQuestVarGet("bossPosx"),worldHeight+2.0,trQuestVarGet("bossPosz"));
				trSetUnitOrientation(bossDir,vector(0,1,0),true);
				trUnitSelectClear();
				trUnitSelectByQV("bossBarrel", true);
				trUnitSetStance("Aggressive");
				trUnitTeleport(trQuestVarGet("bossPosx"),worldHeight+3.5,trQuestVarGet("bossPosz"));
				trSetUnitOrientation(vector(0,1,0),bossDir,true);
			} else if (trQuestVarGet("bossSpell") == 32) {
				trVectorSetUnitPos("pos", "bossTurret");
				if (zDistanceBetweenVectorsSquared("pos", "bossPos") < 1.0) {
					trQuestVarSet("bossSpell", 33);
					trUnitSelectClear();
					trUnitSelectByQV("bossTurret", true);
					trUnitSetStance("Passive");
					trUnitSelectClear();
					trUnitSelectByQV("bossBarrel", true);
					trUnitSetStance("Passive");
				}
			} else if (trQuestVarGet("bossSpell") == 33) {
				trUnitSelectClear();
				trUnitSelectByQV("bossBarrelObject", true);
				if (trTimeMS() > bossNext) {
					if (bossCount > 0) {
						trSetSelectedScale(1.5,1.0,1.5);
						trVectorSetFromAngle("bossDir", bossAngle);
						trQuestVarSetFromRand("rand", 1, xGetDatabaseCount(dPlayerCharacters), true);
						for(x=trQuestVarGet("rand"); >0) {
							xDatabaseNext(dPlayerCharacters, true);
							if (trUnitAlive()) {
								trUnitHighlight(2.5, true);
								break;
							}
						}
						trVectorSetUnitPos("pos", dPlayerCharacters);
						bossTarget = trQuestVarGet(dPlayerCharacters));
						trQuestVarSet("bossPrevx", trQuestVarGet("bossDirx"));
						trQuestVarSet("bossPrevz", trQuestVarGet("bossDirz"));
						trVectorQuestVarSet("bossDestDir", zGetUnitVector("bossPos", "pos"));
						trQuestVarSet("testDir1x", 0.0 - trQuestVarGet("bossDirz"));
						trQuestVarSet("testDir1z", trQuestVarGet("bossDirx"));
						trQuestVarSet("testDir2x", trQuestVarGet("bossDirz"));
						trQuestVarSet("testDir2z", 0.0 - trQuestVarGet("bossDirx"));
						if (dotProduct("testDir1", "bossDestDir") > dotProduct("testDir2", "bossDestDir")) {
							trQuestVarSet("bossTurnDir", -1.0);
						} else {
							trQuestVarSet("bossTurnDir", 1.0);
						}
						bossNext = trTimeMS() + 3000;
						trQuestVarSet("bossLast", trTimeMS());
						trQuestVarSet("bossSpell", 34);
						trSoundPlayFN("automatonspcbirth.wav","1",-1,"","");
					} else {
						bossCooldown(10, 20);
						trQuestVarSet("bossUltimate", 3);
						trSoundPlayFN("godpowerfailed.wav","1",-1,"","");
						trUnitSelectClear();
						trUnitSelectByQV("bossBarrel", true);
						trUnitSetStance("Aggressive");
						trUnitTeleport(1,0,1);
						trUnitSelectClear();
						trUnitSelectByQV("bossTurret", true);
						trUnitSetStance("Aggressive");
						trUnitTeleport(1,0,1);
						trSetLighting("anatolia",2.0);
						ySetPointer("stunnedUnits", 1*trQuestVarGet("bossStunIndex"));
						xFreeDatabaseBlock("stunnedUnits");
					}
				} else {
					amt = bossNext - trTimeMS();
					amt = 1.0 - 0.0005 * amt;
					trSetSelectedScale(1.5,amt,1.5);
				}
			} else if (trQuestVarGet("bossSpell") == 34) {
				amt = trTimeMS() - trQuestVarGet("bossLast");
				trQuestVarSet("bossLast", trTimeMS());
				angle = fModulo(6.283185, bossAngle + trQuestVarGet("bossTurnDir") * amt * 0.0016);
				bossAngle = angle;
				trVectorSetFromAngle("bossDir", angle);
				trVectorSetUnitPos("target", "bossTarget");
				/* unit isn't dead */
				if (trQuestVarGet("targetx") > 0) {
					trVectorQuestVarSet("bossDestDir", zGetUnitVector("bossPos", "target"));
				}
				if (dotProduct("bossDir", "bossDestDir") < dotProduct("bossPrev", "bossDestDir") ||
					trTimeMS() > bossNext) {
					/* we passed them */
					angle = angleOfVector("bossDir");
					trQuestVarSet("bossSpell", 35);
					bossNext = trTimeMS() + 1000;
					trSoundPlayFN("storehouse.wav","1",-1,"","");
					trQuestVarSetFromRand("rand", 1, 10, true);
					if (trQuestVarGet("rand") == 1) {
						trChatSendSpoofed(ENEMY_PLAYER, "The Exterminator: PARRY THIS YOU FILTHY CASUAL");
					} else if (trQuestVarGet("rand") == 2) {
						trChatSendSpoofed(ENEMY_PLAYER, "The Exterminator: EXTERMINATE. EXTERMINATE.");
					} else if (trQuestVarGet("rand") == 3) {
						trChatSendSpoofed(ENEMY_PLAYER, "The Exterminator: DEATH TO ALL HUMANS");
					}
				} else {
					trQuestVarSet("bossPrevx", trQuestVarGet("bossDirx"));
					trQuestVarSet("bossPrevz", trQuestVarGet("bossDirz"));
				}
				trUnitSelectClear();
				trUnitSelectByQV("bossTurret", true);
				trSetUnitOrientation(bossDir,vector(0,1,0),true);
				trUnitSelectClear();
				trUnitSelectByQV("bossBarrel", true);
				trSetUnitOrientation(vector(0,1,0),bossDir,true);
			} else if (trQuestVarGet("bossSpell") == 35) {
				if (trTimeMS() > bossNext) {
					trUnitSelectClear();
					trUnitSelectByQV("bossBarrel");
					trMutateSelected(kbGetProtoUnitID("Lancer Hero"));
					trUnitSelectClear();
					trUnitSelectByQV("volcano1", true);
					trUnitChangeProtoUnit("Cinematic Block");
					trUnitSelectClear();
					trUnitSelectByQV("volcano2", true);
					trUnitChangeProtoUnit("Cinematic Block");
					trUnitSelectClear();
					trUnitSelectByQV("volcano1", true);
					trMutateSelected(kbGetProtoUnitID("Volcano"));
					trSetSelectedUpVector(trQuestVarGet("bossDirx"),0,trQuestVarGet("bossDirz"));
					trUnitOverrideAnimation(18,0,false,false,-1);
					trMutateSelected(kbGetProtoUnitID("Relic"));
					trImmediateUnitGarrison(""+1*trQuestVarGet("bossBarrel"));
					trMutateSelected(kbGetProtoUnitID("Volcano"));
					trSetSelectedScale(0,0,0);
					
					
					trUnitSelectClear();
					trUnitSelectByQV("volcano2", true);
					trMutateSelected(kbGetProtoUnitID("Volcano"));
					trSetSelectedUpVector(trQuestVarGet("bossDirx"),0,trQuestVarGet("bossDirz"));
					trUnitOverrideAnimation(18,0,false,false,-1);
					trMutateSelected(kbGetProtoUnitID("Relic"));
					trImmediateUnitGarrison(""+1*trQuestVarGet("bossBarrel"));
					trMutateSelected(kbGetProtoUnitID("Volcano"));
					trSetSelectedScale(0,0,0);
					
					
					trUnitSelectClear();
					trUnitSelectByQV("bossBarrel");
					trMutateSelected(kbGetProtoUnitID("Wadjet Spit"));
					bossCount = bossCount - 1;
					trQuestVarSet("destx", trQuestVarGet("bossPosx"));
					trQuestVarSet("destz", trQuestVarGet("bossPosz"));
					for(x=50; > 0) {
						trQuestVarSet("destx", trQuestVarGet("destx") + 2.0 * trQuestVarGet("bossDirx"));
						trQuestVarSet("destz", trQuestVarGet("destZ") + 2.0 * trQuestVarGet("bossDirz"));
						vectorToGrid("dest", "loc");
						if (terrainIsType("loc", TERRAIN_WALL, TERRAIN_SUB_WALL)) {
							trArmyDispatch("1,0","Dwarf",1,trQuestVarGet("destx"),0,trQuestVarGet("destz"),0,true);
							trArmySelect("1,0");
							trUnitChangeProtoUnit("Meteor Impact Ground");
							trArmyDispatch("1,0","Dwarf",1,trQuestVarGet("destx"),0,trQuestVarGet("destz"),0,true);
							trArmySelect("1,0");
							trMutateSelected(kbGetProtoUnitID("Meteor"));
							break;
						}
					}
					for(x=xGetDatabaseCount(dPlayerUnits); >0) {
						if (xDatabaseNext(dPlayerUnits, true) == -1 || trUnitAlive() == false) {
							removePlayerUnit();
						} else {
							amt = zDistanceToVector(dPlayerUnits, "bossPos");
							trQuestVarSet("hitboxX", trQuestVarGet("bossPosx") + amt * trQuestVarGet("bossDirx"));
							trQuestVarSet("hitboxZ", trQuestVarGet("bossPosz") + amt * trQuestVarGet("bossDirz"));
							if (zDistanceToVectorSquared(dPlayerUnits, "hitbox") < 10.0 ||
								zDistanceToVectorSquared(dPlayerUnits, "dest") < 36.0) {
								damagePlayerUnit(1000);
							}
						}
					}
					trSoundPlayFN("ui\thunder1.wav","1",-1,"","");
					trSoundPlayFN("cinematics\32_out\doorbigshut.mp3","1",-1,"","");
					trSoundPlayFN("meteordustcloud.wav","1",-1,"","");
					trCameraShake(0.7, 0.8);
					trQuestVarSet("bossSpell", 33);
					trUnitSelectClear();
					trUnitSelectByQV("bossBarrelObject", true);
					trSetSelectedScale(1.5,0.25,1.5);
					bossNext = trTimeMS() + 1500;
				}
			}
		} else if (trQuestVarGet("bossSpell") > 20) {
			if (trQuestVarGet("bossSpell") == 21) {
				trQuestVarSetFromRand("rand", 1, 3, true);
				if (trQuestVarGet("rand") == 1) {
					trChatSendSpoofed(ENEMY_PLAYER, "The Exterminator: DEPLOYING DRONES");
				} else if (trQuestVarGet("rand") == 2) {
					trChatSendSpoofed(ENEMY_PLAYER, "The Exterminator: EXTERMINATE THE HUMANS");
				}
				trQuestVarSetFromRand("bossSummonProto", 1, 3, true);
				trQuestVarSetFromRand("bossCount", 5, 5 + ENEMY_PLAYER);
				trQuestVarSet("bossSpell", 22);
				bossNext = trTimeMS();
				trSoundPlayFN("catapultattack.wav","1",-1,"","");
			} else if (trQuestVarGet("bossSpell") == 22) {
				if (trTimeMS() > bossNext) {
					bossNext = trTimeMS() + 200;
					trQuestVarSetFromRand("angle", 0, 6.283185, false);
					trVectorSetFromAngle("dir", trQuestVarGet("angle"));
					trQuestVarSetFromRand("speed", 5, 12, false);
					trVectorSetUnitPos("pos", "bossUnit");
					addGenericProj("deployRobots","pos","dir",kbGetProtoUnitID("Statue of Automaton Base"),
						2,trQuestVarGet("speed"),3,1);
					bossCount = bossCount - 1;
					if (bossCount <= 0) {
						bossCooldown(10, 20);
					}
				}
			}
		} else if (trQuestVarGet("bossSpell") > 10) {
			if (trQuestVarGet("bossSpell") == 11) {
				trQuestVarSetFromRand("rand", 1, 3, true);
				if (trQuestVarGet("rand") == 1) {
					trChatSendSpoofed(ENEMY_PLAYER, "The Exterminator: RAMMING SPEED");
				} else if (trQuestVarGet("rand") == 2) {
					trChatSendSpoofed(ENEMY_PLAYER, "The Exterminator: THRUSTERS ENGAGED");
				}
				trSoundPlayFN("siegeacknowledge.wav","1",-1,"","");
				trSoundPlayFN("attackwarning.wav","1",-1,"","");
				trQuestVarSet("bossStunIndex", yAddToDatabase("stunnedUnits", "bossUnit"));
				yAddUpdateVar("stunnedUnits", "proto", kbGetProtoUnitID("Helepolis"));
				xDatabaseNext(dPlayerCharacters);
				trVectorSetUnitPos("bossTargetPos", dPlayerCharacters);
				bossPos = kbGetBlockPosition(""+bossUnit, true);
				bossDir = zGetUnitVector("bossPos", "bossTargetPos");
				trSetUnitOrientation(bossDir,vector(0,1,0),true);
				trQuestVarSet("destx", trQuestVarGet("bossPosx"));
				trQuestVarSet("destz", trQuestVarGet("bossPosz"));
				for(x=50; >0) {
					trQuestVarSet("destx", trQuestVarGet("destx") + 2.0 * trQuestVarGet("bossDirx"));
					trQuestVarSet("destz", trQuestVarGet("destz") + 2.0 * trQuestVarGet("bossDirz"));
					vectorToGrid("dest", "loc");
					if (terrainIsType("loc", TERRAIN_WALL, TERRAIN_SUB_WALL)) {
						break;
					} else {
						trQuestVarSet("bossTargetPosx", trQuestVarGet("destx"));
						trQuestVarSet("bossTargetPosz", trQuestVarGet("destz"));
					}
				}
				bossNext = trTimeMS() + 1000;
				trQuestVarSet("bossSpell", 12);
				trQuestVarSet("bossCar", trGetNextUnitScenarioNameNumber());
				trArmyDispatch("1,0","Dwarf",1,1,0,1,0,true);
				trArmySelect("1,0");
				trImmediateUnitGarrison(""+1*bossUnit);
			} else if (trQuestVarGet("bossSpell") == 12) {
				if (trTimeMS() > bossNext) {
					ySetPointer("stunnedUnits", 1*trQuestVarGet("bossStunIndex"));
					xFreeDatabaseBlock("stunnedUnits");
					trUnitSelectClear();
					trUnitSelectByQV("bossCar", true);
					trUnitConvert(ENEMY_PLAYER);
					trUnitChangeProtoUnit("Hero Greek Achilles");
					trUnitSelectClear();
					trUnitSelectByQV("bossCar", true);
					trSetUnitOrientation(bossDir,vector(0,1,0),true);
					trUnitSelectClear();
					trUnitSelect(""+bossUnit, true);
					trMutateSelected(kbGetProtoUnitID("Relic"));
					trImmediateUnitGarrison(""+1*trQuestVarGet("bossCar"));
					trMutateSelected(kbGetProtoUnitID("Helepolis"));
					trQuestVarSet("bossSFX", trGetNextUnitScenarioNameNumber());
					trArmyDispatch("1,0","Dwarf",1,1,0,1,0,true);
					trUnitSelectClear();
					trUnitSelectByQV("bossSFX");
					trMutateSelected(kbGetProtoUnitID("Meteorite"));
					trUnitOverrideAnimation(6,0,true,false,-1);
					trMutateSelected(kbGetProtoUnitID("Relic"));
					trImmediateUnitGarrison(""+1*trQuestVarGet("bossCar"));
					trMutateSelected(kbGetProtoUnitID("Meteorite"));
					
					trUnitSelectClear();
					trUnitSelectByQV("bossCar", true);
					trMutateSelected(kbGetProtoUnitID("Wadjet Spit"));
					trUnitMoveToPoint(trQuestVarGet("bossTargetPosx"),0,trQuestVarGet("bossTargetPosz"),-1,false);
					trSoundPlayFN("phoenixattack.wav","1",-1,"","");
					trQuestVarSet("bossSpell", 13);
					bossTimeout = trTimeMS() + 3000;
					yClearDatabase("splatterUnits");
					for(x=xGetDatabaseCount(dPlayerUnits); >0) {
						if (xDatabaseNext(dPlayerUnits, true) > -1) {
							yAddToDatabase("splatterUnits", dPlayerUnits);
							yAddUpdateVar("splatterUnits", "index", yGetPointer(dPlayerUnits));
						}
					}
				}
			} else if (trQuestVarGet("bossSpell") == 13) {
				bossPos = kbGetBlockPosition(""+bossUnit, true);
				if (zDistanceBetweenVectorsSquared("bossPos", "bossTargetPos") < 4 ||
					trTimeMS() > bossTimeout) {
					trUnitChangeProtoUnit("Helepolis");
					trUnitSelectClear();
					trUnitSelectByQV("bossSFX");
					trDamageUnitPercent(100);
					trUnitSelectClear();
					trUnitSelectByQV("bossCar");
					trUnitChangeProtoUnit("Meteor Impact Ground");
					for(x=xGetDatabaseCount(dPlayerUnits); >0) {
						if (xDatabaseNext(dPlayerUnits, true) == -1 || trUnitAlive() == false) {
							removePlayerUnit();
						} else if (zDistanceToVectorSquared(dPlayerUnits, "bossPos") < 16) {
							damagePlayerUnit(500);
						}
					}
					trSoundPlayFN("meteorbighit.wav","1",-1,"","");
					trCameraShake(0.5,0.5);
					
					trUnitSelectClear();
					trUnitSelect(""+bossUnit, true);
					trSetSelectedScale(bossScale,bossScale,bossScale);
					bossCooldown(10, 16);
				} else {
					trQuestVarSet("sound", 0);
					for(x=xGetDatabaseCount("splatterUnits"); >0) {
						id = xDatabaseNext("splatterUnits", true);
						if (id == -1 || trUnitAlive() == false) {
							xFreeDatabaseBlock("splatterUnits");
						} else if (zDistanceToVectorSquared("splatterUnits", "bossPos") < 25) {
							if (ySetPointer(dPlayerUnits, 1*yGetVar("splatterUnits", "index"))) {
								trQuestVarSet("sound", 1);
								damagePlayerUnit(500);
								xsSetContextPlayer(1*yGetVar(dPlayerUnits, "player"));
								if (kbUnitGetCurrentHitpoints(id) > 0) {
									trVectorSetUnitPos("pos", dPlayerUnits);
									trQuestVarSet("endx", trQuestVarGet("posx") - trQuestVarGet("bossPosx") + trQuestVarGet("bossTargetPosx"));
									trQuestVarSet("endz", trQuestVarGet("posz") - trQuestVarGet("bossPosz") + trQuestVarGet("bossTargetPosz"));
									launchUnit(dPlayerUnits, "end");
								} else {
									trSetSelectedUpVector(5.0*trQuestVarGet("bossDirx"),-0.5,5.0*trQuestVarGet("bossDirz"));
								}
							}
							xFreeDatabaseBlock("splatterUnits");
						}
					}
					if (trQuestVarGet("sound") == 1) {
						trQuestVarSetFromRand("sound", 1, 2, true);
						trSoundPlayFN("titanpunch"+1*trQuestVarGet("sound")+".wav","1",-1,"","");
						trQuestVarSet("sound", 0);
					}
				}
			}
		} else if (trQuestVarGet("bossSpell") > 0) {
			if (trQuestVarGet("bossSpell") == 1) {
				trQuestVarSetFromRand("rand", 1, 3, true);
				if (trQuestVarGet("rand") == 1) {
					trChatSendSpoofed(ENEMY_PLAYER, "The Exterminator: TARGET LOCKED");
				} else if (trQuestVarGet("rand") == 2) {
					trChatSendSpoofed(ENEMY_PLAYER, "The Exterminator: ACTIVATING LASERS");
				}
				trQuestVarSet("bossSpell", 2);
				bossNext = trTimeMS();
				bossCount = 5;
			} else if (trQuestVarGet("bossSpell") == 2) {
				if (trTimeMS() > bossNext) {
					bossNext = trTimeMS() + 1000;
					xDatabaseNext(dPlayerCharacters);
					trVectorSetUnitPos("pos", dPlayerCharacters);
					vectorSnapToGrid("pos");
					trQuestVarSet("next", trGetNextUnitScenarioNameNumber());
					trArmyDispatch("1,0","Dwarf",1,trQuestVarGet("posx"),0,trQuestVarGet("posz")+2,180,true);
					trArmyDispatch("1,0","Dwarf",1,trQuestVarGet("posx"),0,trQuestVarGet("posz")-2,0,false);
					trArmyDispatch("1,0","Dwarf",1,trQuestVarGet("posx")+2,0,trQuestVarGet("posz"),270,false);
					trArmyDispatch("1,0","Dwarf",1,trQuestVarGet("posx")-2,0,trQuestVarGet("posz"),90,false);
					trArmySelect("1,0");
					trUnitSetStance("Passive");
					trMutateSelected(kbGetProtoUnitID("Petosuchus Projectile"));
					trSetSelectedScale(3,0,60);
					yAddToDatabase("bossLasers", "next");
					yAddUpdateVar("bossLasers", "step", 1);
					yAddUpdateVar("bossLasers", "posx", trQuestVarGet("posx"));
					yAddUpdateVar("bossLasers", "posz", trQuestVarGet("posz"));
					yAddUpdateVar("bossLasers", "next", trTimeMS() + 2000);
					trSoundPlayFN("skypassagein.wav","1",-1,"","");
					bossCount = bossCount - 1;
					if (bossCount <= 0) {
						bossCooldown(9, 15);
					}
				}
			}
		} else if (xGetInt(dEnemies, xStunStatus, bossPointer) == 0) {
			trQuestVarSetFromRand("bossSpell", 0, xsMin(3, trUnitPercentDamaged() * 0.05), true);
			trQuestVarSet("bossSpell", trQuestVarGet("bossSpell") * 10 + 1);
			if (trQuestVarGet("bossSpell") == 31 && trQuestVarGet("bossUltimate") > 0) {
				trQuestVarSetFromRand("bossSpell", 0, 2, true);
				trQuestVarSet("bossSpell", 1 + 10 * trQuestVarGet("bossSpell"));
			}
		}
	} else {
		trUnitOverrideAnimation(-1,0,false,true,-1);
		xsDisableSelf();
		trMusicStop();
		boss = 0;
		trSetLighting("default", 1.0);
		trSoundPlayFN("win.wav","1",-1,"","");
		for(x=xGetDatabaseCount(dEnemies); >0) {
			xDatabaseNext(dEnemies, true);
			trDamageUnitPercent(100);
		}
		uiLookAtUnitByName(""+bossUnit);
		xsEnableRule("boss_ded");
		xsDisableRule("gameplay_always");
	}
}

rule boss4_battle
inactive
highFrequency
{
	trUnitSelectClear();
	trUnitSelect(""+bossUnit, true);
	int p = 0;
	int x = 0;
	int action = 0;
	int id = 0;
	float amt = 0;
	float dist = 0;
	float angle = 0;
	bool hit = false;
	if (trUnitAlive() == true) {
		for (i=xsMin(3,xGetDatabaseCount("bossClouds")); > 0) {
			action = processGenericProj("bossClouds");
			if ((action == PROJ_FALLING) && yGetVar("bossClouds", "type") < 99) {
				yVarToVector("bossClouds", "prev");
				yVarToVector("bossClouds", "dir");
				amt = zDistanceBetweenVectors("pos", "prev");
				if (amt > 4.0) {
					yVarToVector("bossClouds", "dir");
					ySetVar("bossClouds", "currentDist", yGetVar("bossClouds", "currentDist") + amt);
					for(x=xGetDatabaseCount(dPlayerUnits); >0) {
						if (xDatabaseNext(dPlayerUnits, true) == -1 || trUnitAlive() == false) {
							removePlayerUnit();
						} else {
							dist = zDistanceToVector(dPlayerUnits, "prev");
							if (dist < amt + 1.0) {
								trQuestVarSet("hitboxX", trQuestVarGet("prevX") + dist * trQuestVarGet("dirX"));
								trQuestVarSet("hitboxZ", trQuestVarGet("prevZ") + dist * trQuestVarGet("dirZ"));
								if (zDistanceToVectorSquared(dPlayerUnits, "hitbox") < 4.0) {
									poisonUnit(dPlayerUnits, 10, 30);
								}
							}
						}
					}
					ySetVarFromVector("bossClouds", "prev", "pos");
				}
				trQuestVarSet("nextx", trQuestVarGet("posx") + 2.0 * trQuestVarGet("dirx"));
				trQuestVarSet("nextz", trQuestVarGet("posz") + 2.0 * trQuestVarGet("dirz"));
				vectorToGrid("next", "loc");
				if (terrainIsType("loc", TERRAIN_WALL, TERRAIN_SUB_WALL)) {
					xFreeDatabaseBlock("bossClouds");
				}
			} else if ((action == PROJ_GROUND) && yGetVar("bossClouds", "type") == 99) {
				trDamageUnitPercent(-100);
				trQuestVarSetFromRand("rand", 1, 5, true);
				switch(1*trQuestVarGet("rand"))
				{
					case 1:
					{
						trUnitChangeProtoUnit("Sphinx");
					}
					case 2:
					{
						trUnitChangeProtoUnit("Cyclops");
					}
					case 3:
					{
						trUnitChangeProtoUnit("Avenger");
					}
					case 4:
					{
						trUnitChangeProtoUnit("Dryad");
					}
					case 5:
					{
						trUnitChangeProtoUnit("Walking Woods Marsh");
					}
				}
				trUnitSelectClear();
				trUnitSelectByQV("bossClouds", true);
				trDamageUnitPercent(-100);
				activateEnemy("bossClouds",-1,0);
				xFreeDatabaseBlock("bossClouds");
			}
		}
		
		trUnitSelectClear();
		trUnitSelect(""+bossUnit, true);
		if (trQuestVarGet("bossSpell") == BOSS_SPELL_COOLDOWN) {
			processBossCooldown();
		} else if (trQuestVarGet("bossSpell") > 30) {
			if (trQuestVarGet("bossSpell") == 31) {
				trOverlayText("Land of Ashes", 3.0, -1, -1, -1);
				trSetLighting("night", 1.0);
				trSoundPlayFN("cinematics\15_in\gong.wav","1",-1,"","");
				trSoundPlayFN("godpower.wav","1",-1,"","");
				bossNext = trTimeMS() + 2000;
				trQuestVarSet("bossSpell", 32);
			} else if (trQuestVarGet("bossSpell") == 32) {
				/* fire carousel */
				trQuestVarSet("bossSpell", 33);
				if (kbGetBlockID(""+1*trQuestVarGet("bossCrossFireSFX")) == -1) {
					spyEffect(1*bossUnit,kbGetProtoUnitID("Meteorite"),"bossCrossFireSFX");
				} else {
					trUnitSelectClear();
					trUnitSelectByQV("bossCrossFireSFX");
					trMutateSelected(kbGetProtoUnitID("Meteorite"));
				}
			} else if (trQuestVarGet("bossSpell") == 33) {
				if (trQuestVarGet("spyfind") == trQuestVarGet("spyfound")) {
					trUnitSelectClear();
					trUnitSelectByQV("bossCrossFireSFX", true);
					trUnitOverrideAnimation(6,0,true,false,-1);
					trSoundPlayFN("flamingweapons.wav","1",-1,"","");
					trSoundPlayFN("nidhoggflame1.wav","1",-1,"","");
					bossAngle = 0;
					bossTimeout = trTimeMS() + 12000;
					for(x=4; >0) {
						trQuestVarSet("bossNext"+x, trTimeMS() + 100 * x);
					}
					trQuestVarSet("bossSpell", 34);
				}
			} else if (trQuestVarGet("bossSpell") >= 34) {
				trQuestVarSet("bossSpell", 1 + trQuestVarGet("bossSpell"));
				if (trQuestVarGet("bossSpell") >= 38) {
					trQuestVarSet("bossSpell", 34);
				}
				dist = trTimeMS() - trQuestVarGet("bossLast");
				trQuestVarSet("bossLast", trTimeMS());
				bossAngle = fModulo(6.283185, bossAngle + 0.0004 * dist);
				trVectorSetFromAngle("dir", bossAngle);
				action = 1*trQuestVarGet("bossSpell") - 22;
				switch(action)
				{
					case 1:
					{
						amt = trQuestVarGet("dirX");
						trQuestVarSet("dirX", 0.0 - trQuestVarGet("dirZ"));
						trQuestVarSet("dirZ", amt);
					}
					case 2:
					{
						trQuestVarSet("dirX", 0.0 - trQuestVarGet("dirX"));
						trQuestVarSet("dirZ", 0.0 - trQuestVarGet("dirZ"));
					}
					case 3:
					{
						amt = trQuestVarGet("dirZ");
						trQuestVarSet("dirZ", 0.0 - trQuestVarGet("dirX"));
						trQuestVarSet("dirX", amt);
					}
				}
				trUnitSelectClear();
				trUnitSelectByQV("bossCrossFireSFX", true);
				trSetSelectedUpVector(4.0 * trQuestVarGet("dirX"),-1,4.0 * trQuestVarGet("dirZ"));
				if (trTimeMS() > trQuestVarGet("bossNext"+action) + 400) {
					amt = trTimeMS() - trQuestVarGet("bossNext"+action);
					trQuestVarSet("bossNext"+action, 400 + trQuestVarGet("bossNext"+action));
					bossPos = kbGetBlockPosition(""+bossUnit, true);
					for(x=xGetDatabaseCount(dPlayerUnits); >0) {
						if (xDatabaseNext(dPlayerUnits, true) == -1 || trUnitAlive() == false) {
							removePlayerUnit();
						} else {
							dist = zDistanceToVector(dPlayerUnits, "bossPos");
							if (dist < 16) {
								dist = xsMin(dist, 12);
								trQuestVarSet("hitboxX", trQuestVarGet("bossPosX") + dist * trQuestVarGet("dirX"));
								trQuestVarSet("hitboxZ", trQuestVarGet("bossPosZ") + dist * trQuestVarGet("dirZ"));
								if (zDistanceToVectorSquared(dPlayerUnits, "hitbox") < 16) {
									damagePlayerUnit(0.4 * amt);
								}
							}
						}
					}
				}
				if (trTimeMS() > bossTimeout) {
					trQuestVarSet("bossUltimate", 3);
					trSetLighting("default", 1.0);
					trSoundPlayFN("godpowerfailed.wav","1",-1,"","");
					trUnitSelectClear();
					trUnitSelectByQV("bossCrossFireSFX");
					trMutateSelected(kbGetProtoUnitID("Cinematic Block"));
					bossCooldown(12, 16);
				}
			}
		} else if (trQuestVarGet("bossSpell") > 20) {
			if (trQuestVarGet("bossSpell") == 21) {
				trSoundPlayFN("attackwarning.wav","1",-1,"","");
				trSoundPlayFN("flamingweapons.wav","1",-1,"","");
				trQuestVarSetFromRand("rand", 1, xGetDatabaseCount(dPlayerCharacters), true);
				for(x=trQuestVarGet("rand"); >0) {
					xDatabaseNext(dPlayerCharacters);
					trVectorSetUnitPos("bossTargetPos", dPlayerCharacters);
				}
				if (ySetPointer(dEnemies, bossPointer)) {
					ySetVar(dEnemies, "launched", 1);
				}
				bossNext = trTimeMS() + 1500;
				trQuestVarSet("bossSpell", 22);
				bossPos = kbGetBlockPosition(""+bossUnit, true);
				bossDir = zGetUnitVector("bossPos", "bossTargetPos");
				trSetUnitOrientation(bossDir,vector(0,1,0),true);
				bossAngle = angleBetweenVectors("bossPos", "bossTargetPos");
			} else if (trQuestVarGet("bossSpell") == 22) {
				if (trTimeMS() > bossNext) {
					trSetUnitOrientation(bossDir,vector(0,1,0),true);
					trUnitOverrideAnimation(19,0,false,false,-1);
					trSoundPlayFN("flamingweapons.wav","1",-1,"","");
					trQuestVarSet("bossSpell", 23);
					bossNext =trTimeMS() + 600;
					bossTimeout = trTimeMS() + 2000;
					trQuestVarSet("bossBreath", trGetNextUnitScenarioNameNumber());
					trArmyDispatch("1,0","Dwarf",1,trQuestVarGet("bossPosx"),0,trQuestVarGet("bossPosz"),0,true);
					trArmySelect("1,0");
					trUnitConvert(0);
					trMutateSelected(kbGetProtoUnitID("Meteorite"));
					bossAnim = true;
				}
			} else if (trQuestVarGet("bossSpell") == 23) {
				if (trTimeMS() > bossNext) {
					trCameraShake(1.5, 0.4);
					trSoundPlayFN("sonofosirisbolt.wav","1",-1,"","");
					bossAngle = fModulo(6.283185, bossAngle + 0.5);
					trUnitSelectClear();
					trUnitSelectByQV("bossBreath");
					trUnitOverrideAnimation(6,0,true,false,-1);
					trVectorSetFromAngle("dir", bossAngle);
					trSetSelectedUpVector(10.0 * trQuestVarGet("dirx"),0,10.0 * trQuestVarGet("dirz"));
					trQuestVarSet("bossSpell", 24);
					trQuestVarSet("bossLastDirx",trQuestVarGet("dirx"));
					trQuestVarSet("bossLastDirz",trQuestVarGet("dirz"));
				} else {
					trSetUnitOrientation(bossDir,vector(0,1,0),true);
				}
			} else if (trQuestVarGet("bossSpell") == 24) {
				trSetUnitOrientation(bossDir,vector(0,1,0),true);
				amt = 1.0 * (trTimeMS() - bossNext) / 1400;
				amt = fModulo(6.283185, bossAngle - amt * 1.116);
				trUnitSelectClear();
				trUnitSelectByQV("bossBreath");
				trVectorSetFromAngle("dir", amt);
				trSetSelectedUpVector(10.0 * trQuestVarGet("dirx"),0,10.0 * trQuestVarGet("dirz"));
				for(x=xGetDatabaseCount(dPlayerUnits); >0) {
					if (xDatabaseNext(dPlayerUnits, true) == -1 || trUnitAlive() == false) {
						removePlayerUnit();
					} else {
						trVectorSetUnitPos("pos", dPlayerUnits);
						trVectorQuestVarSet("hit", zGetUnitVector("bossPos", "pos"));
						amt = dotProduct("bossLastDir", "dir");
						if (dotProduct("hit", "dir") > amt &&
							dotProduct("hit", "bossLastDir") > amt) {
							damagePlayerUnit(800);
						}
					}
				}
				trQuestVarSet("bossLastDirx",trQuestVarGet("dirx"));
				trQuestVarSet("bossLastDirz",trQuestVarGet("dirz"));
				
				if (trTimeMS() > bossTimeout) {
					bossAnim = false;
					trUnitSelectClear();
					trUnitSelectByQV("bossBreath");
					trUnitChangeProtoUnit("Rocket");
					trSetLighting("default", 1.0);
					bossCooldown(10, 16);
					trUnitSelectClear();
					trUnitSelect(""+bossUnit, true);
					trMutateSelected(kbGetProtoUnitID("Chimera"));
					trUnitOverrideAnimation(-1,0,false,true,-1);
				}
			}
		} else if (trQuestVarGet("bossSpell") > 10) {
			if (trQuestVarGet("bossSpell") == 11) {
				trSoundPlayFN("argusfreezeattack.wav","1",-1,"","");
				trQuestVarSetFromRand("rand", 1, xGetDatabaseCount(dPlayerCharacters), true);
				for(x=trQuestVarGet("rand"); >0) {
					xDatabaseNext(dPlayerCharacters);
					trVectorSetUnitPos("bossTargetPos", dPlayerCharacters);
				}
				if (ySetPointer(dEnemies, bossPointer)) {
					ySetVar(dEnemies, "launched", 1);
				}
				bossAnim = true;
				bossPos = kbGetBlockPosition(""+bossUnit, true);
				bossDir = zGetUnitVector("bossPos", "bossTargetPos");
				trSetUnitOrientation(bossDir,vector(0,1,0),true);
				trUnitOverrideAnimation(19,0,false,false,-1);
				bossAngle = angleBetweenVectors("bossPos", "bossTargetPos");
				bossAngle = fModulo(6.283185, bossAngle + 0.558);
				trQuestVarSet("bossSpell", 12);
				bossNext =trTimeMS();
				bossCount = 8;
			} else if (trQuestVarGet("bossSpell") == 12) {
				if (trTimeMS() > bossNext) {
					bossNext = trTimeMS() + 200;
					trVectorSetFromAngle("dir", bossAngle);
					addGenericProj("bossClouds","bossPos","dir",kbGetProtoUnitID("Lampades Blood"),2,10.0,4.5,1.0);
					yAddUpdateVar("bossClouds", "prevx", trQuestVarGet("bossPosx"));
					yAddUpdateVar("bossClouds", "prevz", trQuestVarGet("bossPosz"));
					yAddUpdateVar("bossClouds", "type", STATUS_POISON);
					bossAngle = bossAngle - 0.139;
					bossCount = bossCount - 1;
					if (bossCount <= 0) {
						bossAnim = false;
						bossCooldown(10, 16);
						trUnitSelectClear();
						trUnitSelect(""+bossUnit, true);
						trMutateSelected(kbGetProtoUnitID("Chimera"));
						trUnitOverrideAnimation(-1,0,false,true,-1);
						if (ySetPointer(dEnemies, bossPointer)) {
							ySetVar(dEnemies, "launched", 0);
						}
					}
				} else {
					trSetUnitOrientation(bossDir,vector(0,1,0),true);
				}
			}
		} else if (trQuestVarGet("bossSpell") > 0) {
			if (trQuestVarGet("bossSpell") == 1) {
				if (trQuestVarGet("bossSummons") == 1) {
					trQuestVarSet("bossSummons", 0);
					trQuestVarSet("bossSpell", 11);
				} else {
					trSoundPlayFN("mummyconvert.wav","1",-1,"","");
					trQuestVarSetFromRand("rand", 1, xGetDatabaseCount(dPlayerCharacters), true);
					for(x=trQuestVarGet("rand"); >0) {
						xDatabaseNext(dPlayerCharacters);
						trVectorSetUnitPos("bossTargetPos", dPlayerCharacters);
					}
					if (ySetPointer(dEnemies, bossPointer)) {
						ySetVar(dEnemies, "launched", 1);
					}
					bossPos = kbGetBlockPosition(""+bossUnit, true);
					bossDir = zGetUnitVector("bossPos", "bossTargetPos");
					trSetUnitOrientation(bossDir,vector(0,1,0),true);
					trUnitOverrideAnimation(19,0,false,false,-1);
					bossAngle = angleBetweenVectors("bossPos", "bossTargetPos");
					bossAngle = fModulo(6.283185, bossAngle + 0.558);
					trQuestVarSet("bossSpell", 2);
					bossNext =trTimeMS();
					bossCount = 8;
					bossAnim = true;
				}
			} else if (trQuestVarGet("bossSpell") == 2) {
				if (trTimeMS() > bossNext) {
					bossNext = trTimeMS() + 100;
					trVectorSetFromAngle("dir", bossAngle);
					trQuestVarSetFromRand("speed", 10.0, 20.0, false);
					addGenericProj("bossClouds","bossPos","dir",kbGetProtoUnitID("Kronny Birth SFX"),2,trQuestVarGet("speed"),4.0,1.0);
					yAddUpdateVar("bossClouds", "prevx", trQuestVarGet("bossPosx"));
					yAddUpdateVar("bossClouds", "prevz", trQuestVarGet("bossPosz"));
					yAddUpdateVar("bossClouds", "type", 99);
					bossAngle = bossAngle - 0.139;
					bossCount = bossCount - 1;
					if (bossCount <= 0) {
						bossAnim = false;
						bossCooldown(15, 20);
						trQuestVarSet("bossSummons", 1);
						if (ySetPointer(dEnemies, bossPointer)) {
							ySetVar(dEnemies, "launched", 0);
						}
						trUnitSelectClear();
						trUnitSelect(""+bossUnit, true);
						trMutateSelected(kbGetProtoUnitID("Chimera"));
						trUnitOverrideAnimation(-1,0,false,true,-1);
					}
				} else {
					trSetUnitOrientation(bossDir,vector(0,1,0),true);
				}
			}
		} else if (xGetInt(dEnemies, xStunStatus, bossPointer) == 0) {
			trQuestVarSetFromRand("bossSpell", 0, xsMin(3, trUnitPercentDamaged() * 0.05), true);
			trQuestVarSet("bossSpell", trQuestVarGet("bossSpell") * 10 + 1);
			if (trQuestVarGet("bossSpell") == 31 && trQuestVarGet("bossUltimate") > 0) {
				trQuestVarSetFromRand("bossSpell", 0, 2, true);
				trQuestVarSet("bossSpell", 1 + 10 * trQuestVarGet("bossSpell"));
			}
		}
	} else {
		trUnitOverrideAnimation(-1,0,false,true,-1);
		xsDisableSelf();
		trMusicStop();
		boss = 0;
		trSetLighting("default", 1.0);
		trSoundPlayFN("win.wav","1",-1,"","");
		for(x=xGetDatabaseCount(dEnemies); >0) {
			xDatabaseNext(dEnemies, true);
			trDamageUnitPercent(100);
		}
		uiLookAtUnitByName(""+bossUnit);
		xsEnableRule("boss_ded");
		xsDisableRule("gameplay_always");
	}
}


rule boss5_battle
inactive
highFrequency
{
	trUnitSelectClear();
	trUnitSelect(""+bossUnit, true);
	int p = 0;
	int x = 0;
	int z = 0;
	int action = 0;
	int id = 0;
	float amt = 0;
	float dist = 0;
	float angle = 0;
	bool hit = false;
	if (trUnitAlive() == true) {
		switch(1*trQuestVarGet("bossChokeStep"))
		{
			case 0:
			{
				if (trUnitPercentDamaged() > trQuestVarGet("bossChoke")) {
					trQuestVarSet("bossChoke", trQuestVarGet("bossChoke") + 20);
					trQuestVarSet("bossChokeNext", trTimeMS());
					trQuestVarSet("bossChokeStep", 1);
					trQuestVarSet("bossChokeCount", 3);
					trSoundPlayFN("attackwarning.wav","1",-1,"","");
					trMessageSetText("The arena is getting smaller!", -1);
				}
			}
			case 1:
			{
				if (trTimeMS() > trQuestVarGet("bossChokeNext")) {
					action = trQuestVarGet("bossRoomSize");
					x = trQuestVarGet("bossRoomLocX");
					z = trQuestVarGet("bossRoomLocZ");
					if (trQuestVarGet("bossChokeCount") <= 0) {
						trQuestVarSet("bossChokeStep", 0);
						trPaintTerrain(x - action, z - action, x + action, z + action, TERRAIN_WALL, TERRAIN_SUB_WALL, false);
						trChangeTerrainHeight(x - action-1, z - action-1, x + action+1, z + action+1, wallHeight, false);
						
						trPaintTerrain(x - action+1, z - action+1, x + action-2, z + action-2, TERRAIN_PRIMARY, TERRAIN_SUB_PRIMARY, false);
						trChangeTerrainHeight(x - action+1, z - action+1, x + action-1, z + action-1, worldHeight, false);
						
						trPaintTerrain(0,0,5,5,0,70,true);
						trPaintTerrain(0,0,5,5,TERRAIN_WALL,TERRAIN_SUB_WALL,false);
						trSoundPlayFN("wall.wav","1",-1,"","");
						trQuestVarSet("bossRoomSize", action - 1);
						
						if (trQuestVarGet("bossSpell") == BOSS_SPELL_COOLDOWN) {
							trQuestVarSet("bossSpell", 1);
						}
						trQuestVarSet("bottomX", trQuestVarGet("bossRoomCenterX") - 2 * trQuestVarGet("bossRoomSize"));
						trQuestVarSet("bottomZ", trQuestVarGet("bossRoomCenterZ") - 2 * trQuestVarGet("bossRoomSize"));
						trQuestVarSet("topX", trQuestVarGet("bossRoomCenterX") + 2 * trQuestVarGet("bossRoomSize"));
						trQuestVarSet("topZ", trQuestVarGet("bossRoomCenterZ") + 2 * trQuestVarGet("bossRoomSize"));
						for(x=xGetDatabaseCount(dPlayerUnits); >0) {
							if (xDatabaseNext(dPlayerUnits, true) == -1 || trUnitAlive() == false) {
								removePlayerUnit();
							} else {
								trVectorSetUnitPos("pos", dPlayerUnits);
								if (vectorInRectangle("pos", "bottom", "top") == false) {
									trUnitDelete(false);
									removePlayerUnit();
								}
							}
						}
					} else {
						trPaintTerrain(x - action, z - action, x + action, z + action, 2, 10, false);
						trPaintTerrain(x - action+1, z - action+1, x + action-1, z + action-1, TERRAIN_PRIMARY, TERRAIN_SUB_PRIMARY, false);
						trQuestVarSet("bossChokeNext", trQuestVarGet("bossChokeNext") + 500);
						trQuestVarSet("bossChokeStep", 2);
					}
				}
			}
			case 2:
			{
				if (trTimeMS() > trQuestVarGet("bossChokeNext")) {
					action = trQuestVarGet("bossRoomSize");
					x = trQuestVarGet("bossRoomLocX");
					z = trQuestVarGet("bossRoomLocZ");
					trPaintTerrain(x - action, z - action, x + action, z + action, TERRAIN_PRIMARY, TERRAIN_SUB_PRIMARY, false);
					trQuestVarSet("bossChokeNext", trQuestVarGet("bossChokeNext") + 500);
					trQuestVarSet("bossChokeStep", 1);
					trQuestVarSet("bossChokeCount", trQuestVarGet("bossChokeCount") - 1);
				}
			}
		}
		for (i=xsMin(5, xGetDatabaseCount("bossBolts")); > 0) {
			action = processGenericProj("bossBolts");
			if (action == PROJ_FALLING) {
				vectorToGrid("pos", "loc");
				hit = false;
				yVarToVector("bossBolts", "prev");
				yVarToVector("bossBolts", "dir");
				amt = zDistanceBetweenVectors("pos", "prev") + 1.0;
				for(x=xGetDatabaseCount(dPlayerUnits); >0) {
					if (xDatabaseNext(dPlayerUnits, true) == -1 || trUnitAlive() == false) {
						removePlayerUnit();
					} else if (rayCollision(dPlayerUnits,"prev","dir",amt,2.0)) {
						damagePlayerUnit(100);
						poisonUnit(dPlayerUnits, 10, 5 * trQuestVarGet("stage"));
						hit = true;
					}
				}
				if (hit || terrainIsType("loc", TERRAIN_WALL, TERRAIN_SUB_WALL)) {
					trUnitSelectClear();
					trUnitSelectByQV("bossBolts", true);
					trDamageUnitPercent(-100);
					trUnitChangeProtoUnit("Lightning sparks");
					trUnitSelectClear();
					trUnitSelectByQV("bossBolts", true);
					trDamageUnitPercent(-100);
					if (hit) {
						trQuestVarSet("boltsound", 1);
					} else {
						trQuestVarSet("boltsound", 2);
					}
					xFreeDatabaseBlock("bossBolts");
				} else {
					ySetVarFromVector("bossBolts", "prev", "pos");
				}
			}
		}
		if (trQuestVarGet("boltsound") == 1) {
			trQuestVarSetFromRand("sound", 1, 4, true);
			trSoundPlayFN("swordonflesh"+1*trQuestVarGet("sound")+".wav","1",-1,"","");
		} else if (trQuestVarGet("boltsound") == 2) {
			trQuestVarSetFromRand("sound", 1, 3, true);
			trSoundPlayFN("mine"+1*trQuestVarGet("sound")+".wav","1",-1,"","");
		}
		trQuestVarSet("boltsound", 0);
		
		trUnitSelectClear();
		trUnitSelect(""+bossUnit, true);
		if (trQuestVarGet("bossSpell") == BOSS_SPELL_COOLDOWN) {
			processBossCooldown(21);
		} else if (trQuestVarGet("bossSpell") > 20) {
			if (trQuestVarGet("bossSpell") == 21) {
				trSoundPlayFN("cinematics\15_in\gong.wav","1",-1,"","");
				trSoundPlayFN("godpower.wav","1",-1,"","");
				trSetLighting("night", 1.0);
				trOverlayText("Voiceless Scream", 3.0, -1, -1, -1);
				trQuestVarSet("bossStunIndex", yAddToDatabase("stunnedUnits", "bossUnit"));
				yAddUpdateVar("stunnedUnits", "proto", kbGetProtoUnitID("Shade of Hades"));
				ySetVarAtIndex(dEnemies, "launched", 1, bossPointer);
				trQuestVarSetFromRand("rand", 1, xGetDatabaseCount(dPlayerCharacters), true);
				for(x=trQuestVarGet("rand"); >0) {
					xDatabaseNext(dPlayerCharacters);
				}
				bossAnim = true;
				trQuestVarSet("bossMove", 1.0);
				bossTarget = trQuestVarGet(dPlayerCharacters));
				trVectorSetUnitPos("pos", dPlayerCharacters);
				bossPos = kbGetBlockPosition(""+bossUnit, true);
				bossAngle = angleBetweenVectors("bossPos", "pos");
				bossDir = zGetUnitVector("bossPos", "pos");
				trQuestVarSet("dirx", 0.0 - trQuestVarGet("bossDirx"));
				trQuestVarSet("dirz", 0.0 - trQuestVarGet("bossDirz"));
				trSetUnitOrientation(bossDir,vector(0,1,0),true);
				trMutateSelected(kbGetProtoUnitID("Transport Ship Greek"));
				for(x=1; <3) {
					trUnitSelectClear();
					trUnitSelectByQV("bossWarn"+x, true);
					trMutateSelected(kbGetProtoUnitID("Dwarf"));
					trImmediateUnitGarrison(""+1*bossUnit);
					trUnitChangeProtoUnit("Dwarf");
				}
				for(x=trQuestVarGet("bossScreamStart"); < trQuestVarGet("bossScreamEnd")) {
					trUnitSelectClear();
					trUnitSelect(""+x, true);
					trMutateSelected(kbGetProtoUnitID("Dwarf"));
					trImmediateUnitGarrison(""+1*bossUnit);
					trUnitChangeProtoUnit("Dwarf");
					trUnitSelectClear();
					trUnitSelect(""+x, true);
					trMutateSelected(kbGetProtoUnitID("Rocket"));
					trSetUnitOrientation(trVectorQuestVarGet("dir"),vector(0,1,0),true);
				}
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trMutateSelected(kbGetProtoUnitID("Shade of Hades"));
				for(x=1; <3) {
					trUnitSelectClear();
					trUnitSelectByQV("bossWarn"+x, true);
					trMutateSelected(kbGetProtoUnitID("Petosuchus Projectile"));
					trSetUnitOrientation(trVectorQuestVarGet("dir"),vector(0,1,0),true);
					trSetSelectedScale(3,0,60);
				}
				trQuestVarSet("bossSpell", 22);
				bossNext = trTimeMS() + 2000;
				trModifyProtounit("Shade of Hades", ENEMY_PLAYER, 55, 2);
			} else if (trQuestVarGet("bossSpell") == 22) {
				amt = bossNext - trTimeMS();
				if (amt < 0) {
					bossAnim = true;
					trMutateSelected(kbGetProtoUnitID("Shade of Hades"));
					trUnitOverrideAnimation(15,0,true,false,-1);
					for(x=1; <3) {
						trUnitSelectClear();
						trUnitSelectByQV("bossWarn"+x);
						trUnitChangeProtoUnit("Cinematic Block");
					}
					trSoundPlayFN("shadeofhadesacknowledge2.wav","1",-1,"","");
					bossTimeout = trTimeMS() + 9000;
					trQuestVarSet("bossLast", trTimeMS());
					trQuestVarSet("bossSpell", 23);
					for(x=trQuestVarGet("bossScreamStart"); < trQuestVarGet("bossScreamEnd")) {
						trUnitSelectClear();
						trUnitSelect(""+x, true);
						trMutateSelected(kbGetProtoUnitID("Vortex Start Linked"));
						trUnitSetAnimationPath("0,0,1,0,0,0,0");
					}
				} else {
					/* 0.3 is max. amt is 0 - 2000. 0.3 at 0 and 0 at 2000 */
					angle = 0.00015 * (2000 - amt);
					amt = amt * 0.001;
					trUnitSelectClear();
					trUnitSelectByQV("bossWarn1", true);
					trVectorSetFromAngle("dir", fModulo(6.283185, bossAngle - angle - 3.141592));
					trSetUnitOrientation(trVectorQuestVarGet("dir"),vector(0,1,0),true);
					trUnitSelectClear();
					trUnitSelectByQV("bossWarn2", true);
					trVectorSetFromAngle("dir", fModulo(6.283185, bossAngle + angle - 3.141592));
					trSetUnitOrientation(trVectorQuestVarGet("dir"),vector(0,1,0),true);
				}
			} else if (trQuestVarGet("bossSpell") == 23) {
				trUnitSelectClear();
				trUnitSelectByQV("bossTarget");
				if (trUnitAlive()) {
					trVectorSetUnitPos("pos", "bossTarget");
				} else {
					bossTarget = xDatabaseNext(dPlayerCharacters));
				}
				amt = trTimeMS() - trQuestVarGet("bossLast");
				trQuestVarSet("bossLast", trTimeMS());
				angle = fModulo(6.283185, bossAngle + amt * trQuestVarGet("bossMove") * 0.0003);
				bossAngle = angle;
				trVectorSetFromAngle("dir", angle);
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trSetUnitOrientation(trVectorQuestVarGet("dir"),vector(0,1,0),true);
				trVectorQuestVarSet("bossDestDir", zGetUnitVector("bossPos", "pos"));
				if (dotProduct("bossDestDir", "dir") < dotProduct("bossDir", "bossDestDir")) {
					trQuestVarSet("bossMove", 0.0 - trQuestVarGet("bossMove"));
				}
				trQuestVarSet("bossDirX", trQuestVarGet("dirX"));
				trQuestVarSet("bossDirZ", trQuestVarGet("dirZ"));
				trVectorSetFromAngle("bossDir1", angle - 0.3);
				trVectorSetFromAngle("bossDir2", angle + 0.3);
				angle = fModulo(6.283185, angle - 0.3);
				for(x=trQuestVarGet("bossScreamStart"); < trQuestVarGet("bossScreamEnd")) {
					trVectorSetFromAngle("dir", angle);
					trUnitSelectClear();
					trUnitSelect(""+x);
					trSetSelectedUpVector(5.0 * trQuestVarGet("dirx"),-1,5.0 * trQuestVarGet("dirz"));
					angle = angle + 0.1;
				}
				if (trTimeMS() > bossNext) {
					trCameraShake(0.5, 0.1);
					bossNext = 500 + bossNext;
					trQuestVarSetFromRand("sound", 1, 3, true);
					trSoundPlayFN("suckup"+1*trQuestVarGet("sound")+".wav","1",-1,"","");
					amt = dotProduct("bossDir1", "bossDir2");
					for(x=xGetDatabaseCount(dPlayerUnits); >0) {
						if (xDatabaseNext(dPlayerUnits, true) == -1 || trUnitAlive() == false) {
							removePlayerUnit();
						} else {
							trVectorSetUnitPos("pos", dPlayerUnits);
							trVectorQuestVarSet("dir", zGetUnitVector("bossPos", "pos"));
							if ((dotProduct("dir", "bossDir1") > amt &&
									dotProduct("dir", "bossDir2") > amt) ||
								zDistanceBetweenVectorsSquared("bossPos", "pos") < 9.0) {
								damagePlayerUnit(200);
								p = 1*yGetVar(dPlayerUnits,"player");
								if (trQuestVarGet(dPlayerUnits) == trQuestVarGet("p"+p+"unit")) {
									silencePlayer(p, 2.0);
									if (trCurrentPlayer() == p) {
										trCameraShake(0.5, 0.3);
									}
								}
							}
						}
					}
					if (trTimeMS() > bossTimeout) {
						bossAnim = false;
						trSetLighting("dawn", 1.0);
						trQuestVarSet("bossUltimate", 3);
						trSoundPlayFN("godpowerfailed.wav","1",-1,"","");
						trUnitSelectClear();
						trUnitSelect(""+bossUnit, true);
						trUnitOverrideAnimation(-1,0,false,true,-1);
						for(x=trQuestVarGet("bossScreamStart"); < trQuestVarGet("bossScreamEnd")) {
							trUnitSelectClear();
							trUnitSelect(""+x);
							trUnitChangeProtoUnit("Cinematic Block");
						}
						ySetVarAtIndex(dEnemies, "launched", 0, bossPointer);
						ySetPointer("stunnedUnits", 1*trQuestVarGet("bossStunIndex"));
						xFreeDatabaseBlock("stunnedUnits");
						bossAnim = false;
						trModifyProtounit("Shade of Hades", ENEMY_PLAYER, 55, 4);
						bossCooldown(12, 20);
					}
				}
			}
		} else if (trQuestVarGet("bossSpell") > 10) {
			if (trQuestVarGet("bossSpell") == 11) {
				trQuestVarSet("bossSpell", 12);
				bossCount = 3;
				bossAnim = true;
			} else if (trQuestVarGet("bossSpell") == 12) {
				if (trTimeMS() > bossNext) {
					trSoundPlayFN("shadeofhadesacknowledge2.wav","1",-1,"","");
					bossPos = kbGetBlockPosition(""+bossUnit, true);
					trQuestVarSetFromRand("rand", 1, xGetDatabaseCount(dPlayerCharacters), true);
					for(x=trQuestVarGet("rand"); >0) {
						xDatabaseNext(dPlayerCharacters);
					}
					trVectorSetUnitPos("bossTargetpos", dPlayerCharacters);
					vectorSnapToGrid("bossTargetpos");
					trVectorQuestVarSet("dir", zGetUnitVector("bossPos", "bossTargetpos"));
					trQuestVarSet("bossDirx", 0.0 - trQuestVarGet("dirx"));
					trQuestVarSet("bossDirz", 0.0 - trQuestVarGet("dirz"));
					trQuestVarSet("bossPosx", trQuestVarGet("bossTargetPosX") + 2.0 * trQuestVarGet("dirx"));
					trQuestVarSet("bossPosz", trQuestVarGet("bossTargetPosZ") + 2.0 * trQuestVarGet("dirz"));
					trQuestVarSet("next", trGetNextUnitScenarioNameNumber());
					trArmyDispatch("1,0","Dwarf",1,trQuestVarGet("bossPosx"),0,trQuestVarGet("bossPosz"),0,true);
					trArmySelect("1,0");
					trUnitConvert(ENEMY_PLAYER);
					trUnitChangeProtoUnit("Transport Ship Greek");
					trUnitSelectClear();
					trUnitSelect(""+bossUnit, true);
					trImmediateUnitGarrison(""+1*trQuestVarGet("next"));
					trUnitChangeProtoUnit("Shade of Hades");
					trUnitSelectClear();
					trUnitSelect(""+bossUnit, true);
					trMutateSelected(kbGetProtoUnitID("Shade of Hades"));
					trSetSelectedScale(bossScale,bossScale,bossScale);
					trUnitOverrideAnimation(1,0,false,false,-1);
					trSetUnitOrientation(bossDir,vector(0,1,0),true);
					trUnitSelectClear();
					trUnitSelectByQV("next", true);
					trUnitChangeProtoUnit("Kronny Birth SFX");
					trQuestVarSet("slashdirX", 0.0 - trQuestVarGet("dirZ"));
					trQuestVarSet("slashdirZ", trQuestVarGet("dirX"));
					trQuestVarSet("bossSlash", trGetNextUnitScenarioNameNumber());
					trArmyDispatch("1,0", "Dwarf",1,trQuestVarGet("bossTargetposx"),0,trQuestVarGet("bossTargetPosz"),0,true);
					trArmySelect("1,0");
					trSetUnitOrientation(trVectorQuestVarGet("slashDir"),vector(0,1,0),true);
					trUnitChangeProtoUnit("Cinematic Block");
					trQuestVarSet("bossSpell", 13);
					bossNext = trTimeMS() + 1000;
				} else {
					trSetUnitOrientation(bossDir,vector(0,1,0),true);
				}
			} else if (trQuestVarGet("bossSpell") == 13) {
				if (trTimeMS() > bossNext) {
					trUnitSelectClear();
					trUnitSelectByQV("bossSlash");
					trUnitChangeProtoUnit("Tartarian Gate Flame");
					trUnitSelectClear();
					trUnitSelectByQV("bossSlash");
					trSetSelectedScale(1,1,2);
					trQuestVarSet("bossTargetposX", trQuestVarGet("bossTargetposX") - 4.0 * trQuestVarGet("slashDirX"));
					trQuestVarSet("bossTargetposZ", trQuestVarGet("bossTargetposZ") - 4.0 * trQuestVarGet("slashDirZ"));
					for(x=xGetDatabaseCount(dPlayerUnits); >0) {
						if (xDatabaseNext(dPlayerUnits, true) == -1 || trUnitAlive() == false) {
							removePlayerUnit();
						} else if (rayCollision(dPlayerUnits, "bossTargetPos", "slashDir", 8.0, 2)) {
							damagePlayerUnit(500);
						}
					}
					bossNext = bossNext + 1000;
					bossCount = bossCount - 1;
					if (bossCount <= 0) {
						trQuestVarSet("bossSpell", 14);
					} else {
						trQuestVarSet("bossSpell", 12);
					}
				} else {
					trSetUnitOrientation(bossDir,vector(0,1,0),true);
				}
			} else if (trQuestVarGet("bossSpell") == 14) {
				if (trTimeMS() > bossNext) {
					trUnitOverrideAnimation(-1,0,false,true,-1);
					bossCooldown(10, 16);
					bossAnim = false;
				}
			}
		} else if (trQuestVarGet("bossSpell") > 0) {
			if (trQuestVarGet("bossSpell") == 1) {
				trSoundPlayFN("shadeofhadesselect2.wav","1",-1,"","");
				ySetVarAtIndex(dEnemies, "launched", 1, bossPointer);
				trQuestVarSetFromRand("rand", 1, xGetDatabaseCount(dPlayerCharacters), true);
				for(x=trQuestVarGet("rand"); >0) {
					xDatabaseNext(dPlayerCharacters);
				}
				trVectorSetUnitPos("pos", dPlayerCharacters);
				bossPos = kbGetBlockPosition(""+bossUnit, true);
				bossDir = zGetUnitVector("bossPos", "pos");
				trQuestVarSet("dirx", 0.0 - trQuestVarGet("bossDirx"));
				trQuestVarSet("dirz", 0.0 - trQuestVarGet("bossDirz"));
				trSetUnitOrientation(bossDir,vector(0,1,0),true);
				trMutateSelected(kbGetProtoUnitID("Transport Ship Greek"));
				trQuestVarSet("bossStunIndex", yAddToDatabase("stunnedUnits", "bossUnit"));
				yAddUpdateVar("stunnedUnits", "proto", kbGetProtoUnitID("Shade of Hades"));
				trUnitSelectClear();
				trUnitSelectByQV("bossWarn1", true);
				trMutateSelected(kbGetProtoUnitID("Dwarf"));
				trImmediateUnitGarrison(""+1*bossUnit);
				trUnitChangeProtoUnit("Dwarf");
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trMutateSelected(kbGetProtoUnitID("Shade of Hades"));
				trUnitSelectClear();
				trUnitSelectByQV("bossWarn1", true);
				trMutateSelected(kbGetProtoUnitID("Petosuchus Projectile"));
				trSetUnitOrientation(trVectorQuestVarGet("dir"),vector(0,1,0),true);
				trSetSelectedScale(3,0,60);
				trQuestVarSet("bossSpell", 2);
				bossNext = trTimeMS() + 1000;
			} else if (trQuestVarGet("bossSpell") == 2) {
				if (trTimeMS() > bossNext) {
					trSoundPlayFN("shadeofhadesacknowledge1.wav","1",-1,"","");
					ySetPointer("stunnedUnits", 1*trQuestVarGet("bossStunIndex"));
					xFreeDatabaseBlock("stunnedUnits");
					trImmediateUnitGarrison(""+1*trQuestVarGet("bossEscape"));
					trUnitSelectClear();
					trUnitSelectByQV("bossWarn1", true);
					trUnitChangeProtoUnit("Cinematic Block");
					addGenericProj("bossCloud","bossPos","bossDir",kbGetProtoUnitID("Kronny Birth SFX"),2,20,4.5);
					yAddUpdateVar("bossCloud", "prevX", trQuestVarGet("bossPosx"));
					yAddUpdateVar("bossCloud", "prevZ", trQuestVarGet("bossPosz"));
					trQuestVarSet("bossSpell", 3);
					bossNext = trTimeMS() + 7000;
					yClearDatabase("splatterUnits");
					for(x=xGetDatabaseCount(dPlayerUnits); >0) {
						xDatabaseNext(dPlayerUnits);
						yAddToDatabase("splatterUnits", dPlayerUnits);
						yAddUpdateVar("splatterUnits", "index", yGetPointer(dPlayerUnits));
					}
				}
			} else if (trQuestVarGet("bossSpell") == 3) {
				action = processGenericProj("bossCloud");
				if (action == PROJ_FALLING) {
					yVarToVector("bossCloud", "prev");
					yVarToVector("bossCloud", "dir");
					trQuestVarSet("nextx", trQuestVarGet("posx") + 2.0 * trQuestVarGet("dirx"));
					trQuestVarSet("nextz", trQuestVarGet("posz") + 2.0 * trQuestVarGet("dirz"));
					vectorToGrid("next", "loc");
					if (terrainIsType("loc", TERRAIN_WALL, TERRAIN_SUB_WALL)) {
						trVectorQuestVarSet("dir", getBounceDir("loc", "dir"));
						ySetVarFromVector("bossCloud", "dir", "dir");
						ySetVar("bossCloud", "yeehaw", 99);
						trVectorQuestVarSet("dir", wallNormalVector("loc"));
						amt = trQuestVarGet("dirZ");
						trQuestVarSet("dirZ", 0.0 - trQuestVarGet("dirX"));
						trQuestVarSet("dirX", amt);
						for(x=7; >0) {
							addGenericProj("bossBolts","prev","dir",kbGetProtoUnitID("Medusa"),40,9,5);
							yAddUpdateVar("bossBolts", "prevX", trQuestVarGet("prevX"));
							yAddUpdateVar("bossBolts", "prevZ", trQuestVarGet("prevZ"));
							trVectorQuestVarSet("dir", rotationMatrix("dir", 0.866025, 0.5));
						}
						
						yClearDatabase("splatterUnits");
						for(x=xGetDatabaseCount(dPlayerUnits); >0) {
							xDatabaseNext(dPlayerUnits);
							yAddToDatabase("splatterUnits", dPlayerUnits);
							yAddUpdateVar("splatterUnits", "index", yGetPointer(dPlayerUnits));
						}
						
						trSoundPlayFN("buildingdeath.wav","1",-1,"","");
						trCameraShake(0.5, 0.3);
						
						vectorToGrid("pos", "loc");
						if (terrainIsType("loc", TERRAIN_WALL, TERRAIN_SUB_WALL)) {
							bossNext = trTimeMS();
							debugLog("Whoops! We entered the ZONE");
						}
					} else {
						dist = zDistanceBetweenVectors("pos", "prev");
						for(x=xGetDatabaseCount("splatterUnits"); >0) {
							if (xDatabaseNext("splatterUnits", true) == -1 || trUnitAlive() == false) {
								xFreeDatabaseBlock("splatterUnits");
							} else if (rayCollision("splatterUnits", "prev", "dir", dist + 1.0, 4.0)) {
								damagePlayerUnit(500, 1*yGetVar("splatterUnits", "index"));
								trQuestVarSetFromRand("splatterSound", 1, 2, true);
								xFreeDatabaseBlock("splatterUnits");
							}
						}
						if (trQuestVarGet("splatterSound") > 0) {
							trSoundPlayFN("titanpunch"+1*trQuestVarGet("splatterSound")+".wav","1",-1,"","");
							trQuestVarSet("splatterSound", 0);
						}
						ySetVarFromVector("bossCloud", "prev", "pos");
					}
				}
				if (action == PROJ_REMOVE || trTimeMS() > bossNext) {
					if (action != PROJ_REMOVE) {
						yVarToVector("bossCloud", "prev");
						trQuestVarSet("bossPosX", trQuestVarGet("prevX"));
						trQuestVarSet("bossPosZ", trQuestVarGet("prevZ"));
						trUnitSelectClear();
						trUnitSelectByQV("bossCloud", true);
						trUnitChangeProtoUnit("Kronny Birth SFX");
						xFreeDatabaseBlock("bossCloud");
					}
					trQuestVarSet("next", trGetNextUnitScenarioNameNumber());
					trArmyDispatch("1,0","Dwarf",1,trQuestVarGet("bossposX"),0,trQuestVarGet("bossposZ"),0,true);
					trArmySelect("1,0");
					trUnitConvert(ENEMY_PLAYER);
					trSetUnitOrientation(trVectorQuestVarGet("dir"),vector(0,1,0),true);
					trUnitChangeProtoUnit("Transport Ship Greek");
					trUnitSelectClear();
					trUnitSelect(""+bossUnit, true);
					trUnitChangeProtoUnit("Shade of Hades");
					trUnitSelectClear();
					trUnitSelect(""+bossUnit, true);
					trImmediateUnitGarrison(""+1*trQuestVarGet("next"));
					trUnitChangeProtoUnit("Shade of Hades");
					trUnitSelectClear();
					trUnitSelect(""+bossUnit, true);
					trMutateSelected(kbGetProtoUnitID("Shade of Hades"));
					trSetSelectedScale(bossScale, bossScale, bossScale);
					trUnitSelectClear();
					trUnitSelectByQV("next");
					trUnitChangeProtoUnit("Kronny Birth SFX");
					bossCooldown(10, 15);
					ySetVarAtIndex(dEnemies, "launched", 0, bossPointer);
				}
			}
		} else if (xGetInt(dEnemies, xStunStatus, bossPointer) == 0) {
			trQuestVarSetFromRand("bossSpell", 0, xsMin(2, (trUnitPercentDamaged() * 0.05)), true);
			trQuestVarSet("bossSpell", trQuestVarGet("bossSpell") * 10 + 1);
			if (trQuestVarGet("bossSpell") == 21 && trQuestVarGet("bossUltimate") > 0) {
				trQuestVarSetFromRand("bossSpell", 0, 2, true);
				trQuestVarSet("bossSpell", 1 + 10 * trQuestVarGet("bossSpell"));
			}
		}
	} else {
		trUnitOverrideAnimation(-1,0,false,true,-1);
		xsDisableSelf();
		trMusicStop();
		boss = 0;
		trSetLighting("default", 1.0);
		trSoundPlayFN("win.wav","1",-1,"","");
		for(x=xGetDatabaseCount(dEnemies); >0) {
			xDatabaseNext(dEnemies, true);
			trDamageUnitPercent(100);
		}
		uiLookAtUnitByName(""+bossUnit);
		xsEnableRule("boss_ded");
		xsDisableRule("gameplay_always");
	}
}

rule yeebaagooon_battle
inactive
highFrequency
{
	trUnitSelectClear();
	trUnitSelect(""+bossUnit, true);
	int p = 0;
	int x = 0;
	int z = 0;
	int action = 0;
	int id = 0;
	float amt = 0;
	float dist = 0;
	float angle = 0;
	bool hit = false;
	if (trUnitAlive() == true) {
		if (trQuestVarGet("bossSpell") == BOSS_SPELL_COOLDOWN) {
			processBossCooldown();
			if (trQuestVarGet("bossSpell") == BOSS_SPELL_COOLDOWN) {
				if (trUnitPercentDamaged() > trQuestVarGet("yeebNextInvulnerabilityPhase")) {
					trQuestVarSet("bossSpell", 51);
					trQuestVarSet("yeebNextInvulnerabilityPhase", trQuestVarGet("yeebNextInvulnerabilityPhase") + 20);
				}
			}
		} else if (trQuestVarGet("bossSpell") > 50) {
			if (trQuestVarGet("bossSpell") == 51) {
				trQuestVarSetFromRand("rand", 1, 5, true);
				if (trQuestVarGet("rand") == 1) {
					trChatSendSpoofed(ENEMY_PLAYER, "Yeebaagooon: Invincibility Shield");
				} else if (trQuestVarGet("rand") == 2) {
					trChatSendSpoofed(ENEMY_PLAYER, "Yeebaagooon: *Yawns*");
				} else if (trQuestVarGet("rand") == 3) {
					trChatSendSpoofed(ENEMY_PLAYER, "Yeebaagooon: You can't touch me.");
				}
				trSoundPlayFN("bronzebirth.wav","1",-1,"","");
				trMessageSetText("Destroy the obelisks to break Yeebaagooon's shield.", -1);
				if (kbGetBlockID(""+1*trQuestVarGet("yeebShieldSFX")) == -1) {
					trQuestVarSet("bossSpell", 52);
					spyEffect(1*trQuestVarGet("yeebaagooon"),kbGetProtoUnitID("Cinematic Block"),"yeebShieldSFX");
				} else {
					trUnitSelectClear();
					trUnitSelectByQV("yeebShieldSFX", true);
					trMutateSelected(kbGetProtoUnitID("Phoenix Egg"));
					trSetSelectedScale(2,2,2);
					trQuestVarSet("bossSpell", 53);
				}
				
				ySetVarAtIndex(dEnemies, "physicalResist", 1, bossPointer);
				ySetVarAtIndex(dEnemies, "magicResist", 1, bossPointer);
				trModifyProtounit("Pharaoh of Osiris XP", ENEMY_PLAYER, 24, 1);
				trModifyProtounit("Pharaoh of Osiris XP", ENEMY_PLAYER, 25, 1);
				trModifyProtounit("Pharaoh of Osiris XP", ENEMY_PLAYER, 26, 1);
				
				trQuestVarSetFromRand("bossDirection", 0, 1, true);
				bossCount = 9;
				bossNext = trTimeMS();
				trQuestVarSet("lower", trQuestVarGet("bossRoomLowerX") + 2);
				amt = trQuestVarGet("bossRoomUpperX") - trQuestVarGet("bossRoomLowerX") - 6;
				for(x=0; <= 1) {
					for(z=0; <= 1) {
						trQuestVarSet("next", trGetNextUnitScenarioNameNumber());
						trArmyDispatch("1,0","Dwarf",1,trQuestVarGet("lower") + amt * x, 0, trQuestVarGet("lower") + amt * z, 0, true);
						trUnitSelectClear();
						trUnitSelectByQV("next", true);
						trUnitConvert(ENEMY_PLAYER);
						trUnitChangeProtoUnit("Outpost");
						yAddToDatabase("yeebObelisks", "next");
					}
				}
			} else if (trQuestVarGet("bossSpell") == 52) {
				if (trQuestVarGet("spyfind") == trQuestVarGet("spyfound")) {
					trUnitSelectClear();
					trUnitSelectByQV("yeebShieldSFX", true);
					trMutateSelected(kbGetProtoUnitID("Phoenix Egg"));
					trSetSelectedScale(2,2,2);
					trQuestVarSet("bossSpell", 53);
				}
			} else if (trQuestVarGet("bossSpell") >= 53) {
				xDatabaseNext("yeebObelisks", true);
				if (trUnitAlive() == false) {
					xFreeDatabaseBlock("yeebObelisks");
					if (xGetDatabaseCount("yeebObelisks") == 0) {
						bossCooldown(1, 2);
						ySetVarAtIndex(dEnemies, "physicalResist", 0.47, bossPointer);
						ySetVarAtIndex(dEnemies, "magicResist", 0.47, bossPointer);
						trModifyProtounit("Pharaoh of Osiris XP", ENEMY_PLAYER, 24, -0.53);
						trModifyProtounit("Pharaoh of Osiris XP", ENEMY_PLAYER, 25, -0.53);
						trModifyProtounit("Pharaoh of Osiris XP", ENEMY_PLAYER, 26, -0.53);
					}
				}
				if (trTimeMS() > bossNext) {
					if (trQuestVarGet("bossSpell") == 53) {
						bossNext = bossNext + 1000;
						for(x=xGetDatabaseCount(dPlayerCharacters); >0) {
							if (xDatabaseNext(dPlayerCharacters, true) == -1 || trUnitAlive() == false) {
								removePlayerCharacter();
							} else {
								trVectorSetUnitPos("pos", dPlayerCharacters);
								vectorSnapToGrid("pos");
								spawnLightning("pos", ENEMY_PLAYER);
							}
						}
						bossCount = bossCount - 1;
						if (bossCount == 0) {
							trQuestVarSet("bossSpell", 54);
							trQuestVarSet("bossDirection", 1 - trQuestVarGet("bossDirection"));
							trQuestVarSet("lightningLineCount", (trQuestVarGet("bossRoomUpperX") - trQuestVarGet("bossRoomLowerX")) / 4);
							trQuestVarSet("lightningLineStartx", trQuestVarGet("bossRoomUpperx") - 1);
							trQuestVarSet("lightningLineStartz", trQuestVarGet("bossRoomUpperz") - 1);
							if (trQuestVarGet("bossDirection") == 1) {
								trQuestVarSet("linedirx", -4);
								trQuestVarSet("linedirz", 0);
								trQuestVarSet("lineMovex", 0);
								trQuestVarSet("lineMovez", -2);
							} else if (trQuestVarGet("bossDirection") == 0) {
								trQuestVarSet("linedirx", 0);
								trQuestVarSet("linedirz", -4);
								trQuestVarSet("lineMovex", -2);
								trQuestVarSet("lineMovez", 0);
							}
						}
					} else {
						while(trTimeMS() > bossNext) {
							bossNext = trTimeMS() + 100;
							trQuestVarSet("posx", trQuestVarGet("lightningLineStartx"));
							trQuestVarSet("posz", trQuestVarGet("lightningLineStartz"));
							for(x=trQuestVarGet("lightningLineCount"); >0) {
								spawnLightning("pos", ENEMY_PLAYER);
								trQuestVarSet("posx", trQuestVarGet("posx") + trQuestVarGet("linedirx"));
								trQuestVarSet("posz", trQuestVarGet("posz") + trQuestVarGet("linedirz"));
							}
							trQuestVarSet("lightningLineStartx", trQuestVarGet("lightningLineStartx") + trQuestVarGet("lineMovex"));
							trQuestVarSet("lightningLineStartz", trQuestVarGet("lightningLineStartz") + trQuestVarGet("lineMovez"));
							vectorToGrid("lightningLineStart", "loc");
							if (terrainIsType("loc", TERRAIN_WALL, TERRAIN_SUB_WALL)) {
								trQuestVarSet("bossSpell", 53);
								bossCount = 10;
								break;
							}
						}
					}
				}
			}
		} else if (trQuestVarGet("bossSpell") > 30) {
			if (trQuestVarGet("bossSpell") == 31) {
				trSoundPlayFN("cinematics\15_in\gong.wav","1",-1,"","");
				trSoundPlayFN("godpower.wav","1",-1,"","");
				trOverlayText("The Banhammer", 3.0, -1, -1, -1);
				trSetLighting("night", 1.0);
				trSoundPlayFN("meteorapproach.wav","1",-1,"","");
				trQuestVarSet("bossSpell", 32);
				bossNext = trTimeMS() + 3000;
				xDatabaseNext(dPlayerCharacters);
				trVectorSetUnitPos("hammerPos", dPlayerCharacters);
				trVectorQuestVarSet("dir", vector(0,0,-16));
				trQuestVarSet("heading", 360);
				trQuestVarSet("hammerIndicatorsStart", trGetNextUnitScenarioNameNumber());
				for(x=8; >0) {
					trQuestVarSet("posx", trQuestVarGet("hammerPosx") + trQuestVarGet("dirx"));
					trQuestVarSet("posz", trQuestVarGet("hammerPosz") + trQuestVarGet("dirz"));
					vectorToGrid("pos", "loc");
					if (terrainIsType("loc", TERRAIN_WALL, TERRAIN_SUB_WALL) == false) {
						trArmyDispatch("1,0","Dwarf",1,trQuestVarGet("posx"),0,trQuestVarGet("posz"),trQuestVarGet("heading"),true);
						trArmySelect("1,0");
						trUnitChangeProtoUnit("UI Range Indicator Egypt SFX");
					}
					trQuestVarSet("heading", trQuestVarGet("heading") - 45);
					trVectorQuestVarSet("dir", rotationMatrix("dir", 0.707107, 0.707107));
				}
				trQuestVarSet("hammerIndicatorsEnd", trGetNextUnitScenarioNameNumber());
			} else if (trQuestVarGet("bossSpell") == 32) {
				if (trTimeMS() > bossNext) {
					trQuestVarSet("bossSpell", 33);
					zSetProtoUnitStat("Kronny Flying", 0, 1, 0.001);
					trQuestVarSet("hammerObject", trGetNextUnitScenarioNameNumber());
					trArmyDispatch("1,0","Kronny Flying",1,trQuestVarGet("hammerPosx"),0,trQuestVarGet("hammerPosz"),0,true);
					trUnitSelectClear();
					trUnitSelectByQV("hammerObject", true);
					trUnitConvert(0);
					trUnitSelectClear();
					trUnitSelectByQV("hammerObject", true);
					trSetSelectedScale(0,15,0);
					trDamageUnitPercent(100);
				}
			} else if (trQuestVarGet("bossSpell") == 33) {
				trQuestVarSet("bossSpell", 34);
			} else if (trQuestVarGet("bossSpell") == 34) {
				trUnitSelectClear();
				trUnitSelectByQV("hammerObject", true);
				if (trUnitDead()) {
					bossNext = trTimeMS() + 1000;
					trQuestVarSet("bossSpell", 35);
					trMutateSelected(kbGetProtoUnitID("Thor Hammer"));
					trSetSelectedScale(2,-2,2);
					trUnitOverrideAnimation(2,0,true,false,-1);
					trUnitSetAnimationPath("0,0,0,0,0,0,0");
				}
			} else if (trQuestVarGet("bossSpell") == 35) {
				if (trTimeMS() > bossNext) {
					trQuestVarSet("bossSpell", 36);
					bossCount = 0;
					trQuestVarSet("bossRadius", 0);
					trSoundPlayFN("meteordustcloud.wav","1",-1,"","");
					trSoundPlayFN("cinematics\35_out\strike.mp3","1",-1,"","");
					trCameraShake(1.0, 0.5);
					bossDir = vector(1,0,0);
					for(x=trQuestVarGet("hammerIndicatorsStart"); < trQuestVarGet("hammerIndicatorsEnd")) {
						trUnitSelectClear();
						trUnitSelect(""+x, true);
						trUnitDestroy();
					}
				}
			} else if (trQuestVarGet("bossSpell") == 36) {
				if (trTimeMS() > bossNext) {
					bossNext = trTimeMS() + 200;
					bossCount = 1 + bossCount;
					angle = 3.141592 / bossCount;
					trQuestVarSet("cos", xsCos(angle));
					trQuestVarSet("sin", xsSin(angle));
					for(x=bossCount*2; >0) {
						bossDir = rotationMatrix("bossDir", trQuestVarGet("cos"), trQuestVarGet("sin"));
						trQuestVarSet("posx", trQuestVarGet("bossDirx") * trQuestVarGet("bossRadius") + trQuestVarGet("hammerPosx"));
						trQuestVarSet("posz", trQuestVarGet("bossDirz") * trQuestVarGet("bossRadius") + trQuestVarGet("hammerPosz"));
						trArmyDispatch("1,0","Meteor Impact Ground",1,trQuestVarGet("posx"),0,trQuestVarGet("posz"),0,true);
					}
					trQuestVarSet("bossRadius", trQuestVarGet("bossRadius") + 4);
					dist = xsPow(trQuestVarGet("bossRadius"), 2);
					for(x=xGetDatabaseCount(dPlayerUnits); >0) {
						if (xDatabaseNext(dPlayerUnits, true) == -1 || trUnitAlive() == false) {
							removePlayerUnit();
						} else if (zDistanceToVectorSquared(dPlayerUnits, "hammerPos") < dist) {
							damagePlayerUnit(999);
						}
					}
					
					if (boss > 999) {
						for(x=xGetDatabaseCount(dEnemies); >0) {
							if (xDatabaseNext(dEnemies, true) == -1 || trUnitAlive() == false) {
								removeEnemy();
							} else if (zDistanceToVectorSquared(dEnemies, "hammerPos") < dist) {
								damageEnemy(0, 999);
								damageEnemy(0, 999, false);
							}
						}
					}
					
					if (bossCount == 4) {
						trSetLighting("anatolia", 1.0);
						bossCooldown(12, 16);
						trQuestVarSet("bossUltimate", 3);
					}
				}
			}
		} else if (trQuestVarGet("bossSpell") > 20) {
			if (trQuestVarGet("bossSpell") == 21) {
				trQuestVarSetFromRand("rand", 1, 5, true);
				if (trQuestVarGet("rand") == 1) {
					trChatSendSpoofed(ENEMY_PLAYER, "Yeebaagooon: Shockwave");
				} else if (trQuestVarGet("rand") == 2) {
					trChatSendSpoofed(ENEMY_PLAYER, "Yeebaagooon: Don't be shocked about this one.");
				} else if (trQuestVarGet("rand") == 3) {
					trChatSendSpoofed(ENEMY_PLAYER, "Yeebaagooon: Lightning has many interesting properities.");
				}
				trVectorSetUnitPos("start", "yeebaagooon");
				trQuestVarSetFromRand("angle", 0, 3.14, false);
				trVectorSetFromAngle("dir", trQuestVarGet("angle"));
				for(x=8; >0) {
					addGenericProj("yeebLightningBalls","start","dir",kbGetProtoUnitID("Arkantos God"),26,10,5);
					yAddUpdateVar("yeebLightningBalls", "prevx", trQuestVarGet("startx"));
					yAddUpdateVar("yeebLightningBalls", "prevz", trQuestVarGet("startz"));
					yAddUpdateVar("yeebLightningBalls", "bounces", 3);
					yAddUpdateVar("yeebLightningBalls","player",ENEMY_PLAYER);
					trVectorQuestVarSet("dir", rotationMatrix("dir", 0.707107, 0.707107));
				}
				bossCooldown(6, 12);
			}
		} else if (trQuestVarGet("bossSpell") > 10) {
			if (trQuestVarGet("bossSpell") == 11) {
				trQuestVarSetFromRand("rand", 1, 5, true);
				if (trQuestVarGet("rand") == 1) {
					trChatSendSpoofed(ENEMY_PLAYER, "Yeebaagooon: Lightning Cage");
				} else if (trQuestVarGet("rand") == 2) {
					trChatSendSpoofed(ENEMY_PLAYER, "Yeebaagooon: Time to die~");
				} else if (trQuestVarGet("rand") == 3) {
					trChatSendSpoofed(ENEMY_PLAYER, "Yeebaagooon: Can you escape this?");
				}
				trQuestVarSetFromRand("rand", 1, xGetDatabaseCount(dPlayerCharacters), true);
				for(x=trQuestVarGet("rand"); >0) {
					xDatabaseNext(dPlayerCharacters);
				}
				trVectorSetUnitPos("cageCenter", dPlayerCharacters);
				vectorSnapToGrid("cageCenter");
				trQuestVarSet("cageCount", 12);
				trQuestVarSet("cageRadius", 6);
				trQuestVarSet("bossSpell", 12);
				bossNext = trTimeMS();
			} else if (trQuestVarGet("bossSpell") == 12) {
				if (trTimeMS() > bossNext) {
					bossNext = trTimeMS() + 100;
					trQuestVarSet("dirx", 2 * trQuestVarGet("cageRadius"));
					trQuestVarSet("dirz", 2 * trQuestVarGet("cageCount") - trQuestVarGet("dirx"));
					for(x=4; >0) {
						trQuestVarSet("posx", trQuestVarGet("dirx") + trQuestVarGet("cageCenterx"));
						trQuestVarSet("posz", trQuestVarGet("dirz") + trQuestVarGet("cageCenterz"));
						spawnLightning("pos", ENEMY_PLAYER);
						vectorRotate90Deg("dir");
					}
					trQuestVarSet("cageCount", trQuestVarGet("cageCount") - 1);
					if (trQuestVarGet("cageCount") == 0) {
						trQuestVarSet("cageRadius", trQuestVarGet("cageRadius") - 1);
						trQuestVarSet("cageCount", trQuestVarGet("cageRadius") * 2);
						if (trQuestVarGet("cageRadius") <= 0) {
							bossCooldown(6, 12);
							if (boss > 999) {
								/* phase 2 */
								trQuestVarSet("boat", trGetNextUnitScenarioNameNumber());
								trArmyDispatch("1,0","Dwarf",1,trQuestVarGet("cageCenterx"),0,trQuestVarGet("cageCenterz"),0,true);
								trUnitSelectClear();
								trUnitSelectByQV("boat", true);
								trUnitConvert(0);
								trUnitChangeProtoUnit("Transport Ship Greek");
								trUnitSelectClear();
								trUnitSelectByQV("yeebBird", true);
								trImmediateUnitGarrison(""+1*trQuestVarGet("boat"));
								trUnitChangeProtoUnit("Dwarf");
								trUnitSelectClear();
								trUnitSelectByQV("yeebBird", true);
								trMutateSelected(kbGetProtoUnitID("Stymphalian Bird"));
								trSetSelectedScale(0,0,0);
								trUnitSelectClear();
								trUnitSelectByQV("boat", true);
								trUnitChangeProtoUnit("Hero Birth");
							}
						}
					}
				}
			}
		} else if (trQuestVarGet("bossSpell") > 0) {
			/* zappy zap */
			if (trQuestVarGet("bossSpell") == 1) {
				trQuestVarSetFromRand("rand", 1, 5, true);
				if (trQuestVarGet("rand") == 1) {
					trChatSendSpoofed(ENEMY_PLAYER, "Yeebaagooon: Zappy Zap");
				} else if (trQuestVarGet("rand") == 2) {
					trChatSendSpoofed(ENEMY_PLAYER, "Yeebaagooon: Relics begone!");
				} else if (trQuestVarGet("rand") == 3) {
					trChatSendSpoofed(ENEMY_PLAYER, "Yeebaagooon: Want to see a magic trick?");
				}
				trQuestVarSet("bossSpell", 2);
				bossTimeout = trTimeMS() + 500;
				bossNext = 500;
				trQuestVarSet("zappyStart", trQuestVarGet("yeebaagooon"));
				z = 0;
				for(x=1; < ENEMY_PLAYER) {
					if (trQuestVarGet("p"+x+"dead") == 0) {
						z = z + 1;
						trQuestVarSet("choose"+z, x);
					}
				}
				trQuestVarSetFromRand("zappyTarget", 1, z, true);
				p = trQuestVarGet("choose"+1*trQuestVarGet("zappyTarget"));
				trQuestVarSet("zappyTarget", p);
				trQuestVarSet("zappyEnd", trQuestVarGet("p"+p+"unit"));
				trQuestVarSet("zappyIndex", yGetPointer(dPlayerUnits));
			} else if (trQuestVarGet("bossSpell") == 2) {
				if (bossTimeout - trTimeMS() < bossNext) {
					bossNext = bossNext - 100;
					trVectorSetUnitPos("start", "zappyStart");
					trVectorSetUnitPos("end", "zappyEnd");
					dist = bossNext / 500;
					trQuestVarSet("posx", dist * (trQuestVarGet("startx") - trQuestVarGet("endx")) + trQuestVarGet("endx"));
					trQuestVarSet("posz", dist * (trQuestVarGet("startz") - trQuestVarGet("endz")) + trQuestVarGet("endz"));
					trArmyDispatch("1,0","Dwarf",1,trQuestVarGet("posx"),0,trQuestVarGet("posz"),0,true);
					trArmySelect("1,0");
					trUnitChangeProtoUnit("Lightning sparks Ground");
					if (bossNext <= 0) {
						if (boss > 999) {
							trQuestVarSet("next", trGetNextUnitScenarioNameNumber());
							trArmyDispatch("1,0","Dwarf",1,trQuestVarGet("posx"),0,trQuestVarGet("posz"),0,true);
							trArmySelect("1,0");
							trUnitChangeProtoUnit("Relic");
							yAddToDatabase("freeRelics", "next");
							yAddUpdateVar("freeRelics", "type", RELIC_MAGIC_DETECTOR);
						}
						trUnitSelectClear();
						trUnitSelectByQV("zappyEnd", true);
						trUnitHighlight(0.2, false);
						damagePlayerUnit(150, 1*trQuestVarGet("zappyIndex"));
						p = trQuestVarGet("zappyTarget");
						action = trQuestVarGet("p"+p+"class");
						trUnitChangeProtoUnit(kbGetProtoUnitName(1*trQuestVarGet("class"+action+"proto")));
						trQuestVarSetFromRand("sound", 1, 5, true);
						trSoundPlayFN("lightningstrike"+1*trQuestVarGet("sound")+".wav","1",-1,"","");
						gainFavor(p, -5.0);
						if (trCurrentPlayer() == p) {
							trChatSend(0, "<color=1,1,1>Yeebaagooon has ejected all of your relics!");
						}
						
						bossCooldown(6, 12);
					}
				}
			}
		} else if (boss > 999) {
			/* phase 2 */
			trQuestVarSetFromRand("bossSpell", 0, 3, true);
			trQuestVarSet("bossSpell", 1 + 10 * trQuestVarGet("bossSpell"));
		} else if (xGetInt(dEnemies, xStunStatus, bossPointer) == 0) {
			trQuestVarSetFromRand("bossSpell", 0, xsMin(5, (trUnitPercentDamaged() * 0.05)), true);
			trQuestVarSet("bossSpell", trQuestVarGet("bossSpell") * 10 + 1);
			if (trQuestVarGet("bossSpell") == 21 && trQuestVarGet("bossUltimate") > 0) {
				trQuestVarSetFromRand("bossSpell", 0, 2, true);
				trQuestVarSet("bossSpell", 1 + 10 * trQuestVarGet("bossSpell"));
			}
		}
	} else {
		xsDisableSelf();
		xsDisableRule("boss_music");
		xsEnableRule("yeebaagooon_ded");
		
		trMusicStop();
		trSetLighting("anatolia", 1.0);
		
		uiLookAtUnitByName(""+bossUnit);
	}
	
	if (trQuestVarGet("gameOverStep") > 0) {
		trQuestVarSet("gameOverStep", 7);
		trQuestVarSet("yeebhit", 0);
		for(x=xGetDatabaseCount("yeebRelics"); >0) {
			xDatabaseNext("yeebRelics", true);
			trUnitDestroy();
		}
		for(p=1; < ENEMY_PLAYER) {
			for(x=xGetDatabaseCount("p"+p+"relics"); >0) {
				if (xDatabaseNext("p"+p+"relics", true) == -1) {
					xFreeDatabaseBlock("p"+p+"relics");
				}
			}
		}
		xsDisableSelf();
	}
}

rule yeebaagooon_ded
inactive
highFrequency
{
	int x = 0;
	if (trTime() > trQuestVarGet("yeebOverNext")) {
		trQuestVarSet("yeebOverStep", 1 + trQuestVarGet("yeebOverStep"));
		switch(1*trQuestVarGet("yeebOverStep"))
		{
			case 1:
			{
				trSetUnitIdleProcessing(false);
				trUIFadeToColor(0,0,0,1000,0,true);
				trLetterBox(true);
				trQuestVarSet("yeebOverNext", trTime() + 2);
			}
			case 2:
			{
				if (boss == 1) {
					trPaintTerrain(30, 10, 32, 30, TERRAIN_PRIMARY, TERRAIN_SUB_PRIMARY, false);
					trPaintTerrain(10, 30, 30, 32, TERRAIN_PRIMARY, TERRAIN_SUB_PRIMARY, false);
					trChangeTerrainHeight(31, 10, 32, 32, worldHeight, false);
					trChangeTerrainHeight(10, 31, 32, 32, worldHeight, false);
				} else {
					trPaintTerrain(trQuestVarGet("bossRoomEntranceX"), trQuestVarGet("bossRoomEntranceZ") - 3,
						trQuestVarGet("bossRoomEntranceX") + 35, trQuestVarGet("bossRoomEntranceZ"),
						TERRAIN_PRIMARY, TERRAIN_SUB_PRIMARY);
					trChangeTerrainHeight(trQuestVarGet("bossRoomEntranceX"), trQuestVarGet("bossRoomEntranceZ") - 3,
						trQuestVarGet("bossRoomEntranceX") + 35, trQuestVarGet("bossRoomEntranceZ"),worldHeight,false);
					trPaintTerrain(trQuestVarGet("bossRoomEntranceX")-4, trQuestVarGet("bossRoomEntranceZ"),
						trQuestVarGet("bossRoomEntranceX"), trQuestVarGet("bossRoomEntranceZ") + 35,
						TERRAIN_PRIMARY, TERRAIN_SUB_PRIMARY);
					trChangeTerrainHeight(trQuestVarGet("bossRoomEntranceX") - 3, trQuestVarGet("bossRoomEntranceZ"),
						trQuestVarGet("bossRoomEntranceX"), trQuestVarGet("bossRoomEntranceZ") + 35,worldHeight,false);
				}
				trPaintTerrain(0,0,5,5,0,70,true);
				trPaintTerrain(0,0,5,5,TERRAIN_WALL,TERRAIN_SUB_WALL,false);
				trPlayerSetDiplomacy(ENEMY_PLAYER, 0, "Enemy");
				trSoundPlayFN("","1",-1,"Yeebaagooon: Blargh, I am dead.","icons\special e son of osiris icon 64");
				trQuestVarSet("yeebOverNext", trTime() + 4);
				trUnitSelectClear();
				trUnitSelectByQV("yeebaagooon", true);
				trUnitDestroy();
			}
			case 3:
			{
				trSoundPlayFN("","1",-1,"Yeebaagooon: Just kidding. Did you think you were the only ones who could revive?",
					"icons\special e son of osiris icon 64");
				trQuestVarSet("yeebOverNext", trTime() + 6);
				trQuestVarSet("yeebBird", trGetNextUnitScenarioNameNumber());
				trArmyDispatch("1,0","Stymphalian Bird",1,trQuestVarGet("yeebPosx"),0,trQuestVarGet("yeebPosz"),0,true);
				trUnitSelectClear();
				trUnitSelectByQV("yeebBird", true);
				trTechGodPower(ENEMY_PLAYER, "spy", 1);
				trTechInvokeGodPower(ENEMY_PLAYER,"spy",vector(1,1,1),vector(1,1,1));
				x = modularCounterNext("spyFind");
				trQuestVarSet("spyEye"+x, kbGetProtoUnitID("Pharaoh of Osiris"));
				trQuestVarSet("spyEye"+x+"unit", trQuestVarGet("yeebBird"));
				trStringQuestVarSet("spyName"+x, "yeebaagooon");
			}
			case 4:
			{
				trQuestVarSet("yeebBirdID", kbGetBlockID(""+1*trQuestVarGet("yeebBird")));
				trUnitSelectClear();
				trUnitSelectByQV("yeebaagooon", true);
				trUnitOverrideAnimation(33,0,true,false,-1);
				trUnitSelectClear();
				trUnitSelectByQV("yeebBird", true);
				trUnitConvert(0);
				trSetSelectedScale(0,0,0);
				trSetUnitIdleProcessing(true);
				trLetterBox(false);
				trUIFadeToColor(0,0,0,1000,0,false);
				trSoundPlayFN("herorevived.wav","1",-1,"","");
				uiLookAtUnitByName(""+1*trQuestVarGet("yeebBird"));
				trQuestVarSet("yeebOverNext", trTime() + 3);
				trChatSendSpoofed(ENEMY_PLAYER, "Yeebaagooon: Now, die!");
			}
			case 5:
			{
				bossUnit = trGetNextUnitScenarioNameNumber();
				trArmyDispatch("1,0","Dwarf",1,1,0,1,0,true);
				trArmySelect("1,0");
				trUnitChangeProtoUnit("Cinematic Block");
				xsEnableRule("yeebaagooon_battle");
				bossCooldown(10, 12);
				trQuestVarSet("musicTime", 0);
				xsEnableRule("boss_music");
				trVectorQuestVarSet("yeebDir", vector(1,0,0));
				trQuestVarSet("yeebLightningNext", trTimeMS());
				if (boss == 1) {
					trQuestVarSet("yeebBossFight", 0);
					trQuestVarSet("boss", 1000);
					trMessageSetText("Reach the boss room to escape. You will get to keep the stolen relic.", 60);
					trVectorQuestVarSet("yeebDestination", trVectorQuestVarGet("bossRoomCenter"));
				} else {
					trQuestVarSet("boss", 1001);
					trMessageSetText("Return to the starting room to escape. You will get to keep the stolen relic.", 60);
					trVectorQuestVarSet("yeebDestination", trVectorQuestVarGet("startPosition"));
				}
				trQuestVarSet("yeebLatestFeather", trGetNextUnitScenarioNameNumber() - 1);
				trMinimapFlare(trCurrentPlayer(), 60, trVectorQuestVarGet("yeebDestination"), true);
				trSoundPlayFN("xnew_objective.wav","1",-1,"","");
				xsEnableRule("yeebaagooon_battle_2");
				xsDisableSelf();
			}
		}
	}
}

rule yeebaagooon_battle_2
inactive
highFrequency
{
	bool hit = false;
	int id = 0;
	if (kbUnitGetAnimationActionType(1*trQuestVarGet("yeebBirdID")) == 9) {
		if (trTime() > trQuestVarGet("yeebBirdMoveTime")) {
			trQuestVarSet("yeebBirdMoveTime", trTime());
			xDatabaseNext(dPlayerUnits);
			trVectorSetUnitPos("pos", dPlayerUnits);
			trUnitSelectClear();
			trUnitSelectByQV("yeebBird", true);
			trUnitMoveToPoint(trQuestVarGet("posx"),0,trQuestVarGet("posz"),-1,true);
		}
	}
	
	if (xGetDatabaseCount("yeebFeathers") > 0) {
		hit = false;
		id = xDatabaseNext("yeebFeathers", true);
		if (id == -1) {
			yVarToVector("yeebFeathers", "pos");
			hit = true;
		} else {
			trVectorSetUnitPos("pos", "yeebFeathers");
			if (trQuestVarGet("posY") < worldHeight + 0.5) {
				hit = true;
			} else {
				ySetVarFromVector("yeebFeathers", "pos", "pos");
			}
		}
		
		if (hit) {
			spawnLightning("pos", ENEMY_PLAYER);
			xFreeDatabaseBlock("yeebFeathers");
		}
	}
	
	while (yFindLatest("yeebLatestFeather", "Stymph Bird Feather", 0) > 0) {
		trVectorSetUnitPos("pos", "yeebLatestFeather");
		yAddToDatabase("yeebFeathers", "yeebLatestFeather");
		yAddUpdateVar("yeebFeathers", "posx", trQuestVarGet("posx"));
		yAddUpdateVar("yeebFeathers", "posz", trQuestVarGet("posz"));
		trMutateSelected(kbGetProtoUnitID("Lampades Bolt"));
	}
	
	if (trTimeMS() > trQuestVarGet("yeebLightningNext")) {
		trVectorSetUnitPos("pos", "yeebaagooon");
		trQuestVarSet("yeebLightningNext",
			trQuestVarGet("yeebLightningNext") + 2.0 * zDistanceBetweenVectors("pos", "yeebDestination"));
		trQuestVarSetFromRand("dist", 4, 20, false);
		trVectorQuestVarSet("yeebDir", rotationMatrix("yeebDir", -0.757323, 0.653041));
		trQuestVarSet("posx", trQuestVarGet("posx") + trQuestVarGet("yeebDirx") * trQuestVarGet("dist"));
		trQuestVarSet("posz", trQuestVarGet("posz") + trQuestVarGet("yeebDirz") * trQuestVarGet("dist"));
		vectorSnapToGrid("pos");
		spawnLightning("pos", ENEMY_PLAYER);
	}
	
	/* all dead */
	if (trQuestVarGet("gameOverStep") > 0) {
		xsDisableSelf();
	} else if ((boss == 1001) && (trQuestVarGet("deadPlayerCount") < trQuestVarGet("activePlayerCount"))) {
		/* successful escape */
		int escape = 0;
		for(p=1; < ENEMY_PLAYER) {
			if (zDistanceToVectorSquared("p"+p+"unit", "yeebDestination") < 400) {
				escape = escape + 1;
			}
		}
		if (escape == trQuestVarGet("activePlayerCount") - trQuestVarGet("deadPlayerCount")) {
			trSoundPlayFN("win.wav","1",-1,"","");
			trQuestVarSet("gameOverStep", 4);
			trQuestVarSet("playersWon", 1);
			xsEnableRule("game_over");
			xsDisableRule("gameplay_always");
			xsDisableRule("yeebaagooon_battle");
			xsDisableSelf();
			trQuestVarSet("yeebhit", 0);
			trQuestVarSet("ownedRelics"+RELIC_YEEBAAGOOON,
				trQuestVarGet("ownedRelics"+RELIC_YEEBAAGOOON) + trQuestVarGet("yeebRelicRetrieved"));
		}
	} else if (boss < 1000) {
		xsDisableRule("yeebaagooon_battle");
		xsDisableSelf();
		trQuestVarSet("yeebhit", 0);
		trQuestVarSet("ownedRelics"+RELIC_YEEBAAGOOON,
			trQuestVarGet("ownedRelics"+RELIC_YEEBAAGOOON) + trQuestVarGet("yeebRelicRetrieved"));
		trUnitSelectClear();
		trUnitSelectByQV("yeebBird");
		trUnitChangeProtoUnit("Cinematic Block");
		trUnitSelectClear();
		trUnitSelectByQV("yeebaagooon");
		trUnitChangeProtoUnit("Cinematic Block");
	}
}


rule boss7_battle
inactive
highFrequency
{
	trUnitSelectClear();
	trUnitSelect(""+bossUnit, true);
	int p = 0;
	int x = 0;
	int z = 0;
	int action = 0;
	int id = 0;
	float amt = 0;
	float angle = 0;
	float sVal = 0;
	float cVal = 0;
	float m = 0;
	float dist = 0;
	bool hit = false;
	if (trUnitAlive() == true) {
		if (trQuestVarGet("secondPhase") == 1) {
			if (trTime() > trQuestVarGet("bossSpawnNext")) {
				trQuestVarSet("bossSpawnNext", trTime() + 30);
				trQuestVarSetFromRand("rand", 1, 6, true);
				trQuestVarSetFromRand("count", 3, 5, true);
				trVectorSetUnitPos("pos", "bossUnit");
				for(i=trQuestVarGet("count"); >0) {
					trQuestVarSetFromRand("heading", 1, 360, false);
					trQuestVarSet("next", trGetNextUnitScenarioNameNumber());
					trArmyDispatch(""+ENEMY_PLAYER+",0",trStringQuestVarGet("enemyProto"+1*trQuestVarGet("rand")),1,
						trQuestVarGet("posx"),0,trQuestVarGet("posz"),trQuestVarGet("heading"),true);
					activateEnemy("next",-1,0);
				}
			}
		}
		
		trUnitSelectClear();
		trUnitSelect(""+bossUnit, true);
		
		if (trQuestVarGet("bossSpell") == BOSS_SPELL_COOLDOWN) {
			processBossCooldown();
		} else if (trQuestVarGet("bossSpell") > 30) {
			if (trQuestVarGet("bossSpell") == 31) {
				trSoundPlayFN("cinematics\15_in\gong.wav","1",-1,"","");
				trSoundPlayFN("godpower.wav","1",-1,"","");
				trSetLighting("night", 1.0);
				trOverlayText("Drowning Whirlpool",3.0,-1,-1,-1);
				trQuestVarSet("bossSpell", 32);
				bossNext = trTimeMS();
				bossTimeout = trTimeMS() + 2000;
				bossAngle = 0;
				trQuestVarSet("bossAngularVelocity", 0.1);
				if (kbGetBlockID(""+1*trQuestVarGet("bossWhirlpoolSFX")) == -1) {
					spyEffect(1*bossUnit,kbGetProtoUnitID("Kronny Birth"), "bossWhirlpoolSFX");
				} else {
					trUnitSelectClear();
					trUnitSelectByQV("bossWhirlpoolSFX");
					trMutateSelected(kbGetProtoUnitID("Kronny Birth"));
				}
				bossPos = kbGetBlockPosition(""+bossUnit, true);
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trMutateSelected(kbGetProtoUnitID("Scylla"));
			} else if ((trQuestVarGet("bossSpell") >= 32) && (trQuestVarGet("bossSpell") <= 33)) {
				trMutateSelected(kbGetProtoUnitID("Scylla"));
				amt = trTimeMS() - bossNext;
				bossNext = trTimeMS();
				if (trQuestVarGet("bossSpell") == 32) {
					trQuestVarSet("bossAngularVelocity", trQuestVarGet("bossAngularVelocity") + 0.006 * amt);
				} else {
					trQuestVarSet("bossScale", xsMax(0, bossScale - amt * 0.0013));
					trSetSelectedScale(bossScale,1.3,bossScale);
				}
				bossAngle=
					fModulo(6.283185, bossAngle - 0.001 * amt * trQuestVarGet("bossAngularVelocity")));
				trVectorSetFromAngle("dir", bossAngle);
				trSetUnitOrientation(trVectorQuestVarGet("dir"),vector(0,1,0),true);
				if (trTimeMS() > bossTimeout) {
					if (trQuestVarGet("bossSpell") == 32) {
						trQuestVarSet("bossSpell", 33);
						bossTimeout = bossTimeout + 1000;
					} else {
						trSetSelectedScale(0,0,0);
						trQuestVarSet("bossSpell", 34);
						bossTimeout = trTimeMS() + 15000;
						bossNext = trTimeMS();
						bossDir = vector(1,0,0);
						trModifyProtounit("Scylla", ENEMY_PLAYER, 1, -2);
					}
				}
			} else if (trQuestVarGet("bossSpell") == 34) {
				bossPos = kbGetBlockPosition(""+bossUnit, true);
				for(i=xsMin(6, xGetDatabaseCount("bossBalls")); >0) {
					action = processGenericProj("bossBalls");
					if (action == PROJ_FALLING) {
						hit = false;
						trVectorSetUnitPos("pos", "bossBalls");
						yVarToVector("bossBalls", "prev");
						yVarToVector("bossBalls", "dir");
						dist = zDistanceBetweenVectors("pos", "prev") + 2.0;
						for(j=xGetDatabaseCount(dPlayerUnits); >0) {
							if (xDatabaseNext(dPlayerUnits,true) == -1 || trUnitAlive() == false) {
								removePlayerUnit();
							} else if (rayCollision(dPlayerUnits,"prev","dir",dist,4.0)) {
								damagePlayerUnit(300);
								hit = true;
							}
						}
						if (hit) {
							trQuestVarSetFromRand("sound", 1, 3, true);
							trSoundPlayFN("fleshcrush"+1*trQuestVarGet("sound")+".wav","1",-1,"","");
							trUnitSelectClear();
							trUnitSelectByQV("bossBalls");
							trUnitChangeProtoUnit("Rocket");
							xFreeDatabaseBlock("bossBalls");
						} else if (zDistanceToVectorSquared("bossBalls", "bossPos") < 36.0) {
							trUnitSelectClear();
							trUnitSelectByQV("bossBalls");
							trUnitChangeProtoUnit("Rocket");
							xFreeDatabaseBlock("bossBalls");
						} else {
							amt = (trTimeMS() - yGetVar("bossBalls", "last")) * 0.004;
							ySetVar("bossBalls", "last", trTimeMS());
							ySetVarFromVector("bossBalls","prev","pos");
							trVectorQuestVarSet("newDir", zGetUnitVector("pos","bossPos"));
							trQuestVarSet("newDirX", trQuestVarGet("newDirX") * amt + trQuestVarGet("dirX"));
							trQuestVarSet("newDirZ", trQuestVarGet("newDirZ") * amt + trQuestVarGet("dirZ"));
							trVectorQuestVarSet("newDir", xsVectorNormalize(trVectorQuestVarGet("newDir")));
							ySetVarFromVector("bossBalls","dir","newDir");
						}
					}
				}
				if (trTimeMS() > bossNext) {
					bossDir = rotationMatrix("bossDir", -0.757323, 0.653041);
					trVectorQuestVarSet("dir", rotationMatrix("bossDir", -0.707107, 0.707107));
					trQuestVarSet("startx", trQuestVarGet("bossRoomCenterx")+2.0*trQuestVarGet("bossRoomSize")*trQuestVarGet("bossDirx"));
					trQuestVarSet("startz", trQuestVarGet("bossRoomCenterz")+2.0*trQuestVarGet("bossRoomSize")*trQuestVarGet("bossDirz"));
					addGenericProj("bossBalls","start","dir",kbGetProtoUnitID("Pharaoh of Osiris XP"),50,8.0,5.0);
					yAddUpdateVar("bossBalls", "prevx", trQuestVarGet("startx"));
					yAddUpdateVar("bossBalls", "prevz", trQuestVarGet("startz"));
					yAddUpdateVar("bossBalls", "last", trTimeMS());
					bossNext = bossNext + 300;
				}
				if (trTimeMS() > bossTimeout) {
					bossCooldown(10, 15);
					trQuestVarSet("bossUltimate", 3);
					yClearDatabase("bossBalls");
					trUnitSelectClear();
					trUnitSelectByQV("bossWhirlpoolSFX");
					trMutateSelected(kbGetProtoUnitID("Cinematic Block"));
					trQuestVarSet("bossScale", 1.3);
					trUnitSelectClear();
					trUnitSelect(""+bossUnit, true);
					trSetSelectedScale(bossScale,bossScale,bossScale);
					trSetLighting("Fimbulwinter", 1.0);
					trSoundPlayFN("godpowerfailed.wav","1",-1,"","");
					trModifyProtounit("Scylla", ENEMY_PLAYER, 1, 2);
				}
			}
		} else if (trQuestVarGet("bossSpell") > 20) {
			if (trQuestVarGet("bossSpell") == 21) {
				trQuestVarSetFromRand("rand", 1, 5, true);
				if (trQuestVarGet("rand") == 1) {
					trChatSendSpoofed(ENEMY_PLAYER, "Mother of the Depths: I'm going to eat you!");
				} else if (trQuestVarGet("rand") == 2) {
					trChatSendSpoofed(ENEMY_PLAYER, "Mother of the Depths: This one looks tasty!");
				} else if (trQuestVarGet("rand") == 3) {
					trChatSendSpoofed(ENEMY_PLAYER, "Mother of the Depths: Delicious!");
				}
				for(i=xGetDatabaseCount(dPlayerCharacters); >0) {
					xDatabaseNext(dPlayerCharacters);
					p = yGetVar(dPlayerCharacters, "player");
					if (trQuestVarGet("p"+p+"unit") == trQuestVarGet(dPlayerCharacters)) {
						bossTarget = p);
						break;
					}
				}
				trVectorSetUnitPos("bossTargetPos", "p"+p+"unit");
				bossPos = kbGetBlockPosition(""+bossUnit, true);
				trVectorQuestVarSet("dir", zGetUnitVector("pos", "bossPos"));
				trQuestVarSet("bossposx", trQuestVarGet("bossTargetPosx") + trQuestVarGet("dirx") * 4.0);
				trQuestVarSet("bossposz", trQuestVarGet("bossTargetPosz") + trQuestVarGet("dirz") * 4.0);
				vectorSnapToGrid("bossPos");
				trVectorQuestVarSet("dir", zGetUnitVector("bossPos", "bossTargetPos"));
				trQuestVarSet("boat", trGetNextUnitScenarioNameNumber());
				trArmyDispatch(""+ENEMY_PLAYER+",0","Dwarf",1,trQuestVarGet("bossPosx"),0,trQuestVarGet("bossPosz"),0,true);
				trArmySelect(""+ENEMY_PLAYER+",0");
				trSetUnitOrientation(trVectorQuestVarGet("dir"),vector(0,1,0),true);
				trUnitChangeProtoUnit("Transport Ship Greek");
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trMutateSelected(kbGetProtoUnitID("Dwarf"));
				trImmediateUnitGarrison(""+1*trQuestVarGet("boat"));
				trUnitChangeProtoUnit("Scylla");
				trQuestVarSet("bossSpell", 22);
				bossNext = trTimeMS() + 1400;
				trUnitSelectClear();
				trUnitSelectByQV("boat");
				trUnitChangeProtoUnit("Meteor Impact Water");
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				if (kbGetBlockID(""+1*trQuestVarGet("bossStomach")) == -1) {
					spyEffect(1*bossUnit,kbGetProtoUnitID("Cinematic Block"), "bossStomach");
				}
				trSetSelectedScale(bossScale,bossScale,bossScale);
			} else if (trQuestVarGet("bossSpell") == 22) {
				if (trTimeMS() > bossNext) {
					trUnitSetAnimationPath("4,0,0,0,0,0,0");
					trUnitOverrideAnimation(1,0,false,false,-1);
					bossNext = trTimeMS() + 700;
					trQuestVarSet("bossSpell", 23);
				}
			} else if (trQuestVarGet("bossSpell") == 23) {
				if (trTimeMS() > bossNext) {
					p = trQuestVarGet("bossTarget");
					if (zDistanceToVectorSquared("p"+p+"unit", "bossTargetPos") < 16) {
						silencePlayer(p, 9999);
						trUnitSelectClear();
						trUnitSelectByQV("bossStomach");
						trUnitChangeProtoUnit("Roc");
						trUnitSelectClear();
						trUnitSelectByQV("bossStomach");
						trUnitConvert(p);
						trSetSelectedScale(0,0,0);
						trUnitSelectClear();
						trUnitSelectByQV("p"+p+"unit");
						trImmediateUnitGarrison(""+1*trQuestVarGet("bossStomach"));
						trUnitOverrideAnimation(2,0,true,true,-1);
						trSoundPlayFN("changeunit.wav","1",-1,"","");
						trSoundPlayFN("titanpunch1.wav","1",-1,"","");
						trQuestVarSet("bossSpell", 24);
						bossTimeout = trTimeMS() + 10000;
						bossNext = trTimeMS() + 1000;
						trQuestVarSet("bossDamage", 0);
						trMessageSetText(trStringQuestVarGet("p"+p+"name") + " has been eaten! Poison the boss to make her spit them out!", -1);
						trQuestVarSet("bossScale", 2.3);
						trUnitSelectClear();
						trUnitSelect(""+bossUnit, true);
						trSetSelectedScale(bossScale,bossScale,bossScale);
						trUnitOverrideAnimation(-1,0,false,true,-1);
						if (trCurrentPlayer() == p) {
							trSetCurrentPlayerStatus(false);
						}
					} else {
						bossCooldown(3, 6);
					}
				}
			} else if (trQuestVarGet("bossSpell") == 24) {
				if (trTimeMS() > bossNext) {
					if (yGetVarAtIndex(dEnemies,"poisonStatus",1*trQuestVarGet("bossIndex")) > 0) {
						bossTimeout = bossTimeout - 1000;
					} else {
						trSoundPlayFN("colossuseat.wav","1",-1,"","");
						trDamageUnitPercent(-1);
						trVectorSetUnitPos("pos", "bossUnit");
						trArmyDispatch("0,0","Dwarf",1,trQuestVarGet("posx"),0,trQuestVarGet("posz"),0,true);
						trArmySelect("0,0");
						trUnitChangeProtoUnit("Regeneration SFX");
						if (trQuestVarGet("secondPhase") == 1) {
							trQuestVarSetFromRand("rand", 1, 6, true);
							trQuestVarSet("next", trGetNextUnitScenarioNameNumber());
							trArmyDispatch(""+ENEMY_PLAYER+",0","Dwarf",1,trQuestVarGet("posx"),0,trQuestVarGet("posz"),180,true);
							trArmySelect(""+ENEMY_PLAYER+",0");
							trUnitChangeProtoUnit(trStringQuestVarGet("enemyProto"+1*trQuestVarGet("rand")));
							activateEnemy("next");
						}
					}
					bossNext = bossNext + 1000;
					trQuestVarSet("bossDamage", trQuestVarGet("bossDamage") + 150);
					trUnitSelectClear();
					trUnitSelect(""+bossUnit, true);
					if (trTimeMS() > bossTimeout) {
						trQuestVarSet("bossScale", 1.3);
						trSetSelectedScale(bossScale,bossScale,bossScale);
						p = trQuestVarGet("bossTarget");
						if (trCurrentPlayer() == p) {
							trSetCurrentPlayerStatus(true);
						}
						trQuestVarSet("p"+p+"silenceTimeout", 0);
						trUnitSelectClear();
						trUnitSelectByQV("bossStomach");
						trUnitChangeProtoUnit("Cinematic Block");
						trUnitSelectClear();
						trUnitSelectByQV("p"+p+"unit");
						trUnitOverrideAnimation(-1,0,false,true,-1);
						ySetPointer(dPlayerUnits, 1*trQuestVarGet("p"+p+"index"));
						damagePlayerUnit(trQuestVarGet("bossDamage"));
						bossCooldown(3, 6);
					} else {
						trQuestVarSet("bossScale", 1.3 + (bossTimeout - trTimeMS()) / 10000);
						trSetSelectedScale(bossScale,bossScale,bossScale);
					}
				}
			}
		} else if (trQuestVarGet("bossSpell") > 10) {
			/* do you know what a derivative is? */
			if (trQuestVarGet("bossSpell") == 11) {
				trQuestVarSetFromRand("rand", 1, 5, true);
				if (trQuestVarGet("rand") == 1) {
					trChatSendSpoofed(ENEMY_PLAYER, "Mother of the Depths: I will drag you to the depths!");
				} else if (trQuestVarGet("rand") == 2) {
					trChatSendSpoofed(ENEMY_PLAYER, "Mother of the Depths: A dance of death!");
				} else if (trQuestVarGet("rand") == 3) {
					trChatSendSpoofed(ENEMY_PLAYER, "Mother of the Depths: Your death will be swift!");
				}
				bossCount = 3;
				if (trQuestVarGet("secondPhase") == 1) {
					bossCount = 5;
				}
				trQuestVarSet("bossSpell", 12);
				bossPos = kbGetBlockPosition(""+bossUnit, true);
				trMutateSelected(kbGetProtoUnitID("Dwarf"));
				trImmediateUnitGarrison(""+1*trQuestVarGet("bossEscape"));
				trUnitChangeProtoUnit("Scylla");
				trArmyDispatch("0,0","Dwarf",1,trQuestVarGet("bossPosx"),0,trQuestVarGet("bossPosz"),0,true);
				trArmySelect("0,0");
				trUnitChangeProtoUnit("Meteor Impact Water");
				trSoundPlayFN("shipmove1.wav","1",-1,"","");
				trModifyProtounit("Wadjet Spit",ENEMY_PLAYER,55,2);//make them water so they don't run off
			} else if (trQuestVarGet("bossSpell") == 12) {
				xDatabaseNext(dPlayerCharacters);
				trVectorSetUnitPos("bossTargetPos", dPlayerCharacters);
				trVectorQuestVarSet("dir", zGetUnitVector("bossPos", "bossTargetPos"));
				dist = 0.5 * zDistanceBetweenVectors("bossPos", "bossTargetPos");
				amt = dist * 0.04;
				m = 15.0 / xsPow(dist, 2);
				for(i=0; < 50) {
					angle = 0.0 - 2.0 * m * (amt * i - dist); // the derivative of the line getting us the slope at the point
					cVal = xsSqrt(xsPow(angle, 2) + 1);
					sVal = angle / cVal;
					cVal = 1.0 / cVal;
					trUnitSelectClear();
					trUnitSelectByQV("jumpPath"+i);
					trSetUnitOrientation(xsVectorSet(trQuestVarGet("dirX")*cVal,sVal,trQuestVarGet("dirZ")*cVal),
						xsVectorSet(0.0-trQuestVarGet("dirX")*sVal,cVal,0.0-trQuestVarGet("dirZ")*sVal),true);
					trUnitTeleport(trQuestVarGet("bossPosX") + trQuestVarGet("dirX") * amt * i,
						worldHeight + 15.0 - m * xsPow(amt * i - dist, 2),
						trQuestVarGet("bossPosZ") + trQuestVarGet("dirZ") * amt * i);
				}
				trQuestVarSet("bossSpell", 13);
				bossNext = trTimeMS() + 1000;
			} else if (trQuestVarGet("bossSpell") == 13) {
				if (trTimeMS() > bossNext) {
					trSetSelectedScale(bossScale,bossScale,bossScale);
					trArmyDispatch("0,0","Dwarf",1,trQuestVarGet("bossPosx"),0,trQuestVarGet("bossPosz"),0,true);
					trArmySelect("0,0");
					trUnitChangeProtoUnit("Meteor Impact Water");
					trSoundPlayFN("geyserhit1.wav","1",-1,"","");
					trQuestVarSet("bossSpell", 14);
					if (trQuestVarGet("secondPhase") == 0) {
						action = 2000;
					} else {
						action = 1000;
					}
					trQuestVarSet("bossPrev", -1);
					trQuestVarSet("bossStep", action / 50);
					bossNext = trTimeMS();
				}
			} else if (trQuestVarGet("bossSpell") == 14) {
				action = trTimeMS() - bossNext;
				action = action / trQuestVarGet("bossStep");
				if (action > trQuestVarGet("bossPrev")) {
					if (action < 50) {
						trQuestVarSet("bossPrev", action);
						trUnitSelectClear();
						trUnitSelectByQV("jumpPath"+action);
						trMutateSelected(kbGetProtoUnitID("Hero Greek Achilles"));
						trUnitSelectClear();
						trUnitSelect(""+bossUnit, true);
						trUnitChangeProtoUnit("Dwarf");
						trUnitSelectClear();
						trUnitSelect(""+bossUnit, true);
						trMutateSelected(kbGetProtoUnitID("Relic"));
						trImmediateUnitGarrison(""+1*trQuestVarGet("jumpPath"+action));
						trMutateSelected(kbGetProtoUnitID("Scylla"));
						trUnitSelectClear();
						trUnitSelectByQV("jumpPath"+action);
						trMutateSelected(kbGetProtoUnitID("Wadjet Spit"));
					} else {
						trSoundPlayFN("meteorsplash.wav","1",-1,"","");
						trCameraShake(0.7, 0.4);
						trArmyDispatch("0,0","Dwarf",1,trQuestVarGet("bossTargetPosx"),0,trQuestVarGet("bossTargetPosz"),0,true);
						trVectorQuestVarSet("dir", vector(6,0,0));
						for(i=8; >0) {
							x = trQuestVarGet("bossTargetPosx") + trQuestVarGet("dirx");
							z = trQuestVarGet("bossTargetPosz") + trQuestVarGet("dirz");
							trArmyDispatch("0,0","Dwarf",1,x,0,z,0,false);
							trVectorQuestVarSet("dir", rotationMatrix("dir", 0.707107, 0.707107));
						}
						trArmySelect("0,0");
						trUnitChangeProtoUnit("Meteor Impact Water");
						for(i=xGetDatabaseCount(dPlayerUnits); >0) {
							if (xDatabaseNext(dPlayerUnits, true) == -1 || trUnitAlive() == false) {
								removePlayerUnit();
							} else if (zDistanceToVectorSquared(dPlayerUnits, "bossTargetPos") < 64.0) {
								damagePlayerUnit(500);
							}
						}
						bossCount = bossCount - 1;
						if (bossCount <= 0) {
							trModifyProtounit("Wadjet Spit", ENEMY_PLAYER, 55, 4);
							trUnitSelectClear();
							trUnitSelect(""+bossUnit, true);
							trUnitChangeProtoUnit("Scylla");
							trUnitSelectClear();
							trUnitSelect(""+bossUnit, true);
							trSetSelectedScale(bossScale,bossScale,bossScale);
							bossCooldown(10, 15);
						} else {
							trQuestVarSet("bossSpell", 12);
							trQuestVarSet("bossPosx", trQuestVarGet("bossTargetPosx"));
							trQuestVarSet("bossPosz", trQuestVarGet("bossTargetPosz"));
							trUnitSelectClear();
							trUnitSelect(""+bossUnit, true);
							trUnitChangeProtoUnit("Scylla");
							trUnitSelectClear();
							trUnitSelect(""+bossUnit, true);
							trSetSelectedScale(0,0,0);
						}
					}
				}
			}
		} else if (trQuestVarGet("bossSpell") > 0) {
			if (trQuestVarGet("bossSpell") == 1) {
				xsSetContextPlayer(ENEMY_PLAYER);
				id = kbUnitGetTargetUnitID(1*trQuestVarGet("bossID"));
				if (id >= 0) {
					trQuestVarSetFromRand("rand", 1, 5, true);
					if (trQuestVarGet("rand") == 1) {
						trChatSendSpoofed(ENEMY_PLAYER, "Mother of the Depths: Begone!");
					} else if (trQuestVarGet("rand") == 2) {
						trChatSendSpoofed(ENEMY_PLAYER, "Mother of the Depths: Impact!");
					} else if (trQuestVarGet("rand") == 3) {
						trChatSendSpoofed(ENEMY_PLAYER, "Mother of the Depths: Perish!");
					}
					trSoundPlayFN("shipmove2.wav","1",-1,"","");
					trMutateSelected(kbGetProtoUnitID("Scylla"));
					trUnitSetStance("Passive");
					bossPos = kbGetBlockPosition(""+bossUnit, true);
					vectorSnapToGrid("bossPos");
					trVectorQuestVarSet("target", kbGetBlockPosition(""+trGetUnitScenarioNameNumber(id)));
					bossDir = zGetUnitVector("target", "bossPos");
					trVectorQuestVarSet("bossSplashDir", bossDir);
					trQuestVarSet("bossStartDirx", 0.0 - trQuestVarGet("bossDirx"));
					trQuestVarSet("bossStartDirz", 0.0 - trQuestVarGet("bossDirz"));
					bossAngle = angleBetweenVectors("target", "bossPos");
					trQuestVarSet("bossWarnStart", trGetNextUnitScenarioNameNumber());
					trVectorQuestVarSet("dir", vector(0,0,-12));
					trQuestVarSet("heading", 360);
					for(i=8; >0) {
						x = trQuestVarGet("bossPosx") + trQuestVarGet("dirx");
						z = trQuestVarGet("bossPosz") + trQuestVarGet("dirz");
						trArmyDispatch("0,0","Dwarf",1,x,0,z,trQuestVarGet("heading"),true);
						trArmySelect("0,0");
						trUnitChangeProtoUnit("UI Range Indicator Greek SFX");
						trVectorQuestVarSet("dir", rotationMatrix("dir", 0.707107, 0.707107));
						trQuestVarSet("heading", trQuestVarGet("heading") - 45);
					}
					trQuestVarSet("bossWarnEnd", trGetNextUnitScenarioNameNumber());
					
					trQuestVarSet("bossSpell", 2);
					bossNext = trTimeMS() + 1000;
					action = 1500;
					if (trQuestVarGet("secondPhase") == 1) {
						action = 500;
					}
					bossTimeout = bossNext + action;
					trQuestVarSet("bossAngularVelocity", 6.283185 / action);
				}
			} else if (trQuestVarGet("bossSpell") == 2) {
				if (trTimeMS() > bossNext) {
					for(i=trQuestVarGet("bossWarnStart"); < trQuestVarGet("bossWarnEnd")) {
						trUnitSelectClear();
						trUnitSelect(""+i, true);
						trUnitDestroy();
					}
					trQuestVarSet("bossLast", bossNext);
					trQuestVarSet("bossSpell", 3);
					trArmyDispatch("0,0","Dwarf",1,trQuestVarGet("bossPosX"),0,trQuestVarGet("bossPosZ"),0,true);
					trArmySelect("0,0");
					trUnitChangeProtoUnit("Tremor");
					trSoundPlayFN("shockwave.wav","1",-1,"","");
				}
			} else if (trQuestVarGet("bossSpell") == 3) {
				amt = trTimeMS() - trQuestVarGet("bossLast");
				trQuestVarSet("bossLast", trTimeMS());
				bossAngle = bossAngle + amt * trQuestVarGet("bossAngularVelocity");
				trVectorSetFromAngle("newDir", bossAngle);
				angle = dotProduct("newDir", "bossDir");
				for(i=xGetDatabaseCount(dPlayerUnits); >0) {
					if (xDatabaseNext(dPlayerUnits, true) == -1 || trUnitAlive() == false) {
						removePlayerUnit();
					} else if (yGetVar(dPlayerUnits, "launched") == 0) {
						trVectorSetUnitPos("pos", dPlayerUnits);
						if (zDistanceBetweenVectorsSquared("pos", "bossPos") < 144.0) {
							trVectorQuestVarSet("dir", zGetUnitVector("bossPos", "pos"));
							if (dotProduct("dir", "newDir") > angle) {
								if (dotProduct("dir", "bossDir") > angle) {
									damagePlayerUnit(500);
									if (trUnitAlive()) {
										trQuestVarSet("destx", 50.0 * trQuestVarGet("dirx") + trQuestVarGet("bossPosx"));
										trQuestVarSet("destz", 50.0 * trQuestVarGet("dirz") + trQuestVarGet("bossPosz"));
										launchUnit(dPlayerUnits, "dest");
									}
								}
							}
						}
					}
				}
				if (dotProduct("bossSplashDir", "bossDir") > dotProduct("bossSplashDir", "newDir")) {
					trQuestVarSet("posx", trQuestVarGet("bossPosx") + 12.0 * trQuestVarGet("bossSplashDirx"));
					trQuestVarSet("posz", trQuestVarGet("bossPosz") + 12.0 * trQuestVarGet("bossSplashDirz"));
					trArmyDispatch("0,0","Dwarf",1,trQuestVarGet("posx"),0,trQuestVarGet("posz"),0,true);
					trArmySelect("0,0");
					trUnitChangeProtoUnit("Meteor Impact Water");
					trVectorQuestVarSet("bossSplashDir", rotationMatrix("bossSplashDir", 0.866025, -0.5));
				}
				trQuestVarSet("bossDirx", trQuestVarGet("newDirx"));
				trQuestVarSet("bossDirz", trQuestVarGet("newDirz"));
				trQuestVarSet("dirx", 0.0 - trQuestVarGet("bossDirx"));
				trQuestVarSet("dirz", 0.0 - trQuestVarGet("bossDirz"));
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				if (trTimeMS() > bossTimeout) {
					trSetUnitOrientation(trVectorQuestVarGet("bossStartDir"),vector(0,1,0),true);
					if (trQuestVarGet("secondPhase") == 1) {
						trQuestVarSet("bossSpell", 4);
						bossTimeout = trTimeMS() + 500;
						bossAngle = 0;
						trQuestVarSet("bossAngularVelocity", 3.141592 / 500);
					} else {
						trUnitSetStance("Aggressive");
						bossCooldown(10, 15);
					}
				} else {
					/*
					sin(30) = 0.5
					cos(30) = 0.866025
					the model is angled downwards so that the tail can be above the water surface
					*/
					trSetUnitOrientation(xsVectorSet(trQuestVarGet("DirX")*0.866025,-0.5,trQuestVarGet("DirZ")*0.866025),
						xsVectorSet(trQuestVarGet("DirX")*0.5,0.866025,trQuestVarGet("DirZ")*0.5), true);
				}
			} else {
				amt = trTimeMS() - trQuestVarGet("bossLast");
				trQuestVarSet("bossLast", trTimeMS());
				if (trQuestVarGet("bossSpell") == 4) {
					trQuestVarSet("bossScale", bossScale + 0.001 * amt);
				} else {
					trQuestVarSet("bossScale", bossScale - 0.001 * amt);
				}
				bossAngle = bossAngle + amt * trQuestVarGet("bossAngularVelocity");
				sVal = xsSin(bossAngle);
				cVal = xsCos(bossAngle);
				
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trSetSelectedScale(1.3,1.3,bossScale);
				trSetUnitOrientation(xsVectorSet(trQuestVarGet("bossStartDirX")*cVal,0.0-sVal,trQuestVarGet("bossStartDirZ")*cVal),
					xsVectorSet(trQuestVarGet("bossStartDirX")*sVal,cVal,trQuestVarGet("bossStartDirZ")*sVal), true);
				if (trTimeMS() > bossTimeout) {
					trQuestVarSet("bossSpell", 1 + trQuestVarGet("bossSpell"));
					if (trQuestVarGet("bossSpell") == 5) {
						trSoundPlayFN("shockwave.wav","1",-1,"","");
						trSoundPlayFN("meteorsplash.wav","1",-1,"","");
						trQuestVarSet("bossDistance", 0);
						bossNext = trTimeMS() - 1;
						bossTimeout = bossTimeout + 500;
					} else if (trQuestVarGet("bossSpell") == 6) {
						trQuestVarSet("bossScale", 1.3);
						trSetSelectedScale(bossScale,bossScale,bossScale);
						trSetUnitOrientation(trVectorQuestVarGet("bossStartDir"),vector(0,1,0),true);
						trUnitSetStance("Aggressive");
						bossCooldown(10, 15);
					}
				}
				if (trQuestVarGet("bossSpell") == 5) {
					if (trTimeMS() > bossNext) {
						bossNext = bossNext + 100;
						trQuestVarSet("bossDistance", 6 + trQuestVarGet("bossDistance"));
						trQuestVarSet("posx", trQuestVarGet("bossPosx") + trQuestVarGet("bossDistance") * trQuestVarGet("bossStartDirx"));
						trQuestVarSet("posz", trQuestVarGet("bossPosz") + trQuestVarGet("bossDistance") * trQuestVarGet("bossStartDirz"));
						trArmyDispatch("0,0","Dwarf",1,trQuestVarGet("posx"),0,trQuestVarGet("posz"),0,true);
						trArmySelect("0,0");
						trUnitChangeProtoUnit("Meteor Impact Water");
						for(x=xGetDatabaseCount(dPlayerUnits); >0) {
							if (xDatabaseNext(dPlayerUnits, true) == -1 || trUnitAlive() == false) {
								removePlayerUnit();
							} else if (zDistanceToVectorSquared(dPlayerUnits, "pos") < 16.0) {
								damagePlayerUnit(500);
								if (trUnitAlive()) {
									stunUnit(dPlayerUnits, 2.0);
								}
							}
						}
					}
				}
			}
		} else if (xGetInt(dEnemies, xStunStatus, bossPointer) == 0) {
			trQuestVarSetFromRand("bossSpell", 0, xsMin(3, trUnitPercentDamaged() * 0.05), true);
			trQuestVarSet("bossSpell", trQuestVarGet("bossSpell") * 10 + 1);
			if (trQuestVarGet("bossSpell") == 31 && trQuestVarGet("bossUltimate") > 0) {
				trQuestVarSetFromRand("bossSpell", 0, 2, true);
				trQuestVarSet("bossSpell", 1 + 10 * trQuestVarGet("bossSpell"));
			}
		}
	} else {
		trUnitOverrideAnimation(-1,0,false,true,-1);
		xsDisableSelf();
		trMusicStop();
		xsDisableRule("boss_music");
		if (trQuestVarGet("secondPhase") == 1) {
			xsEnableRule("boss_ded");
			xsDisableRule("gameplay_always");
		} else {
			trQuestVarSet("secondPhase", 1);
			trQuestVarSet("cinStep", 0);
			trQuestVarSet("cinTime", trTime() + 3);
			xsEnableRule("boss7_start_again");
			trForceNonCinematicModels(true);
			trUIFadeToColor(0,0,0,1000,0,true);
			trLetterBox(true);
		}
		boss = 0;
		trSetLighting("Fimbulwinter", 1.0);
		trSoundPlayFN("win.wav","1",-1,"","");
		for(x=xGetDatabaseCount(dEnemies); >0) {
			xDatabaseNext(dEnemies, true);
			trDamageUnitPercent(100);
		}
		uiLookAtUnitByName(""+bossUnit);
	}
}

rule boss7_start_again
inactive
highFrequency
{
	if (trTime() > trQuestVarGet("cinTime")) {
		trQuestVarSet("cinStep", 1 + trQuestVarGet("cinStep"));
		switch(1*trQuestVarGet("cinStep"))
		{
			case 1:
			{
				trSoundPlayFN("","1",-1,"Mother of the Depths:Don't you dare think this is over!");
				trQuestVarSet("cinTime", trTime() + 4);
			}
			case 2:
			{
				trSoundPlayFN("cinematics\15_in\gong.wav","1",-1,"Mother of the Depths:Children of the depths, heed my call!");
				trQuestVarSet("cinTime", trTime() + 4);
			}
			case 3:
			{
				xsEnableRule("boss7_battle");
				bossUnit = trGetNextUnitScenarioNameNumber();
				trArmyDispatch(""+ENEMY_PLAYER+",0","Dwarf",1,
					trQuestVarGet("bossRoomCenterX"),0,trQuestVarGet("bossRoomCenterZ"),225,true);
				trArmySelect(""+ENEMY_PLAYER+",0");
				trUnitChangeProtoUnit("Scylla");
				trQuestVarSet("boss", 1);
				activateEnemy("bossUnit");
				yAddUpdateVar(dEnemies, "launched", 1);
				trQuestVarSet("bossIndex", yGetNewestPointer(dEnemies));
				bossCooldown(10, 15);
				xsEnableRule("boss_music");
				trLetterBox(false);
				trUIFadeToColor(0,0,0,1000,0,false);
				trQuestVarSet("musicTime", 0);
				
				trQuestVarSet("next", trGetNextUnitScenarioNameNumber());
				trArmyDispatch(""+ENEMY_PLAYER+",0","Hydra",1,
					trQuestVarGet("bossRoomCenterX") + 6.0,0,trQuestVarGet("bossRoomCenterZ") - 6.0,225,true);
				activateEnemy("next");
				trQuestVarSet("next", trGetNextUnitScenarioNameNumber());
				trArmyDispatch(""+ENEMY_PLAYER+",0","Hydra",1,
					trQuestVarGet("bossRoomCenterX") - 6.0,0,trQuestVarGet("bossRoomCenterZ") + 6.0,225,true);
				activateEnemy("next");
			}
		}
	}
}

void dragonMeteor(string pos = "") {
	trQuestVarSet("next", trGetNextUnitScenarioNameNumber());
	trArmyDispatch("0,0","Dwarf",1,trQuestVarGet(pos+"x"),0,trQuestVarGet(pos+"z"),0,true);
	trArmySelect("0,0");
	trUnitChangeProtoUnit("Relic");
	trUnitSelectClear();
	trUnitSelectByQV("next");
	trMutateSelected(kbGetProtoUnitID("Hero Birth"));
	yAddToDatabase("dragonMeteors", "next");
	yAddUpdateVar("dragonMeteors", "sfx", trGetNextUnitScenarioNameNumber());
	yAddUpdateVar("dragonMeteors","timeout",trTimeMS() + 2000);
	yAddUpdateVar("dragonMeteors", "posx", trQuestVarGet(pos+"x"));
	yAddUpdateVar("dragonMeteors", "posz", trQuestVarGet(pos+"z"));
	trArmyDispatch("0,0","Dwarf",1,trQuestVarGet(pos+"x"),0,trQuestVarGet(pos+"z"),0,true);
	trArmySelect("0,0");
	trUnitChangeProtoUnit("Gaia Forest effect");
}

rule boss8_battle
inactive
highFrequency
{
	int p = 0;
	int x = 0;
	int action = 0;
	int id = 0;
	float current = 0;
	float dist = 0;
	float amt = 0;
	bool hit = false;
	trUnitSelectClear();
	trUnitSelect(""+bossUnit, true);
	if (trUnitAlive()) {
		switch(1*trQuestVarGet("bossSmiteStep"))
		{
			case 0:
			{
				if (trQuestVarGet("bossSmite") > 0) {
					trQuestVarSet("bossSmite", trQuestVarGet("bossSmite") - 1);
					bossPos = kbGetBlockPosition(""+bossUnit, true);
					trVectorQuestVarSet("up", zGetUnitVector("bossSmitePos", "bossPos"));
					trVectorQuestVarSet("up", rotationMatrix("up", 0, 1.0));
					trVectorQuestVarSet("dir", zGetUnitVector3d("bossPos", "bossSmitePos"));
					trUnitSelectClear();
					trUnitSelectByQV("bossSmiteLaser");
					trSetSelectedScale(5.0, 5.0, 40.0);
					trUnitHighlight(10.0, false);
					trSetUnitOrientation(trVectorQuestVarGet("dir"),trVectorQuestVarGet("up"),true);
					trQuestVarSet("bossSmiteStep", 1);
					trQuestVarSet("bossSmiteNext", trTimeMS() + 500);
					trQuestVarSetFromRand("sound", 1, 5, true);
					trSoundPlayFN("ui\lightning"+1*trQuestVarGet("sound")+".wav","1",-1,"","");
					trUnitSelectClear();
					trUnitSelect(""+bossUnit, true);
					trDamageUnitPercent(1);
				}
			}
			case 1:
			{
				trUnitSelectClear();
				trUnitSelectByQV("bossSmiteLaser");
				amt = trQuestVarGet("bossSmiteNext") - trTimeMS();
				if (amt > 0) {
					amt = amt * 0.01;
					trSetSelectedScale(amt, amt, 40.0);
				} else {
					trSetSelectedScale(0,0,0);
					trQuestVarSet("bossSmiteStep", 0);
				}
			}
		}
		if (xGetDatabaseCount("fallingFireballs") > 0) {
			for(i=xsMin(3, xGetDatabaseCount("fallingFireballs")); >0) {
				if (PROJ_GROUND == processGenericProj("fallingFireballs")) {
					trUnitChangeProtoUnit("Dwarf");
					trUnitSelectClear();
					trUnitSelectByQV("fallingFireballs");
					trDamageUnitPercent(-100);
					trUnitChangeProtoUnit("Meteorite");
					trUnitSelectClear();
					trUnitSelectByQV("fallingFireballs");
					trDamageUnitPercent(100);
					trQuestVarSetFromRand("sound", 1, 2, true);
					trSoundPlayFN("fireball fall " + 1*trQuestVarGet("sound") + ".wav","1",-1,"","");
					for (j=xGetDatabaseCount(dPlayerUnits); >0) {
						if (xDatabaseNext(dPlayerUnits,true) == -1 || trUnitAlive() == false) {
							removePlayerUnit();
						} else if (zDistanceToVectorSquared(dPlayerUnits,"pos") < 9) {
							damagePlayerUnit(200);
						}
					}
					xFreeDatabaseBlock("fallingFireballs");
				}
			}
			
		}
		
		if (xGetDatabaseCount("dragonMeteors") > 0) {
			hit = false;
			for(i=xsMin(3, xGetDatabaseCount("dragonMeteors")); >0) {
				xDatabaseNext("dragonMeteors");
				if (trTimeMS() > yGetVar("dragonMeteors", "timeout")) {
					hit = true;
					trUnitSelectClear();
					trUnitSelect(""+1*yGetVar("dragonMeteors","sfx"));
					trDamageUnitPercent(100);
					trUnitChangeProtoUnit("Meteorite");
					trUnitSelectClear();
					trUnitSelectByQV("dragonMeteors");
					trUnitChangeProtoUnit("Meteor");
					yVarToVector("dragonMeteors", "pos");
					for(j=xGetDatabaseCount(dPlayerUnits); >0) {
						if (xDatabaseNext(dPlayerUnits,true) == -1 || trUnitAlive() == false) {
							removePlayerUnit();
						} else if (zDistanceToVectorSquared(dPlayerUnits, "pos") < 25.0) {
							damagePlayerUnit(1000.0);
						}
					}
					xFreeDatabaseBlock("dragonMeteors");
				}
			}
			if (hit) {
				trSoundPlayFN("meteorsmallhit.wav","1",-1,"","");
				trSoundPlayFN("meteordustcloud.wav","1",-1,"","");
			}
		}
		
		if (xGetDatabaseCount("bossFireballs") > 0) {
			for(i=xsMin(5, xGetDatabaseCount("bossFireballs")); >0) {
				action = processGenericProj("bossFireballs");
				if (action == PROJ_FALLING) {
					yVarToVector("bossFireballs","prev");
					dist = zDistanceBetweenVectors("pos","prev");
					if (dist > 1.0) {
						hit = false;
						yVarToVector("bossFireballs","dir");
						for(j=xGetDatabaseCount(dPlayerUnits); >0) {
							if (xDatabaseNext(dPlayerUnits,true) == -1 || trUnitAlive() == false) {
								removePlayerUnit();
							} else if (rayCollision(dPlayerUnits,"prev","dir", dist + 1.0, 2.0)) {
								damagePlayerUnit(300);
								hit = true;
							}
						}
						if (hit) {
							trQuestVarSetFromRand("sound", 1, 2, true);
							trSoundPlayFN("fireball fall " + 1*trQuestVarGet("sound") + ".wav","1",-1,"","");
							trUnitSelectClear();
							trUnitSelectByQV("bossFireballs");
							trUnitChangeProtoUnit("Meteorite");
							xFreeDatabaseBlock("bossFireballs");
						}
					}
					ySetVarFromVector("bossFireballs","prev","pos");
				} else if (action == PROJ_GROUND) {
					vectorToGrid("pos", "loc");
					if (terrainIsType("loc", 4, 15)) {
						ySetVar("bossFireballs", "rm", 1);
					}
				} else if (action == PROJ_BOUNCE) {
					if (yGetVar("bossFireballs", "rm") == 1) {
						xFreeDatabaseBlock("bossFireballs");
					}
				}
			}
		}
		
		for (i=xGetDatabaseCount("cloudDeployStars"); >0) {
			if (PROJ_GROUND == processGenericProj("cloudDeployStars")) {
				trUnitChangeProtoUnit(trStringQuestVarGet("enemyProto"+1*trQuestVarGet("cloudDeployProto")));
				trUnitSelectClear();
				trUnitSelectByQV("cloudDeployStars");
				trDamageUnitPercent(-100);
				activateEnemy("cloudDeployStars", -1, RELIC_SPARK);
				xFreeDatabaseBlock("cloudDeployStars");
				trQuestVarSetFromRand("sound", 1, 2, true);
				trSoundPlayFN("vortexland"+1*trQuestVarGet("sound")+".wav","1",-1,"","");
			}
		}
		
		trUnitSelectClear();
		trUnitSelect(""+bossUnit, true);
		if (trQuestVarGet("bossSpell") == BOSS_SPELL_COOLDOWN) {
			if (trTimeMS() > trQuestVarGet("bossCooldownTime")) {
				trQuestVarSet("bossSpell", 0);
			}
		} else if (trQuestVarGet("bossSpell") > 40) {
			if (trQuestVarGet("bossSpell") == 41) {
				trQuestVarSetFromRand("bossCount", 3, 6, true);
				trQuestVarSetFromRand("cloudDeployProto", 1, 6, true);
				if (bossCount + xGetDatabaseCount(dEnemies) > ENEMY_PLAYER) {
					bossCount = ENEMY_PLAYER - xGetDatabaseCount(dEnemies);
				}
				trQuestVarSet("bossSpell", 42);
				bossNext = trTimeMS();
				if (bossCount > 0) {
					trQuestVarSet("bCos", xsCos(6.283185 / bossCount));
					trQuestVarSet("bSin", xsSin(6.283185 / bossCount));
				}
			} else if (trQuestVarGet("bossSpell") == 42) {
				if (bossCount <= 0) {
					bossCooldown(5, 10);
				} else if (trTimeMS() > bossNext) {
					trQuestVarSetFromRand("sound", 1, 3, true);
					trSoundPlayFN("suckup"+1*trQuestVarGet("sound")+".wav","1",-1,"","");
					bossNext = bossNext + 200;
					trQuestVarSet("posx", trQuestVarGet("bossRoomCenterx") - trQuestVarGet("bossDirx") * 16.0);
					trQuestVarSet("posz", trQuestVarGet("bossRoomCenterz") - trQuestVarGet("bossDirz") * 16.0);
					addGenericProj("cloudDeployStars","pos","bossDir",kbGetProtoUnitID("Lampades"),18,0.01,2.5,0,ENEMY_PLAYER);
					bossDir = rotationMatrix("bossDir",trQuestVarGet("bCos"),trQuestVarGet("bSin"));
					bossCount = bossCount - 1;
				}
			}
		} else if (trQuestVarGet("bossSpell") > 30) {
			if (trQuestVarGet("bossSpell") == 31) {
				trQuestVarSet("bossUsedUltimate", 1);
				trSoundPlayFN("cinematics\15_in\gong.wav","1",-1,"","");
				trSoundPlayFN("godpower.wav","1",-1,"","");
				trSetLighting("night", 1.0);
				trOverlayText("Heavenfall",3.0,-1,-1,-1);
				bossPos = kbGetBlockPosition(""+bossUnit, true);
				trArmyDispatch("0,0","Dwarf",2,trQuestVarGet("bossPosx"),0,trQuestVarGet("bossPosz"),0,true);
				trArmySelect("0,0");
				trUnitChangeProtoUnit("Vision SFX");
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trUnitChangeProtoUnit("Cinematic Block");
				trQuestVarSet("bossSpell", 32);
				trQuestVarSet("bossBarrageCount", 1);
			} else if (trQuestVarGet("bossSpell") == 32) {
				if (trQuestVarGet("bossBarrageCount") >= 4) {
					trQuestVarSet("bossSpell", 36);
					trQuestVarSet("bossDist", 5.0);
					bossNext = trTimeMS() + 3000;
				} else {
					bossCount = 3;
					trQuestVarSet("bossSpell", 33);
					bossNext = trTimeMS() + 1500;
				}
			} else if (trQuestVarGet("bossSpell") == 33) {
				if (trTimeMS() > bossNext) {
					for(p=1; < ENEMY_PLAYER) {
						if (trQuestVarGet("p"+p+"dead") == 0) {
							trVectorSetUnitPos("pos", "p"+p+"unit");
							vectorSnapToGrid("pos");
							dragonMeteor("pos");
						}
					}
					bossCount = bossCount - 1;
					if (bossCount == 0) {
						trQuestVarSet("bossSpell", 34);
						bossNext = trTimeMS() + 2000;
						bossCount = trQuestVarGet("bossBarrageCount");
						trQuestVarSet("bossBarrageCount", 1 + trQuestVarGet("bossBarrageCount"));
					} else {
						bossNext = bossNext + 1000;
					}
				}
			} else if (trQuestVarGet("bossSpell") == 34) {
				if (trTimeMS() > bossNext) {
					trQuestVarSet("bossSpell", 35);
					bossDir = rotationMatrix("bossDir", -0.757323, 0.653041);
					trQuestVarSet("bossPosx", trQuestVarGet("bossRoomCenterx") + trQuestVarGet("bossDirx") * 20.0);
					trQuestVarSet("bossPosz", trQuestVarGet("bossRoomCenterz") + trQuestVarGet("bossDirz") * 20.0);
					for(i=xGetDatabaseCount(dPlayerCharacters); >0) {
						if (xDatabaseNext(dPlayerCharacters,true) == -1 || trUnitAlive() == false) {
							removePlayerCharacter();
						} else {
							trVectorSetUnitPos("bossTarget", dPlayerCharacters);
							break;
						}
					}
					bossDir = zGetUnitVector("bossPos", "bossTarget");
				}
			} else if (trQuestVarGet("bossSpell") == 35) {
				if (trTimeMS() > bossNext) {
					bossNext = bossNext + 200;
					trQuestVarSetFromRand("modx", -3, 3, false);
					trQuestVarSetFromRand("modz", -3, 3, false);
					trQuestVarSet("modx", trQuestVarGet("modx") + trQuestVarGet("bossPosx"));
					trQuestVarSet("modz", trQuestVarGet("modz") + trQuestVarGet("bossPosz"));
					vectorSnapToGrid("mod");
					dragonMeteor("mod");
					trQuestVarSet("bossPosx", trQuestVarGet("bossPosx") + 4.0 * trQuestVarGet("bossDirx"));
					trQuestVarSet("bossPosz", trQuestVarGet("bossPosz") + 4.0 * trQuestVarGet("bossDirz"));
					if (zDistanceBetweenVectorsSquared("bossPos","bossRoomCenter") > 441.0) {
						bossCount = bossCount - 1;
						if (bossCount > 0) {
							bossNext = trTimeMS() + 2000;
							trQuestVarSet("bossSpell", 34);
						} else {
							trQuestVarSet("bossSpell", 32);
						}
					}
				}
			} else if (trQuestVarGet("bossSpell") == 36) {
				if (trTimeMS() > bossNext) {
					bossNext = trTimeMS() + 100;
					trQuestVarSet("posx", trQuestVarGet("bossRoomCenterx") + trQuestVarGet("bossDirx") * trQuestVarGet("bossDist"));
					trQuestVarSet("posz", trQuestVarGet("bossRoomCenterz") + trQuestVarGet("bossDirz") * trQuestVarGet("bossDist"));
					vectorSnapToGrid("pos");
					dragonMeteor("pos");
					trQuestVarSet("bossDist", trQuestVarGet("bossDist") + 1.0);
					if (trQuestVarGet("bossDist") >= 20) {
						trQuestVarSet("bossSpell", 41);
						trQuestVarSet("bossUltimate", 3);
						trSetLighting("default", 1.0);
						trSoundPlayFN("godpowerfailed.wav","1",-1,"","");
						trUnitSelectClear();
						trUnitSelect(""+bossUnit, true);
						trUnitChangeProtoUnit("Nidhogg");
					} else {
						bossDir = rotationMatrix("bossDir", 0.71934, 0.694658);
					}
				}
			}
		} else if (trQuestVarGet("bossSpell") > 20) {
			if (trQuestVarGet("bossSpell") == 21) {
				trQuestVarSet("bossPosx", trQuestVarGet("bossRoomCenterx") - trQuestVarGet("bossDirx") * 24.0 - 1.0);
				trQuestVarSet("bossPosz", trQuestVarGet("bossRoomCenterz") - trQuestVarGet("bossDirz") * 24.0 - 1.0);
				vectorSnapToGrid("bossPos");
				trQuestVarSet("next", trGetNextUnitScenarioNameNumber());
				trArmyDispatch(""+ENEMY_PLAYER+",0","Dwarf",1,trQuestVarGet("bossPosx"),0,trQuestVarGet("bossPosz"),0,true);
				trArmySelect(""+ENEMY_PLAYER+",0");
				trSetUnitOrientation(bossDir,vector(0,1,0),true);
				trUnitChangeProtoUnit("Helepolis");
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trMutateSelected(kbGetProtoUnitID("Dwarf"));
				trImmediateUnitGarrison(""+1*trQuestVarGet("next"));
				trUnitChangeProtoUnit("Nidhogg");
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trUnitSetStance("Passive");
				trUnitSelectClear();
				trUnitSelectByQV("next");
				trUnitChangeProtoUnit("Rocket");
				trQuestVarSet("bossSpell", 22);
				bossNext = trTimeMS() + 5000;
			} else if (trQuestVarGet("bossSpell") == 22) {
				if (trTimeMS() > bossNext) {
					trSoundPlayFN("nidhoggflame2.wav","1",-1,"","");
					bossDir = rotationMatrix("bossDir", 0.34202, 0.939693);
					bossAngle = angleBetweenVectors("zeroVector", "bossDir");
					trQuestVarSet("bossSpell", 23);
					bossNext = trTimeMS();
					bossTimeout = trTimeMS() + 2000;
				}
			} else if (trQuestVarGet("bossSpell") == 23) {
				while (trTimeMS() > bossNext) {
					addGenericProj("bossFireballs","bossPos","bossDir",kbGetProtoUnitID("Fire Giant"),19,10,4.5,0,ENEMY_PLAYER);
					yAddUpdateVar("bossFireballs","prevX",trQuestVarGet("bossPosX"));
					yAddUpdateVar("bossFireballs","prevZ",trQuestVarGet("bossPosZ"));
					yAddUpdateVar("bossFireballs", "rm", 0);
					trSetSelectedScale(0,2,0);
					bossNext = bossNext + 100;
					bossDir = rotationMatrix("bossDir", 0.992546, -0.121869);
					trUnitSelectClear();
					trUnitSelect(""+bossUnit, true);
					trSetUnitOrientation(bossDir,vector(0,1,0),true);
				}
				if (trTimeMS() > bossTimeout) {
					trQuestVarSet("bossSpell", 41);
					trUnitSetStance("Aggressive");
					trUnitMoveToPoint(trQuestVarGet("bossRoomCenterX"),0,trQuestVarGet("bossRoomCenterZ"),-1,true);
				}
			}
		} else if (trQuestVarGet("bossSpell") > 10) {
			if (trQuestVarGet("bossSpell") == 11) {
				trSoundPlayFN("nidhoggflame1.wav","1",-1,"","");
				trMutateSelected(kbGetProtoUnitID("Nidhogg"));
				trUnitSetStance("Passive");
				trUnitOverrideAnimation(2,-1,true,false,-1);
				bossPos = kbGetBlockPosition(""+bossUnit, true);
				for(i=2; > 0) {
					trUnitSelectClear();
					trUnitSelectByQV("bossBreath"+i);
					trUnitTeleport(trQuestVarGet("bossPosx"),trQuestVarGet("bossPosy"),trQuestVarGet("bossPosz"));
				}
				for(x=xGetDatabaseCount(dPlayerCharacters); >0) {
					if (xDatabaseNext(dPlayerCharacters,true) == -1 || trUnitAlive() == false) {
						removePlayerCharacter();
					} else {
						bossTarget = trQuestVarGet(dPlayerCharacters));
						trVectorSetUnitPos("bossTarget", dPlayerCharacters);
						break;
					}
				}
				bossDir = zGetUnitVector("bossPos", "bossTarget");
				trUnitSelectClear();
				trUnitSelect(""+bossUnit, true);
				trSetUnitOrientation(bossDir,vector(0,1,0),true);
				trQuestVarSet("bossSpell", 12);
				bossNext = trTimeMS() + 1500;
			} else if (trQuestVarGet("bossSpell") == 12) {
				if (trTimeMS() > bossNext) {
					trQuestVarSet("bossLast", trTimeMS());
					bossNext = trTimeMS() + 500;
					bossTimeout = trTimeMS() + 8000;
					trSoundPlayFN("sonofosirisbolt.wav","1",-1,"","");
					trVectorQuestVarSet("dir", zGetUnitVector3d("bossPos", "bossTarget", 5.0));
					for(i=2; >0) {
						trUnitSelectClear();
						trUnitSelectByQV("bossBreath"+i);
						trMutateSelected(kbGetProtoUnitID("Meteorite"));
						trUnitOverrideAnimation(6,0,true,false,-1);
						trSetSelectedUpVector(trQuestVarGet("dirx"),trQuestVarGet("diry") - 1.0,trQuestVarGet("dirz"));
					}
					trSetSelectedUpVector(0,-1,0);
					trQuestVarSet("bossSpell", 13);
				}
			} else if (trQuestVarGet("bossSpell") == 13) {
				trUnitSelectClear();
				trUnitSelectByQV("bossTarget");
				if (trUnitAlive() == false) {
					for(i=xGetDatabaseCount(dPlayerCharacters); >0) {
						if (xDatabaseNext(dPlayerCharacters,true) == -1 || trUnitAlive() == false) {
							removePlayerCharacter();
						} else {
							bossTarget = trQuestVarGet(dPlayerCharacters));
							break;
						}
					}
				}
				trVectorSetUnitPos("dest", "bossTarget");
				if (zDistanceBetweenVectorsSquared("dest", "bossTarget") > 0.1) {
					/* move the beam towards the target */
					amt = trTimeMS() - trQuestVarGet("bossLast");
					trQuestVarSet("bossLast", trTimeMS());
					amt = amt * 0.004;
					if (trQuestVarGet("secondPhase") == 1) {
						amt = amt * 1.5;
					}
					trVectorQuestVarSet("dir", zGetUnitVector("bossTarget", "dest", amt));
					trQuestVarSet("bossTargetx", trQuestVarGet("bossTargetx") + trQuestVarGet("dirx"));
					trQuestVarSet("bossTargetz", trQuestVarGet("bossTargetz") + trQuestVarGet("dirz"));
					if (zDistanceBetweenVectorsSquared("bossPos","bossTarget") > 1.0) {
						trUnitSelectClear();
						trUnitSelect(""+bossUnit, true);
						trSetUnitOrientation(zGetUnitVector("bossPos","bossTarget"),vector(0,1,0),true);
						trVectorQuestVarSet("dir", zGetUnitVector3d("bossPos", "bossTarget", 5.0));
						for(i=2; >0) {
							trUnitSelectClear();
							trUnitSelectByQV("bossBreath"+i);
							trSetSelectedUpVector(trQuestVarGet("dirx"),trQuestVarGet("diry") - 1.0,trQuestVarGet("dirz"));
						}
					}
				} else {
					trQuestVarSet("bossLast", trTimeMS());
				}
				
				if (trTimeMS() > bossNext) {
					for(i=xGetDatabaseCount(dPlayerUnits); >0) {
						if (xDatabaseNext(dPlayerUnits,true) == -1 || trUnitAlive() == false) {
							removePlayerUnit();
						} else if (zDistanceToVectorSquared(dPlayerUnits, "bossTarget") < 9.0) {
							damagePlayerUnit(250);
						}
					}
					
					trQuestVarSetFromRand("sound", 1, 3, true);
					trSoundPlayFN("suckup"+1*trQuestVarGet("sound")+".wav","1",-1,"","");
					
					bossNext = bossNext + 500;
					if (trTimeMS() > bossTimeout) {
						trSoundPlayFN("godpowerfailed.wav","1",-1,"","");
						trUnitSelectClear();
						trUnitSelect(""+bossUnit, true);
						trUnitSetStance("Aggressive");
						
						for(i=2; >0) {
							trUnitSelectClear();
							trUnitSelectByQV("bossBreath"+i);
							trSetSelectedUpVector(0,1,0);
							trMutateSelected(kbGetProtoUnitID("Rocket"));
							trUnitOverrideAnimation(2,0,true,false,-1);
						}
						trQuestVarSet("bossSpell", 41);
					}
				}
			}
		} else if (trQuestVarGet("bossSpell") > 0) {
			if (trQuestVarGet("bossSpell") == 1) {
				trUnitSetStance("Aggressive");
				xDatabaseNext(dPlayerUnits);
				trVectorSetUnitPos("dest", dPlayerUnits);
				trUnitMoveToPoint(trQuestVarGet("destx"),0,trQuestVarGet("destz"),-1,true);
				trQuestVarSet("bossSpell", 2);
				bossTimeout = trTimeMS() + 10000;
				bossNext = trTimeMS();
				bossDir = vector(1,0,0);
			} else if (trQuestVarGet("bossSpell") == 2) {
				if (trTimeMS() > bossNext) {
					if (trQuestVarGet("secondPhase") == 1) {
						xsSetContextPlayer(ENEMY_PLAYER);
						if (kbUnitGetActionType(1*trQuestVarGet("bossID")) == 6) {
							id = kbUnitGetTargetUnitID(1*trQuestVarGet("bossID"));
							bossPos = kbGetBlockPosition(""+bossUnit, true);
							trVectorQuestVarSet("pos",kbGetBlockPosition(""+trGetUnitScenarioNameNumber(id)));
							bossDir = zGetUnitVector("bossPos","pos");
						}
						bossNext = trTimeMS() + 300;
					} else {
						bossDir = rotationMatrix("bossDir", -0.757323, 0.653041);
						bossNext = trTimeMS() + 500;
					}
					bossPos = kbGetBlockPosition(""+bossUnit, true);
					trQuestVarSetFromRand("rand", 4.0, 10.0, false);
					addGenericProj("fallingFireballs","bossPos","bossDir",
						kbGetProtoUnitID("Fire Giant"),19,trQuestVarGet("rand"),0,0,ENEMY_PLAYER);
					if (trTimeMS() > bossTimeout) {
						trQuestVarSet("bossSpell", 41);
					}
				}
			}
		} else if ((trQuestVarGet("bossUsedUltimate") == 0) && trUnitPercentDamaged() >= 70) {
			trQuestVarSet("bossSpell", 31);
		} else {
			trQuestVarSetFromRand("bossSpell", 0, xsMin(3, trUnitPercentDamaged() * 0.05), true);
			trQuestVarSet("bossSpell", trQuestVarGet("bossSpell") * 10 + 1);
			if (trQuestVarGet("bossSpell") == 31 && trQuestVarGet("bossUltimate") > 0) {
				trQuestVarSetFromRand("bossSpell", 0, 2, true);
				trQuestVarSet("bossSpell", 1 + 10 * trQuestVarGet("bossSpell"));
			}
			trQuestVarSet("bossUltimate", trQuestVarGet("bossUltimate") - 1);
		}
		
	} else {
		trUnitOverrideAnimation(-1,0,false,true,-1);
		xsDisableSelf();
		trMusicStop();
		boss = 0;
		trSetLighting("default", 1.0);
		trSoundPlayFN("win.wav","1",-1,"","");
		for(x=xGetDatabaseCount(dEnemies); >0) {
			xDatabaseNext(dEnemies, true);
			trDamageUnitPercent(100);
		}
		uiLookAtUnitByName(""+bossUnit);
		xsEnableRule("boss_ded");
		xsDisableRule("gameplay_always");
	}
}

/**/
rule boss_ded
inactive
highFrequency
{
	if (trTime() > trQuestVarGet("gameOverNext")) {
		int relic = 0;
		trQuestVarSet("gameOverStep", 1 + trQuestVarGet("gameOverStep"));
		switch(1*trQuestVarGet("gameOverStep"))
		{
			case 1:
			{
				trQuestVarSet("playersWon", 1);
				trLetterBox(true);
				trUIFadeToColor(0,0,0, 2000,0,true);
				trQuestVarSet("gameOverNext", trTime() + 5);
				trSoundPlayFN("default","1",-1,
					"Zenophobia: Boss defeated! Here are the rewards!","icons\infantry g hoplite icon 64");
			}
			case 2:
			{
				trQuestVarSet("gameOverNext", trTime() + 3);
				int gem = trQuestVarGet("bossGem");
				trShowImageDialog(gemstoneIcon(gem), gemstoneName(gem) + " x" + 1*trQuestVarGet("bossGemCount"));
				trQuestVarSet("gemstone"+gem, trQuestVarGet("bossGemCount") + trQuestVarGet("gemstone"+gem));
				trSoundPlayFN("favordump.wav","1",-1,"","");
			}
			case 3:
			{
				trQuestVarSet("gameOverNext", trTime() + 3);
				relic = randomStageClosest();
				trShowImageDialog(relicIcon(relic), "Relic: " + relicName(relic));
				trQuestVarSet("normalRelicCount", trQuestVarGet("normalRelicCount") - 1);
				if (trQuestVarGet("normalRelicCount") > 0) {
					trQuestVarSet("gameOverStep", 2);
				}
				trQuestVarSet("ownedRelics"+relic, 1 + trQuestVarGet("ownedRelics"+relic));
				trSoundPlayFN("favordump.wav","1",-1,"","");
			}
			case 4:
			{
				trQuestVarSet("gameOverNext", trTime() + 3);
				relic = randomStageClosest() + 10;
				trShowImageDialog(relicIcon(relic), "Relic: " + relicName(relic));
				trQuestVarSet("bossRelicCount", trQuestVarGet("bossRelicCount") - 1);
				if (trQuestVarGet("bossRelicCount") > 0) {
					trQuestVarSet("gameOverStep", 3);
				}
				trQuestVarSet("ownedRelics"+relic, 1 + trQuestVarGet("ownedRelics"+relic));
				trSoundPlayFN("favordump.wav","1",-1,"","");
			}
			case 5:
			{
				if (trQuestVarGet("stage") < 10) {
					int p = trCurrentPlayer();
					if (trQuestVarGet("stage") == trQuestVarGet("p"+p+"progress")+1) {
						trQuestVarSet("p"+p+"progress", trQuestVarGet("p"+p+"progress")+1);
					}
					int stage = 1 + trQuestVarGet("stage");
					trShowImageDialog(stageIcon(stage), "Unlocked stage " + stage + ": " + stageName(stage) + "!");
					trSoundPlayFN("favordump.wav","1",-1,"","");
					trQuestVarSet("gameOverNext", trTime() + 5);
				}
			}
			case 6:
			{
				gadgetUnreal("ShowImageBox");
				trQuestVarSet("gameOverNext", trTime() + 8);
				trSoundPlayFN("default.wav","1",-1,
					"Zenophobia: Rewards have been sent to your warehouse. You can access them by playing this map in singleplayer.",
					"icons\infantry g hoplite icon 64");
				trQuestVarSet("gameOverStep", 1);
				if (trQuestVarGet("newPlayers") == 0) {
					trQuestVarSet("gameOverStep", 4);
				}
				xsDisableSelf();
				xsEnableRule("game_over");
				trQuestVarSet("bossKills", 1 + trQuestVarGet("bossKills"));
			}
		}
		gadgetUnreal("ShowImageBox-CloseButton");
	}
}
